
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Fakhri Robi Aulia">
      
      
        <link rel="canonical" href="https://fakhrirobi.github.io/003-making%20your%20customer%20stay/targeting_problem/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Targeting problem - Rovo's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Geologica:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Geologica";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../docs/stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#giving-offer-to-right-user" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Rovo&#39;s Blog" class="md-header__button md-logo" aria-label="Rovo's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rovo's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Targeting problem
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/fakhrirobi/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Rovo&#39;s Blog" class="md-nav__button md-logo" aria-label="Rovo's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Rovo's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fakhrirobi/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/fakhrirobi/edit/master/docs/003-making your customer stay/targeting_problem.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/fakhrirobi/raw/master/docs/003-making your customer stay/targeting_problem.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<p><img alt="Website" src="../assets/targeting_image.jpg" />
Photo by <a href="https://unsplash.com/@enginakyurt?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash">engin akyurt</a> on <a href="https://unsplash.com/photos/red-and-yellow-hand-tool-bPiuY2ZSlvU?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash">Unsplash</a></p>
<h1 id="giving-offer-to-right-user"><strong>Giving Offer to Right User</strong><a class="headerlink" href="#giving-offer-to-right-user" title="Permanent link">&para;</a></h1>
<h2 id="business-context">Business Context<a class="headerlink" href="#business-context" title="Permanent link">&para;</a></h2>
<p>In a ride-hailing company , keeping both customer and driver active is crucial important, because both form equilibrium. </p>
<ol>
<li>Lack of Driver Availability lead to scarcity and ride service cannot be provided, also can lead to extreme price, due to dynamic pricing mechanism </li>
<li>Lack of Customer of course hurt a lot, driver, company, etc. </li>
</ol>
<p>To balance those several ways can be approached, for example by giving a promo or coupon </p>
<h3 id="business-metrics">Business Metrics<a class="headerlink" href="#business-metrics" title="Permanent link">&para;</a></h3>
<p>What is the suitable metrics for this? To help answer the question, we should answer  : </p>
<ol>
<li>What is the goal of promo ? One of the sign that user is active can be derive from <strong>Gross Booking</strong> </li>
</ol>
<p>Here is the relation with <strong>Revenue</strong> </p>
<p>$$</p>
<p>\begin{align}
\text{Revenue from Service} &amp;= \text{Average Revenue Per User}  \cdot  \text{Number of Active User} \
\text{Revenue from Service} &amp;= \text{Average Gross Booking Per User } \cdot \text{Take Rate} \cdot  (1-P(\text{Churn Rate})) \cdot 
\text{Total User} \</p>
<p>\text{Revenue from Service} &amp;= \cfrac{\text{ Gross Booking  }}{\text{Number of User }} \cdot \text{Take Rate} \cdot  (1-P(\text{Churn Rate})) \cdot\text{Total User} \ 
\text{Revenue from Service} &amp;= \cfrac{\text{ Gross Booking  }}{((1-P(\text{Churn Rate})) \cdot\text{Total User})} \cdot \text{Take Rate} \cdot  (1-P(\text{Churn Rate})) \cdot\text{Total User} \ 
\end{align}</p>
<p>$$</p>
<ul>
<li><strong>Take Rate</strong> : Similar to Net Profit Margin </li>
</ul>
<h3 id="business-process">Business Process<a class="headerlink" href="#business-process" title="Permanent link">&para;</a></h3>
<p>To better understand the problem, we should understand the business process first 
<img alt="img" src="../assets/business_process.png" /></p>
<h3 id="problems">Problems<a class="headerlink" href="#problems" title="Permanent link">&para;</a></h3>
<p>The problem is we have limited budget constraint, let say called it <strong>B</strong> we cannot surpass. How can we maximize the benefit from giving promo and still within the constraint</p>
<p>$$
<script type="math/tex; mode=display">\begin{align*}
\text{max}  \textbf{GB} \\
\text w.r.t : \\
\text{Cost} \leq \textbf{B}
\end{align*}</script>
</p>
<p>$$</p>
<p>$$
<script type="math/tex; mode=display">\begin{align*}
\text{max} \sum_i w_i(IGB_i) \\
\text w.r.t : \\
\sum_i w_i(cost_i) \leq \textbf{B}
\end{align*}</script>
</p>
<p>$$</p>
<ol>
<li><strong>GB</strong> :  Gross Booking </li>
<li><strong>w_i</strong> : Binary <strong>0/1</strong> indicating whether user i receive promo or not</li>
<li><strong>IGB_i</strong> : Incremental Gross Booking from promo </li>
<li><strong>cost_i</strong> : Cost of Promo (Homogen) from user i</li>
</ol>
<p>So, how do we approach this problem ? </p>
<h2 id="candidate-solutions">Candidate Solutions<a class="headerlink" href="#candidate-solutions" title="Permanent link">&para;</a></h2>
<p>There are several ways to approach a problem , we can do some literature review, on how industry approach this </p>
<h3 id="solution-1-using-machine-learning">Solution 1 : Using Machine Learning<a class="headerlink" href="#solution-1-using-machine-learning" title="Permanent link">&para;</a></h3>
<p>The first approach we can predict the outcome variable given treatment assign or not using any machine learning model. </p>
<p>Data Looks : </p>
<table>
<thead>
<tr>
<th>userID</th>
<th>X_1</th>
<th>..</th>
<th>X_n</th>
<th>Treatment</th>
<th>Outcome (GB)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Pros : </p>
<p>Easy to do just like machine learning case with regression or classification</p>
<p>Cons : </p>
<p>We cannot adding incrementality / the effect of treatment, hence it's biased to user which Outcome is the highest (for example user who are member )</p>
<h3 id="solution-2-enter-causality">Solution 2 : Enter Causality<a class="headerlink" href="#solution-2-enter-causality" title="Permanent link">&para;</a></h3>
<p>Instead of just using machine learning to predict outcome variable, we can leverage causality to measure the incrementality of each user if user receive treatment (promo)</p>
<p>Pros : </p>
<p>Account for causality / incrementality factor</p>
<p>Cons : </p>
<p>Each user only can be observed one potential outcome, receiving treatment or not. Don't worry we still can estimate the counterfactual. </p>
<h3 id="choosen-solution">Choosen Solution :<a class="headerlink" href="#choosen-solution" title="Permanent link">&para;</a></h3>
<p>Considering our need to measure incrementality we choose the <strong>Solution 2</strong>. </p>
<p>Step by Step Solution : </p>
<p><strong>1. Running Experiment</strong></p>
<p>First we need to design experiment by giving randomly coupon to user assign  , however we should be aware that people who offered coupon can either accept or do not accept their coupon </p>
<p><pre class="mermaid"><code>
graph LR
    A(Coupon Assignment) --&gt;B(Coupon Claims)
    B --&gt; C(Gross Booking)
    D(Number of Bookings) --&gt; B
    E(Income) --&gt; D
    F(Membership) --&gt; B
    E --&gt; F
    F --&gt; C 
    D --&gt; C


</code></pre>
The variable we can observe : 
1. Number of Bookings 
2. Membership 
3. Coupon Assignment </p>
<p><strong>Planning Experiment</strong></p>
<p>The truth is this is that the assignment is random and the Coupon Claims is not random hence, this is suitable for <strong>Causal Inference for Observational Data</strong></p>
<ul>
<li>Experiment Duration : 1 Week only </li>
<li>Randomization Unit : User Level </li>
<li>Chance of getting Treatment : 30% </li>
<li>Which User is candidate : User who still active in past week </li>
<li>Coupon Budget : $1 </li>
<li>Number of Users Active in Past Week : 2000</li>
<li>Hence, the cost of experiment : 2000 x $ 1 = $2000</li>
</ul>
<p><strong>2. Estimating Treatment Effect</strong> </p>
<p>After we have obtained the experiment data we can train model to estimate the treatment effect </p>
<p><strong>3. Choosing Whose to be Treated</strong> </p>
<p>After we have estimated the treatment effect on individual level, we can observe that treating all user is not good way, hence we need to choose what fraction of user to be treated</p>
<h2 id="introduction-to-causal-inference">Introduction to Causal Inference<a class="headerlink" href="#introduction-to-causal-inference" title="Permanent link">&para;</a></h2>
<p>Sometimes we are interested in question such as "Does Implementing Minimum 9 Years Education impact GDP" and so on. That is study of Causal Inference </p>
<p>The Gold Standard of Measuring Causality is by Randomized Control Trial / Experiment, however sometimes treatment assignment imposible to be random or it's unethical. </p>
<p>There is another method , called Causal Inference with Observational Data. </p>
<p>Before diving more, we often heard , <strong>Correlation Does not Imply Causation</strong></p>
<p>But How do we can claim causality, here is several condition  to fullfil causality</p>
<ol>
<li><strong>Temporal Sequencing</strong> </li>
</ol>
<p>If we have treatment (T) and Outcome Variable (Y). It means we do some treatment first then we observe the outcome variable. For example we want to measure the effect of rising price of commodity we want to measure the Demand. </p>
<pre class="mermaid"><code>
   graph LR
      A(Commodity Price) --&gt;B(Demand)



</code></pre>
<ol>
<li><strong>Non Spurious Relationship</strong></li>
</ol>
<p>One meme about this </p>
<p><img alt="correlation vs causation" src="https://media.licdn.com/dms/image/D5610AQHfpRbnF3Z3pQ/image-shrink_1280/0/1692885901844?e=2147483647&amp;v=beta&amp;t=61jOfJV9yxxI95DZalznAVwYNgzLV-IldEgCbLyoIWw" /></p>
<ol>
<li><strong>Removing alternate Causes (Confounding)</strong></li>
</ol>
<p>Previously we want to measure the effect of rising price of commodity on demand, however there are many factors affecting demand,such as seasonality </p>
<pre class="mermaid"><code>
   graph LR
      A(Commodity Price) --&gt;B(Demand)
      C(Seasonality Confounding) --&gt; B</code></pre>
<p>How to remove this bias ? </p>
<ol>
<li>We could use randomization / random experiment such as <strong>A/B Test</strong> </li>
<li>Controlling the Confounder for example by adding the confounding variable to model </li>
</ol>
<p><strong>Potential Outcome</strong></p>
<p>The one who developed causality theory is Donald B Rubin, or called as <strong>Rubin Causality</strong> framework of <strong>potential outcome</strong> framework. </p>
<p>So what is potential outcome, let say we have  a headache, how can we cure the headache, for example : we can take medicine. </p>
<p>The outcome or result after taking medicine </p>
<pre class="mermaid"><code>
   graph LR
      A[Headache] --&gt;B[Take Pills]
      B --&gt; C[Headache Gone]
      B --&gt; D[Still Headache]

      A --&gt; E[Doesnot Take Pills]
      E --&gt; F[Headache Gone]
      E --&gt; G[Still Headache]



</code></pre>
<p>Taking Pills or Not Taking Pills is a form of treatment say we denote as <strong>T</strong> , each person only can take one treatment at a time (take pills or not ) and only observe one outcome say we denote <strong>Y</strong> (still headache or not)</p>
<p>those outcome, called potential outcome. </p>
<p>Hence if we want to denote the outcome of each person, say <span class="arithmatex">\(i\)</span> after taking pills is <span class="arithmatex">\(Y_{1i}\)</span> </p>
<p>The Treatment effect on individuals can be define as </p>
<p><span class="arithmatex">\(\text{Individual Treatment Effect}_i = Y_{1i} - Y_{0i}\)</span></p>
<p>However, again we can observe both at the same time then usually we come up with <strong>Average Treatment Effect</strong> </p>
<p>which can be define as </p>
<p><span class="arithmatex">\(\text{Average Treatment Effect} = \text{Average Outcome on Treated individual} - \text{Average Outcome on Not Treated individual}\)</span></p>
<p>or </p>
<p><span class="arithmatex">\(\text{Average Treatment Effect} = E[Y_1 - Y_0 ]\)</span></p>
<p>with <span class="arithmatex">\(E\)</span> as expected value or simply average </p>
<p><strong>Individual Treatment Effect</strong> </p>
<p>You said that estimating treatment effect is quite impossible, how could you over with this? Don't worry we'll talk about industry implementation</p>
<p>So why would you use individual treatment effects instead of Average Treatment Effect. </p>
<p>Typical use of <strong>Average Treatment Effect</strong> : 
- Program Evaluation 
- Research 
- Decision </p>
<p>The reason about using Individual Treatment Effect is <strong>Personalization</strong> , why ? </p>
<p>Individuals may react differently in different degree , for example in ride hailing case : </p>
<ul>
<li>We give discount offer to individual A &rarr; one week after the discount the user keep using  / ordering to ride hailing apps </li>
<li>But that could be different in user Z &rarr; offered discount but not reacting at all </li>
</ul>
<p>Again what's the company interest ? Gaining Maximum Shareholder value , How ? 
- Could from rising the revenue 
- Or from reducing the cost </p>
<p>In case we choose the revenue, how could we give treatment such as offer so that we could maximize the revenue given budget constraint : </p>
<ul>
<li>We select individual if we treat &rarr; gain highest treatment effect / incremental value </li>
</ul>
<p><span class="arithmatex">\(\text{Individual Treatment Effect}_i = Y_{1i} - Y_{0i}\)</span></p>
<p>We only have one outcome at a time, hence we need to estimate the other one using model </p>
<p>Let's dive in </p>
<p>Modelling Workflow </p>
<pre class="mermaid"><code>
   graph LR
      A[Data Preparation] --&gt;B[Exploratory Data Analysis]
      B --&gt; C[Data Preprocessing]
      C --&gt; D[Modelling Phase]
      D --&gt; E[Finding Best Model]



</code></pre>
<h3 id="data-preparation">Data Preparation<a class="headerlink" href="#data-preparation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span> 

<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="c1"># Suppress all warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Here is the dataset definition</p>
<table>
<thead>
<tr>
<th>Variable Name</th>
<th>Definition</th>
<th>Data Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>PromoID</td>
<td>ID of Promos</td>
<td>INT</td>
</tr>
<tr>
<td>PromoType</td>
<td>Type of Promos Offered  to Treatment Effect</td>
<td>String</td>
</tr>
<tr>
<td>PromoDate</td>
<td>Date of Promos Given to Treated User</td>
<td>String</td>
</tr>
<tr>
<td>UserID</td>
<td>UserID</td>
<td>String</td>
</tr>
<tr>
<td>Treatment</td>
<td>Binary Value (0/1) indicating user receive treatment or not</td>
<td>String</td>
</tr>
<tr>
<td>GrossBooking</td>
<td>Outcome Variable , Gross Booking in 7 Days</td>
<td>String</td>
</tr>
<tr>
<td>Age</td>
<td>Customer Age</td>
<td>String</td>
</tr>
<tr>
<td>Gender</td>
<td>Customer Gender</td>
<td>String</td>
</tr>
<tr>
<td>NumberOfBooking</td>
<td>Count of user Booking in Last 7 Days</td>
<td>String</td>
</tr>
<tr>
<td>ResponseToPastPromo</td>
<td>Binary Value (0/1) indicating whether user responded / claim last offered promo</td>
<td>String</td>
</tr>
<tr>
<td>LastBooking(Days)</td>
<td>Number of Days  from last booking, given experiment date cutoff</td>
<td>String</td>
</tr>
<tr>
<td>isMember</td>
<td>Binary Value (0/1) indicating whether user is a member</td>
<td>String</td>
</tr>
<tr>
<td>average_apps_open_week</td>
<td>Number of user app open in 7 days</td>
<td>String</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;dataset/promo_continous_outcome.csv&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">data</span>
</code></pre></div>
<div style="overflow-x: auto;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PromoID</th>
      <th>PromoType</th>
      <th>PromoDate</th>
      <th>UserID</th>
      <th>Treatment</th>
      <th>GrossBooking</th>
      <th>Age</th>
      <th>Gender</th>
      <th>NumberOfBooking</th>
      <th>ResponseToPastPromo</th>
      <th>LastBooking(Days)</th>
      <th>isMember</th>
      <th>average_apps_open_week</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
      <td>0</td>
      <td>98.346167</td>
      <td>56</td>
      <td>male</td>
      <td>16</td>
      <td>1</td>
      <td>148</td>
      <td>0</td>
      <td>30.940793</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
      <td>0</td>
      <td>99.150442</td>
      <td>69</td>
      <td>male</td>
      <td>49</td>
      <td>1</td>
      <td>339</td>
      <td>0</td>
      <td>32.466263</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3</td>
      <td>0</td>
      <td>93.619220</td>
      <td>46</td>
      <td>male</td>
      <td>39</td>
      <td>0</td>
      <td>115</td>
      <td>0</td>
      <td>30.170032</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4</td>
      <td>0</td>
      <td>87.382590</td>
      <td>32</td>
      <td>female</td>
      <td>44</td>
      <td>0</td>
      <td>213</td>
      <td>0</td>
      <td>31.393513</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5</td>
      <td>0</td>
      <td>100.478985</td>
      <td>60</td>
      <td>male</td>
      <td>31</td>
      <td>1</td>
      <td>293</td>
      <td>0</td>
      <td>30.839952</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2995</th>
      <td>3</td>
      <td>NaN</td>
      <td>2024-01-07</td>
      <td>996</td>
      <td>1</td>
      <td>107.387370</td>
      <td>60</td>
      <td>female</td>
      <td>17</td>
      <td>0</td>
      <td>87</td>
      <td>0</td>
      <td>30.010098</td>
    </tr>
    <tr>
      <th>2996</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>997</td>
      <td>0</td>
      <td>97.674515</td>
      <td>64</td>
      <td>male</td>
      <td>36</td>
      <td>0</td>
      <td>302</td>
      <td>0</td>
      <td>30.216715</td>
    </tr>
    <tr>
      <th>2997</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>998</td>
      <td>0</td>
      <td>90.007692</td>
      <td>62</td>
      <td>female</td>
      <td>44</td>
      <td>1</td>
      <td>167</td>
      <td>0</td>
      <td>30.675957</td>
    </tr>
    <tr>
      <th>2998</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>999</td>
      <td>0</td>
      <td>108.604006</td>
      <td>35</td>
      <td>male</td>
      <td>31</td>
      <td>0</td>
      <td>169</td>
      <td>0</td>
      <td>33.005855</td>
    </tr>
    <tr>
      <th>2999</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1000</td>
      <td>0</td>
      <td>94.680165</td>
      <td>55</td>
      <td>male</td>
      <td>35</td>
      <td>0</td>
      <td>134</td>
      <td>0</td>
      <td>30.483874</td>
    </tr>
  </tbody>
</table>
<p>3000 rows × 13 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="n">input_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;NumberOfBooking&#39;</span><span class="p">,</span><span class="s1">&#39;ResponseToPastPromo&#39;</span><span class="p">,</span><span class="s1">&#39;LastBooking(Days)&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;isMember&#39;</span><span class="p">,</span><span class="s1">&#39;average_apps_open_week&#39;</span><span class="p">]</span>
<span class="n">treatment_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span>
<span class="n">output_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">input_col</span> <span class="o">+</span> <span class="n">treatment_col</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">output_col</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Age</th>
      <th>Gender</th>
      <th>NumberOfBooking</th>
      <th>ResponseToPastPromo</th>
      <th>LastBooking(Days)</th>
      <th>isMember</th>
      <th>average_apps_open_week</th>
      <th>Treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>56</td>
      <td>male</td>
      <td>16</td>
      <td>1</td>
      <td>148</td>
      <td>0</td>
      <td>30.940793</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>69</td>
      <td>male</td>
      <td>49</td>
      <td>1</td>
      <td>339</td>
      <td>0</td>
      <td>32.466263</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>46</td>
      <td>male</td>
      <td>39</td>
      <td>0</td>
      <td>115</td>
      <td>0</td>
      <td>30.170032</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>32</td>
      <td>female</td>
      <td>44</td>
      <td>0</td>
      <td>213</td>
      <td>0</td>
      <td>31.393513</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>60</td>
      <td>male</td>
      <td>31</td>
      <td>1</td>
      <td>293</td>
      <td>0</td>
      <td>30.839952</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="n">y</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GrossBooking</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>98.346167</td>
    </tr>
    <tr>
      <th>1</th>
      <td>99.150442</td>
    </tr>
    <tr>
      <th>2</th>
      <td>93.619220</td>
    </tr>
    <tr>
      <th>3</th>
      <td>87.382590</td>
    </tr>
    <tr>
      <th>4</th>
      <td>100.478985</td>
    </tr>
  </tbody>
</table>
</div>

<p>Split data into training and testing </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>


<span class="n">X_train</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_train</span><span class="p">,</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">X_val</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_val</span><span class="p">,</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">,</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X_train</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Age</th>
      <th>Gender</th>
      <th>NumberOfBooking</th>
      <th>ResponseToPastPromo</th>
      <th>LastBooking(Days)</th>
      <th>isMember</th>
      <th>average_apps_open_week</th>
      <th>Treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>970</th>
      <td>53</td>
      <td>male</td>
      <td>26</td>
      <td>0</td>
      <td>45</td>
      <td>0</td>
      <td>30.041950</td>
      <td>0</td>
    </tr>
    <tr>
      <th>159</th>
      <td>66</td>
      <td>male</td>
      <td>23</td>
      <td>1</td>
      <td>258</td>
      <td>0</td>
      <td>31.328888</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2513</th>
      <td>31</td>
      <td>female</td>
      <td>4</td>
      <td>1</td>
      <td>103</td>
      <td>0</td>
      <td>30.189209</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1604</th>
      <td>54</td>
      <td>male</td>
      <td>43</td>
      <td>0</td>
      <td>170</td>
      <td>0</td>
      <td>30.413598</td>
      <td>0</td>
    </tr>
    <tr>
      <th>436</th>
      <td>33</td>
      <td>female</td>
      <td>1</td>
      <td>1</td>
      <td>224</td>
      <td>1</td>
      <td>30.281640</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>826</th>
      <td>23</td>
      <td>female</td>
      <td>15</td>
      <td>0</td>
      <td>178</td>
      <td>0</td>
      <td>30.325069</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2839</th>
      <td>36</td>
      <td>male</td>
      <td>1</td>
      <td>1</td>
      <td>338</td>
      <td>1</td>
      <td>30.525431</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1112</th>
      <td>34</td>
      <td>male</td>
      <td>31</td>
      <td>1</td>
      <td>25</td>
      <td>1</td>
      <td>30.312170</td>
      <td>0</td>
    </tr>
    <tr>
      <th>130</th>
      <td>41</td>
      <td>male</td>
      <td>31</td>
      <td>0</td>
      <td>162</td>
      <td>0</td>
      <td>30.799777</td>
      <td>0</td>
    </tr>
    <tr>
      <th>744</th>
      <td>54</td>
      <td>male</td>
      <td>45</td>
      <td>0</td>
      <td>16</td>
      <td>0</td>
      <td>30.807659</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>2400 rows × 8 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="n">y_train</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GrossBooking</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>970</th>
      <td>101.384184</td>
    </tr>
    <tr>
      <th>159</th>
      <td>103.983185</td>
    </tr>
    <tr>
      <th>2513</th>
      <td>96.753668</td>
    </tr>
    <tr>
      <th>1604</th>
      <td>97.215699</td>
    </tr>
    <tr>
      <th>436</th>
      <td>103.875343</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>826</th>
      <td>90.591134</td>
    </tr>
    <tr>
      <th>2839</th>
      <td>101.575794</td>
    </tr>
    <tr>
      <th>1112</th>
      <td>101.633420</td>
    </tr>
    <tr>
      <th>130</th>
      <td>107.497184</td>
    </tr>
    <tr>
      <th>744</th>
      <td>102.238127</td>
    </tr>
  </tbody>
</table>
<p>2400 rows × 1 columns</p>
</div>

<p>Data Preprocessing</p>
<ul>
<li>Encoding Categorical Variable</li>
<li>Creating Feature : Interaction between Treatment and other covariates</li>
</ul>
<p>Encoding Categorical Variable</p>
<div class="highlight"><pre><span></span><code><span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Gender&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">categorical_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<style>#sk-container-id-1 {color: black;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>OneHotEncoder(sparse_output=False)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">OneHotEncoder</label><div class="sk-toggleable__content"><pre>OneHotEncoder(sparse_output=False)</pre></div></div></div></div></div>

<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">encode_categorical</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">encoder</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">train</span> <span class="p">:</span> 
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">categorical_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">categories_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">encoded_values</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">categorical_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">encoded_df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">encoded_values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>


        <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">categorical_columns</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">X_encoded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">encoded_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X_encoded</span><span class="p">,</span><span class="n">encoder</span>
    <span class="k">else</span> <span class="p">:</span> 
        <span class="k">if</span> <span class="n">encoder</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;you should add fitted encoder for other than training data&#39;</span><span class="p">)</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">categories_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">encoded_values</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">categorical_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">encoded_df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">encoded_values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>

        <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">categorical_columns</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">X_encoded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">,</span><span class="n">encoded_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_encoded</span><span class="p">,</span><span class="n">_</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X_train_encoded</span><span class="p">,</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encode_categorical</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span><span class="n">categorical_columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span>
                                             <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test_encoded</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">encode_categorical</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span><span class="n">categorical_columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span>
                                             <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">)</span>
<span class="n">X_val_encoded</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">encode_categorical</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_val</span><span class="p">,</span><span class="n">categorical_columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span>
                                             <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X_train_encoded</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(2400, 9)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X_test_encoded</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(300, 9)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_interaction</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">input_col</span><span class="p">,</span><span class="n">treatment_col</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">input_col</span> <span class="p">:</span> 
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">treatment_col</span> <span class="p">:</span> 
            <span class="n">X</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">X</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">input_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span><span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;NumberOfBooking&#39;</span><span class="p">,</span><span class="s1">&#39;ResponseToPastPromo&#39;</span><span class="p">,</span><span class="s1">&#39;LastBooking(Days)&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;isMember&#39;</span><span class="p">,</span><span class="s1">&#39;average_apps_open_week&#39;</span><span class="p">]</span>
<span class="n">treatment_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span>
<span class="n">output_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X_train_interaction</span> <span class="o">=</span> <span class="n">generate_interaction</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_train_encoded</span><span class="p">,</span><span class="n">input_col</span><span class="o">=</span><span class="n">input_col</span><span class="p">,</span><span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">)</span>
<span class="n">X_test_interaction</span> <span class="o">=</span> <span class="n">generate_interaction</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_test_encoded</span><span class="p">,</span><span class="n">input_col</span><span class="o">=</span><span class="n">input_col</span><span class="p">,</span><span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">)</span>
<span class="n">X_val_interaction</span> <span class="o">=</span> <span class="n">generate_interaction</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_val_encoded</span><span class="p">,</span><span class="n">input_col</span><span class="o">=</span><span class="n">input_col</span><span class="p">,</span><span class="n">treatment_col</span><span class="o">=</span><span class="n">treatment_col</span><span class="p">)</span>
</code></pre></div>
<p>dropping column of non interaction column</p>
<div class="highlight"><pre><span></span><code><span class="n">X_train_interaction</span> <span class="o">=</span> <span class="n">X_train_interaction</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">input_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_test_interaction</span> <span class="o">=</span> <span class="n">X_test_interaction</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">input_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_val_interaction</span> <span class="o">=</span> <span class="n">X_val_interaction</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">input_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X_train_interaction</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(2400, 9)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">X_test_interaction</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(300, 9)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">data_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train_encoded</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">y_train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_test_encoded</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">y_test</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data_val</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_val_encoded</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">y_val</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p>hence 
1. <span class="arithmatex">\(X\)</span> or Covariate : <code>'GrossBookingValue', 'Age', 'Gender', 'NumberOfBooking','ResponseToPastPromo','LastBooking(Days)', 
            'isMember','average_apps_open_week'</code>
2. <span class="arithmatex">\(T\)</span> or Treatment Variable  : <code>Treatment</code>
3. <span class="arithmatex">\(Y\)</span> or Outcome Variable : <code>GrossBookingValue</code></p>
<h3 id="modelling-phase">Modelling Phase<a class="headerlink" href="#modelling-phase" title="Permanent link">&para;</a></h3>
<h3 id="1st-linear-regression"><span class="arithmatex">\(1^{st}\)</span> Linear Regression<a class="headerlink" href="#1st-linear-regression" title="Permanent link">&para;</a></h3>
<p>$$
\begin{align}
Y = \sum^{K-1}<em i="i">{i=1} \beta</em> \cdot X_i + \beta_K \cdot T \</p>
<p>\dfrac{\partial Y}{\partial T} = \beta_K \ </p>
<p>\beta_K = \textbf{ATE}</p>
<p>\end{align}</p>
<p>$$</p>
<p>It produces the <strong>ATE</strong> however what we need is is persnalized effect, hence we can add <strong>interaction term</strong> with covariate
$$
\begin{align}
Y = \sum^{K-1}<em i="i">{i=1} \beta</em>} \cdot X_i + \beta_K \cdot T +  \sum^{K-1<em i="i">{i=1} \beta</em> \cdot X_i \cdot T \</p>
<p>\dfrac{\partial Y}{\partial T} = \sum^{K-1}<em i="i">{i=1} \beta</em> \cdot X_i  \ </p>
<p>\sum^{K-1}<em i="i">{i=1} \beta</em>} \cdot X_i = \textbf{CATE</p>
<p>\end{align}</p>
<p>$$</p>
<p>However Linear Regression of course has limitation such as : 
- Linearity Assumption </p>
<p>Can we use any estimator that can produce non linearity ? </p>
<p><strong>Of Course</strong> : We could take a look at another estimator</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">model_cate_lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>

<span class="n">model_cate_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_interaction</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<style>#sk-container-id-2 {color: black;}#sk-container-id-2 pre{padding: 0;}#sk-container-id-2 div.sk-toggleable {background-color: white;}#sk-container-id-2 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-2 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-2 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-2 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-2 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-2 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-2 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-2 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-2 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-2 div.sk-item {position: relative;z-index: 1;}#sk-container-id-2 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-2 div.sk-item::before, #sk-container-id-2 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-2 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-2 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-2 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-2 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-2 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-2 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-2 div.sk-label-container {text-align: center;}#sk-container-id-2 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-2 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>LinearRegression()</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox" checked><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">LinearRegression</label><div class="sk-toggleable__content"><pre>LinearRegression()</pre></div></div></div></div></div>

<div class="highlight"><pre><span></span><code><span class="n">ate_prediction</span> <span class="o">=</span> <span class="n">model_cate_lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">@</span> <span class="n">X_train_interaction</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">model_cate_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_interaction</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[99.80225631],
       [99.80225631],
       [99.80225631],
       ...,
       [99.80225631],
       [99.80225631],
       [99.80225631]])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_cate_lr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">ate_prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">ate_prediction</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">cate</span> <span class="o">=</span> <span class="n">X_train_interaction</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cate</span><span class="p">[</span><span class="s1">&#39;predicted_cate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_lr</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_cate_lr</span><span class="p">,</span><span class="n">X</span><span class="o">=</span><span class="n">X_train_interaction</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">cate</span> <span class="o">=</span> <span class="n">cate</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;predicted_cate&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cate</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Treatment</th>
      <th>Age_Treatment_interaction</th>
      <th>female_Treatment_interaction</th>
      <th>male_Treatment_interaction</th>
      <th>NumberOfBooking_Treatment_interaction</th>
      <th>ResponseToPastPromo_Treatment_interaction</th>
      <th>LastBooking(Days)_Treatment_interaction</th>
      <th>isMember_Treatment_interaction</th>
      <th>average_apps_open_week_Treatment_interaction</th>
      <th>predicted_cate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1822</th>
      <td>1</td>
      <td>46</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>47</td>
      <td>1</td>
      <td>148</td>
      <td>0</td>
      <td>31.044854</td>
      <td>202.942291</td>
    </tr>
    <tr>
      <th>576</th>
      <td>1</td>
      <td>47</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>46</td>
      <td>1</td>
      <td>188</td>
      <td>0</td>
      <td>31.266090</td>
      <td>202.225657</td>
    </tr>
    <tr>
      <th>418</th>
      <td>1</td>
      <td>25</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>40</td>
      <td>1</td>
      <td>194</td>
      <td>1</td>
      <td>31.692579</td>
      <td>200.104725</td>
    </tr>
    <tr>
      <th>513</th>
      <td>1</td>
      <td>25</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>40</td>
      <td>1</td>
      <td>194</td>
      <td>1</td>
      <td>31.692579</td>
      <td>200.104725</td>
    </tr>
    <tr>
      <th>2039</th>
      <td>1</td>
      <td>59</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>43</td>
      <td>1</td>
      <td>59</td>
      <td>0</td>
      <td>31.798532</td>
      <td>200.035397</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>840</th>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>841</th>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>842</th>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2328</th>
      <td>1</td>
      <td>47</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>3</td>
      <td>0</td>
      <td>260</td>
      <td>0</td>
      <td>30.093732</td>
      <td>-0.619641</td>
    </tr>
    <tr>
      <th>2323</th>
      <td>1</td>
      <td>48</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>272</td>
      <td>0</td>
      <td>30.298811</td>
      <td>-4.556660</td>
    </tr>
  </tbody>
</table>
<p>2400 rows × 10 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">cate</span><span class="p">[</span><span class="s1">&#39;predicted_cate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Linear Regression CATE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LinReg CATE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span>
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_62_0.png" /></p>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_62_1.png" /></p>
<h3 id="2nd-meta-learners-models"><span class="arithmatex">\(2^{nd}\)</span> Meta Learners Models<a class="headerlink" href="#2nd-meta-learners-models" title="Permanent link">&para;</a></h3>
<p>Previously, we learn about we can extract the interaction term and use it to extract <strong>CATE</strong>, however the relationship is <strong>linear</strong> , what if we can implement non linear model such as <strong>Tree Based Method</strong> </p>
<h4 id="meta-learners-models-s-learners">Meta Learners Models : <span class="arithmatex">\(S-Learners\)</span><a class="headerlink" href="#meta-learners-models-s-learners" title="Permanent link">&para;</a></h4>
<p>The approach is quite simple </p>
<ol>
<li>
<p>Train <strong>any</strong> machine learning model to all data 
<pre class="mermaid"><code>
   graph LR
      A(Covariate) --&gt;B(Y)
      C(Treatment Variable) --&gt; B



</code></pre></p>
</li>
<li>
<p>During prediction phase : </p>
</li>
<li>Predict <span class="arithmatex">\(Y_1\)</span> by input  Covariate + <code>Treatment=1</code> </li>
<li>Predict <span class="arithmatex">\(Y_0\)</span> Covariate + <code>Treatment=0</code></li>
<li>Measure difference of  <span class="arithmatex">\(Y_1\)</span> and <span class="arithmatex">\(Y_0\)</span>, That is our <strong>CATE</strong></li>
</ol>
<p>Let's use boosting model such as <strong>AdaBoost</strong> </p>
<div class="highlight"><pre><span></span><code><span class="n">X_train_encoded</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Age</th>
      <th>NumberOfBooking</th>
      <th>ResponseToPastPromo</th>
      <th>LastBooking(Days)</th>
      <th>isMember</th>
      <th>average_apps_open_week</th>
      <th>Treatment</th>
      <th>female</th>
      <th>male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>53</td>
      <td>26</td>
      <td>0</td>
      <td>45</td>
      <td>0</td>
      <td>30.041950</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>66</td>
      <td>23</td>
      <td>1</td>
      <td>258</td>
      <td>0</td>
      <td>31.328888</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>31</td>
      <td>4</td>
      <td>1</td>
      <td>103</td>
      <td>0</td>
      <td>30.189209</td>
      <td>0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>54</td>
      <td>43</td>
      <td>0</td>
      <td>170</td>
      <td>0</td>
      <td>30.413598</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>33</td>
      <td>1</td>
      <td>1</td>
      <td>224</td>
      <td>1</td>
      <td>30.281640</td>
      <td>0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2395</th>
      <td>23</td>
      <td>15</td>
      <td>0</td>
      <td>178</td>
      <td>0</td>
      <td>30.325069</td>
      <td>0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2396</th>
      <td>36</td>
      <td>1</td>
      <td>1</td>
      <td>338</td>
      <td>1</td>
      <td>30.525431</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2397</th>
      <td>34</td>
      <td>31</td>
      <td>1</td>
      <td>25</td>
      <td>1</td>
      <td>30.312170</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2398</th>
      <td>41</td>
      <td>31</td>
      <td>0</td>
      <td>162</td>
      <td>0</td>
      <td>30.799777</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2399</th>
      <td>54</td>
      <td>45</td>
      <td>0</td>
      <td>16</td>
      <td>0</td>
      <td>30.807659</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>2400 rows × 9 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdaBoostRegressor</span>

<span class="n">slearner</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">slearner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
             <span class="n">data_train</span><span class="p">[</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">])</span>
</code></pre></div>
<style>#sk-container-id-3 {color: black;}#sk-container-id-3 pre{padding: 0;}#sk-container-id-3 div.sk-toggleable {background-color: white;}#sk-container-id-3 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-3 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-3 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-3 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-3 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-3 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-3 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-3 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-3 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-3 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-3 div.sk-item {position: relative;z-index: 1;}#sk-container-id-3 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-3 div.sk-item::before, #sk-container-id-3 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-3 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-3 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-3 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-3 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-3 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-3 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-3 div.sk-label-container {text-align: center;}#sk-container-id-3 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-3 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>AdaBoostRegressor(n_estimators=500)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox" checked><label for="sk-estimator-id-3" class="sk-toggleable__label sk-toggleable__label-arrow">AdaBoostRegressor</label><div class="sk-toggleable__content"><pre>AdaBoostRegressor(n_estimators=500)</pre></div></div></div></div></div>

<p>Time to estimate the cate </p>
<div class="highlight"><pre><span></span><code><span class="n">y_1_slearner</span> <span class="o">=</span> <span class="n">slearner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Treatment</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">y_0_slearner</span> <span class="o">=</span> <span class="n">slearner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Treatment</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">cate_slearner</span> <span class="o">=</span> <span class="n">y_1_slearner</span> <span class="o">-</span> <span class="n">y_0_slearner</span>
<span class="n">cate_slearner</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([110.78624859, 104.76189742,  66.05373313, ...,  70.98508093,
       110.78624859, 179.04466601])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_cate_slearner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">slearner</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">y_1_slearner</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Treatment</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">y_0_slearner</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Treatment</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">cate_slearner</span> <span class="o">=</span> <span class="n">y_1_slearner</span> <span class="o">-</span> <span class="n">y_0_slearner</span>
    <span class="k">return</span> <span class="n">cate_slearner</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">cate_slearner</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;S learner CATE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;S Learner CATE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span>
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_73_0.png" /></p>
<div class="highlight"><pre><span></span><code>&lt;Figure size 640x480 with 0 Axes&gt;
</code></pre></div>
<h4 id="meta-learners-models-t-learners">Meta Learners Models : <span class="arithmatex">\(T-Learners\)</span><a class="headerlink" href="#meta-learners-models-t-learners" title="Permanent link">&para;</a></h4>
<p>The difference from S Learner is that T Learner 
separately fit model to estimate <span class="arithmatex">\(Y\)</span> for both treatment and non treatment group </p>
<ol>
<li>Train each model to predict <span class="arithmatex">\(Y\)</span> for both treatment and control group</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">tlearner_1</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">tlearner_0</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">X_treatment</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_train</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">output_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">X_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_train</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">output_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">X_treatment</span><span class="p">)</span>
<span class="n">y_treatment</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_treatment</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">output_col</span><span class="p">]</span>
<span class="n">y_control</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_control</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">output_col</span><span class="p">]</span>



<span class="n">tlearner_1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_treatment</span><span class="p">,</span><span class="n">y_treatment</span><span class="p">)</span>
<span class="n">tlearner_0</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_control</span><span class="p">,</span><span class="n">y_control</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Age</th>
      <th>NumberOfBooking</th>
      <th>ResponseToPastPromo</th>
      <th>LastBooking(Days)</th>
      <th>isMember</th>
      <th>average_apps_open_week</th>
      <th>female</th>
      <th>male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>24</th>
      <td>18</td>
      <td>38</td>
      <td>1</td>
      <td>166</td>
      <td>0</td>
      <td>30.742873</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>29</td>
      <td>7</td>
      <td>0</td>
      <td>269</td>
      <td>1</td>
      <td>30.109229</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>33</th>
      <td>21</td>
      <td>33</td>
      <td>1</td>
      <td>277</td>
      <td>0</td>
      <td>31.526687</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>56</th>
      <td>59</td>
      <td>14</td>
      <td>0</td>
      <td>283</td>
      <td>0</td>
      <td>30.395622</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>64</th>
      <td>45</td>
      <td>14</td>
      <td>0</td>
      <td>132</td>
      <td>0</td>
      <td>30.900356</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2328</th>
      <td>47</td>
      <td>3</td>
      <td>0</td>
      <td>260</td>
      <td>0</td>
      <td>30.093732</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2329</th>
      <td>27</td>
      <td>17</td>
      <td>0</td>
      <td>352</td>
      <td>0</td>
      <td>31.272954</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2337</th>
      <td>45</td>
      <td>6</td>
      <td>0</td>
      <td>245</td>
      <td>0</td>
      <td>30.311971</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2349</th>
      <td>48</td>
      <td>3</td>
      <td>0</td>
      <td>98</td>
      <td>0</td>
      <td>33.666700</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2385</th>
      <td>28</td>
      <td>36</td>
      <td>0</td>
      <td>292</td>
      <td>1</td>
      <td>30.105533</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>225 rows × 8 columns</p>
</div>

<style>#sk-container-id-4 {color: black;}#sk-container-id-4 pre{padding: 0;}#sk-container-id-4 div.sk-toggleable {background-color: white;}#sk-container-id-4 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-4 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-4 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-4 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-4 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-4 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-4 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-4 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-4 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-4 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-4 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-4 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-4 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-4 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-4 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-4 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-4 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-4 div.sk-item {position: relative;z-index: 1;}#sk-container-id-4 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-4 div.sk-item::before, #sk-container-id-4 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-4 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-4 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-4 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-4 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-4 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-4 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-4 div.sk-label-container {text-align: center;}#sk-container-id-4 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-4 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-4" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>AdaBoostRegressor(n_estimators=500)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox" checked><label for="sk-estimator-id-4" class="sk-toggleable__label sk-toggleable__label-arrow">AdaBoostRegressor</label><div class="sk-toggleable__content"><pre>AdaBoostRegressor(n_estimators=500)</pre></div></div></div></div></div>

<div class="highlight"><pre><span></span><code><span class="n">X_treatment</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Age</th>
      <th>NumberOfBooking</th>
      <th>ResponseToPastPromo</th>
      <th>LastBooking(Days)</th>
      <th>isMember</th>
      <th>average_apps_open_week</th>
      <th>female</th>
      <th>male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>24</th>
      <td>18</td>
      <td>38</td>
      <td>1</td>
      <td>166</td>
      <td>0</td>
      <td>30.742873</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>29</td>
      <td>7</td>
      <td>0</td>
      <td>269</td>
      <td>1</td>
      <td>30.109229</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>33</th>
      <td>21</td>
      <td>33</td>
      <td>1</td>
      <td>277</td>
      <td>0</td>
      <td>31.526687</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>56</th>
      <td>59</td>
      <td>14</td>
      <td>0</td>
      <td>283</td>
      <td>0</td>
      <td>30.395622</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>64</th>
      <td>45</td>
      <td>14</td>
      <td>0</td>
      <td>132</td>
      <td>0</td>
      <td>30.900356</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2328</th>
      <td>47</td>
      <td>3</td>
      <td>0</td>
      <td>260</td>
      <td>0</td>
      <td>30.093732</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2329</th>
      <td>27</td>
      <td>17</td>
      <td>0</td>
      <td>352</td>
      <td>0</td>
      <td>31.272954</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2337</th>
      <td>45</td>
      <td>6</td>
      <td>0</td>
      <td>245</td>
      <td>0</td>
      <td>30.311971</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2349</th>
      <td>48</td>
      <td>3</td>
      <td>0</td>
      <td>98</td>
      <td>0</td>
      <td>33.666700</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2385</th>
      <td>28</td>
      <td>36</td>
      <td>0</td>
      <td>292</td>
      <td>1</td>
      <td>30.105533</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>225 rows × 8 columns</p>
</div>

<p>Estimate the CATE</p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">tlearner_y1</span> <span class="o">=</span> <span class="n">tlearner_1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_encoded</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">tlearner_y0</span> <span class="o">=</span> <span class="n">tlearner_0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_encoded</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">cate_tlearner</span> <span class="o">=</span> <span class="n">tlearner_y1</span> <span class="o">-</span> <span class="n">tlearner_y0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_cate_tlearner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model1</span><span class="o">=</span><span class="n">tlearner_1</span><span class="p">,</span><span class="n">model0</span><span class="o">=</span><span class="n">tlearner_0</span><span class="p">)</span> <span class="p">:</span> 

    <span class="n">tlearner_y1</span> <span class="o">=</span> <span class="n">model1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span><span class="s1">&#39;Treatment&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">tlearner_y0</span> <span class="o">=</span> <span class="n">model0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span><span class="s1">&#39;Treatment&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">cate_tlearner</span> <span class="o">=</span> <span class="n">tlearner_y1</span> <span class="o">-</span> <span class="n">tlearner_y0</span>
    <span class="k">return</span> <span class="n">cate_tlearner</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">cate_tlearner</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;T learner CATE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;T Learner CATE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span>
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_81_0.png" /></p>
<div class="highlight"><pre><span></span><code>&lt;Figure size 640x480 with 0 Axes&gt;
</code></pre></div>
<h4 id="meta-learners-models-x-learners">Meta Learners Models : <span class="arithmatex">\(X-Learners\)</span><a class="headerlink" href="#meta-learners-models-x-learners" title="Permanent link">&para;</a></h4>
<p>Previously we see progression from s learner to t learner</p>
<ol>
<li>S - T Learner : Separating Model for Estimating Conterfactual depends on group </li>
</ol>
<p>However often the case that treatment assignment is not equal, leading to bad estimation of <strong>CATE</strong>. What should we do next ? </p>
<p>Instead of Treating equally the treatment effect, we can utilize some weighting mechanism to weight CATE from treatment group and CATE from non treated group. That is the idea of <strong>X- learner</strong> </p>
<p>Procedure : 
1. Train separate model to estimate <strong>Y</strong> for both treatment and control group </p>
<p><span class="arithmatex">\(Model 1_{\text{Stage 1}} = E[Y|X,T=1]\)</span></p>
<p><span class="arithmatex">\(Model 0_{\text{Stage 2}} = E[Y|X,T=0]\)</span>
2. For each group </p>
<div class="highlight"><pre><span></span><code>- Estimate CATE from treatment group

  $\tau_1 = Y_{T=1} - \text{Model 0}_{\text{Stage 1}}$
</code></pre></div>
<ul>
<li>
<p>Estimate CATE from control group </p>
<p><span class="arithmatex">\(\tau_0 = \text{Model 1}_{\text{Stage 1}} - Y_{T=0}\)</span> </p>
</li>
<li>
<p>Fit Model to Estimate </p>
<p>$\text{Model 0}_{\text{Stage 2}} = E[\tau_0|X,T=0] $</p>
<p>$\text{Model 1}_{\text{Stage 2}} = E[\tau_1|X,T=1] $</p>
</li>
<li>
<p>Fit Propensity Score Model </p>
<p>$\text{Propensity Model} = E[T=1|X] $</p>
</li>
<li>
<p>During Prediction 
   Given Input <span class="arithmatex">\(X_i\)</span> </p>
</li>
</ul>
<p>$\tau_i = (E[T=1|X_i]) * E[\tau_1|X,T=1] + (1 - (E[T=1|X_i])) * E[\tau_0|X,T=0] $</p>
<p>hence <span class="arithmatex">\(\tau_i\)</span> is <strong>weighted prediction</strong> , ensemble of ensemble, yeay!</p>
<ol>
<li>Train separate model to estimate <strong>Y</strong> for both treatment and control group </li>
</ol>
<p><span class="arithmatex">\(Model 1_{\text{Stage 1}} = E[Y|X,T=1]\)</span></p>
<p><span class="arithmatex">\(Model 0_{\text{Stage 2}} = E[Y|X,T=0]\)</span></p>
<div class="highlight"><pre><span></span><code><span class="n">xlearner_t0_s1</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">xlearner_t1_s1</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>


<span class="n">X_treatment</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_train</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">output_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">X_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_train</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">output_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>


<span class="n">y_treatment</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_treatment</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">output_col</span><span class="p">]</span>
<span class="n">y_control</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_control</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">output_col</span><span class="p">]</span>



<span class="n">xlearner_t1_s1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_treatment</span><span class="p">,</span><span class="n">y_treatment</span><span class="p">)</span>
<span class="n">xlearner_t0_s1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_control</span><span class="p">,</span><span class="n">y_control</span><span class="p">)</span>
</code></pre></div>
<style>#sk-container-id-5 {color: black;}#sk-container-id-5 pre{padding: 0;}#sk-container-id-5 div.sk-toggleable {background-color: white;}#sk-container-id-5 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-5 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-5 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-5 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-5 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-5 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-5 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-5 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-5 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-5 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-5 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-5 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-5 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-5 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-5 div.sk-item {position: relative;z-index: 1;}#sk-container-id-5 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-5 div.sk-item::before, #sk-container-id-5 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-5 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-5 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-5 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-5 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-5 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-5 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-5 div.sk-label-container {text-align: center;}#sk-container-id-5 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-5 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-5" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>AdaBoostRegressor(n_estimators=500)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox" checked><label for="sk-estimator-id-5" class="sk-toggleable__label sk-toggleable__label-arrow">AdaBoostRegressor</label><div class="sk-toggleable__content"><pre>AdaBoostRegressor(n_estimators=500)</pre></div></div></div></div></div>

<ol>
<li>
<p>For each group </p>
<ul>
<li>Estimate CATE from treatment group </li>
</ul>
<p><span class="arithmatex">\(\tau_1 = Y_{T=1} - \text{Model 0}_{\text{Stage 1}}\)</span></p>
</li>
<li>
<p>Estimate CATE from control group </p>
<p><span class="arithmatex">\(\tau_0 = \text{Model 1}_{\text{Stage 1}} - Y_{T=0}\)</span> </p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">estimate_partial_cate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model0</span><span class="p">,</span><span class="n">model1</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">T</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Y</span><span class="p">,</span><span class="n">T</span><span class="p">]]</span>


    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span> <span class="o">==</span><span class="mi">1</span> <span class="p">:</span>

        <span class="n">counterfactual</span> <span class="o">=</span>  <span class="n">model0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">partial_tau</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span> <span class="o">-</span> <span class="n">counterfactual</span>
        <span class="k">return</span> <span class="n">partial_tau</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span> <span class="o">==</span><span class="mi">0</span> <span class="p">:</span>

        <span class="n">counterfactual</span> <span class="o">=</span>  <span class="n">model1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">partial_tau</span> <span class="o">=</span> <span class="n">counterfactual</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">Y</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">partial_tau</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">tau</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">estimate_partial_cate</span><span class="p">,</span><span class="n">model0</span><span class="o">=</span><span class="n">xlearner_t0_s1</span><span class="p">,</span>
                                     <span class="n">model1</span><span class="o">=</span><span class="n">xlearner_t1_s1</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>
<p>Fit Model to Estimate </p>
<p>$\text{Model 0}_{\text{Stage 2}} = E[\tau_0|X,T=0] $</p>
<p>$\text{Model 1}_{\text{Stage 2}} = E[\tau_1|X,T=1] $</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nb">type</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>pandas.core.series.Series
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">xlearner_t1_s2</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">xlearner_t0_s2</span> <span class="o">=</span> <span class="n">AdaBoostRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">col_to_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span>

<span class="n">X_treatment</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_train</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col_to_exclude</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">X_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_train</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col_to_exclude</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>


<span class="n">y_treatment</span> <span class="o">=</span> <span class="n">tau</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_treatment</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">y_control</span> <span class="o">=</span> <span class="n">tau</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_control</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> 


<span class="n">xlearner_t1_s2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_treatment</span><span class="p">,</span><span class="n">y_treatment</span><span class="p">)</span>
<span class="n">xlearner_t0_s2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_control</span><span class="p">,</span><span class="n">y_control</span><span class="p">)</span>
</code></pre></div>
<style>#sk-container-id-6 {color: black;}#sk-container-id-6 pre{padding: 0;}#sk-container-id-6 div.sk-toggleable {background-color: white;}#sk-container-id-6 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-6 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-6 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-6 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-6 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-6 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-6 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-6 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-6 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-6 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-6 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-6 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-6 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-6 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-6 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-6 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-6 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-6 div.sk-item {position: relative;z-index: 1;}#sk-container-id-6 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-6 div.sk-item::before, #sk-container-id-6 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-6 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-6 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-6 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-6 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-6 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-6 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-6 div.sk-label-container {text-align: center;}#sk-container-id-6 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-6 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-6" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>AdaBoostRegressor(n_estimators=500)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-6" type="checkbox" checked><label for="sk-estimator-id-6" class="sk-toggleable__label sk-toggleable__label-arrow">AdaBoostRegressor</label><div class="sk-toggleable__content"><pre>AdaBoostRegressor(n_estimators=500)</pre></div></div></div></div></div>

<ol>
<li>
<p>Fit Propensity Score Model </p>
<p>$\text{Propensity Model} = E[T=1|X] $</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="n">propensity_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>


<span class="n">propensity_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">data_train</span><span class="p">[</span><span class="s1">&#39;Treatment&#39;</span><span class="p">])</span>
</code></pre></div>
<style>#sk-container-id-7 {color: black;}#sk-container-id-7 pre{padding: 0;}#sk-container-id-7 div.sk-toggleable {background-color: white;}#sk-container-id-7 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-7 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-7 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-7 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-7 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-7 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-7 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-7 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-7 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-7 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-7 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-7 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-7 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-7 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-7 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-7 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-7 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-7 div.sk-item {position: relative;z-index: 1;}#sk-container-id-7 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-7 div.sk-item::before, #sk-container-id-7 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-7 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-7 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-7 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-7 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-7 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-7 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-7 div.sk-label-container {text-align: center;}#sk-container-id-7 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-7 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-7" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>LogisticRegression()</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox" checked><label for="sk-estimator-id-7" class="sk-toggleable__label sk-toggleable__label-arrow">LogisticRegression</label><div class="sk-toggleable__content"><pre>LogisticRegression()</pre></div></div></div></div></div>

<ol>
<li>During Prediction 
   Given Input <span class="arithmatex">\(X_i\)</span> </li>
</ol>
<p>$\tau_i = (E[T=1|X_i]) * E[\tau_1|X,T=1] + (1 - (E[T=1|X_i])) * E[\tau_0|X,T=0] $</p>
<p>hence <span class="arithmatex">\(\tau_i\)</span> is <strong>weighted prediction</strong> , ensemble of ensemble, yeay!</p>
<div class="highlight"><pre><span></span><code><span class="n">propensity_score</span> <span class="o">=</span> <span class="n">propensity_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">xlearner_final_cate</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlearner_t1_s2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">propensity_score</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> \
                        <span class="o">+</span> <span class="p">(</span><span class="n">xlearner_t0_s2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">propensity_score</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict_cate_xlearner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model1_s2</span><span class="o">=</span><span class="n">xlearner_t1_s2</span><span class="p">,</span><span class="n">model0_s2</span><span class="o">=</span><span class="n">xlearner_t0_s2</span><span class="p">,</span><span class="n">propensity_model</span><span class="o">=</span><span class="n">propensity_model</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">propensity_score</span> <span class="o">=</span> <span class="n">propensity_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">xlearner_final_cate</span> <span class="o">=</span> <span class="p">(</span><span class="n">model1_s2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">propensity_score</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> \
                        <span class="o">+</span> <span class="p">(</span><span class="n">model0_s2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">propensity_score</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">xlearner_final_cate</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">xlearner_final_cate</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;X learner CATE&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;X Learner CATE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span>
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_98_0.png" /></p>
<div class="highlight"><pre><span></span><code>&lt;Figure size 640x480 with 0 Axes&gt;
</code></pre></div>
<h3 id="3rd-modelling-using-target-transformation"><span class="arithmatex">\(3^{rd}\)</span>  Modelling using target transformation<a class="headerlink" href="#3rd-modelling-using-target-transformation" title="Permanent link">&para;</a></h3>
<p>the problem with CATE is that we cannot observe label of true CATE, only the estimate of it, can we a bit hackish so that we could estimate CATE on each individual observation ? <strong>Yess</strong> (Forcefully  ) we can use <strong>Target Transformation</strong> </p>
<p>Why we need target transformation ? It's because in common machine learning problem , obtaining target variables mean : 
1. Easy for evaluation simply like Regression Metrics (MAE,MSE)
2. Optimization Solution (MSE Loss for example)</p>
<p>In <a href="https://matheusfacure.github.io/python-causality-handbook/20-Plug-and-Play-Estimators.html">Matheus Facure Book</a> we can perform target transformation </p>
<p>by first taking a look whether the experiment control and group are equal 50% : 50%, if so then : </p>
<p><span class="arithmatex">\(Y_i^* = 2Y_i*T_i - 2Y_i*(1-T_i)\)</span></p>
<p><span class="arithmatex">\(2Y_i*T_i\)</span> = Outcome on Treatment <span class="arithmatex">\(Y_i^1\)</span></p>
<p><span class="arithmatex">\(2Y_i*(1-T_i)\)</span> = Outcome on Treatment <span class="arithmatex">\(Y_i^0\)</span></p>
<p>to check its validity we can verify 
by checking whether </p>
<p><span class="arithmatex">\(E[Y_i^*|X_i=x] = \tau(x)_i\)</span></p>
<p>$$
<script type="math/tex; mode=display">\begin{align}
E[Y_i^*|X_i=x]  &= E[2Y_i*T_i - 2Y_i*(1-T_i)|X_i=x] \\
&= E[2Y_i*T_i] - E[2Y_i*(1-T_i)|X_i=x] \\
&= 2E[Y_i^1*T_i|X_i=x] - 2E[Y_i^0*(1-T_i)|X_i=x] \\
&= 2E[Y_i^1|X_i=x]*E[T_i|X_i=x] - 2E[Y_i^0|X_i=x]*E[(1-T_i)|X_i=x]  \\
&= 2E[Y_i^1|X_i=x]*0.5 - 2E[Y_i^0|X_i=x]*(1-0.5)  \\
&= E[Y_i^1|X_i=x]- E[Y_i^0|X_i=x]  \\
&= \tau(x)_i \\
\end{align}</script>
</p>
<p>$$</p>
<p>However in our condition we are not possible to do so ? It's because we don't have 50 : 50 proportion , we can use </p>
<p><span class="arithmatex">\(Y_i^* = Y_i * \cfrac{T-e(X_i)}{e(X_i)(1-e(X_i))}\)</span></p>
<p>with 
$e(X_i) $ is propensity model given <span class="arithmatex">\(X_i\)</span></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">transform_y_star</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">propensity_model</span><span class="o">=</span><span class="n">propensity_model</span><span class="p">,</span><span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span><span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">)</span> <span class="p">:</span> 

    <span class="c1"># predict propensity score </span>
    <span class="n">propensity_score</span> <span class="o">=</span> <span class="n">propensity_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">outcome_col</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">y_star</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">treatment_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">propensity_score</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">propensity_score</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">propensity_score</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">y_star</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Y_star_train</span> <span class="o">=</span> <span class="n">transform_y_star</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Y_star_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0      -110.755648
1      -113.294355
2      -106.189810
3      -106.571512
4      -116.448215
           ...    
2395   -101.712382
2396   -116.399907
2397   -111.188511
2398   -119.168422
2399   -110.466606
Length: 2400, dtype: float64
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Y_star_val</span> <span class="o">=</span> <span class="n">transform_y_star</span><span class="p">(</span><span class="n">data_val</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Y_star_val</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0      -119.085197
1      -116.263022
2       -99.919909
3      -109.527690
4      -117.176332
          ...     
295    -114.648191
296     -98.236654
297    1400.780810
298    -113.283261
299    -114.136317
Length: 300, dtype: float64
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Y_star_test</span> <span class="o">=</span> <span class="n">transform_y_star</span><span class="p">(</span><span class="n">data_test</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Y_star_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0     -113.693352
1     -117.231432
2     -109.337136
3     -106.225375
4     -118.357761
          ...    
295   -111.603392
296   -120.213009
297   -110.320215
298    667.131541
299   -105.251826
Length: 300, dtype: float64
</code></pre></div>
<p>After this you can train those using any machine learning model </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="n">model_target_transform</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>

<span class="n">model_target_transform</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span><span class="s1">&#39;Treatment&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">Y_star_train</span><span class="p">)</span>
</code></pre></div>
<style>#sk-container-id-8 {color: black;}#sk-container-id-8 pre{padding: 0;}#sk-container-id-8 div.sk-toggleable {background-color: white;}#sk-container-id-8 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-8 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-8 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-8 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-8 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-8 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-8 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-8 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-8 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-8 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-8 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-8 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-8 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-8 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-8 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-8 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-8 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-8 div.sk-item {position: relative;z-index: 1;}#sk-container-id-8 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-8 div.sk-item::before, #sk-container-id-8 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-8 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-8 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-8 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-8 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-8 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-8 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-8 div.sk-label-container {text-align: center;}#sk-container-id-8 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-8 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-8" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>RandomForestRegressor()</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-8" type="checkbox" checked><label for="sk-estimator-id-8" class="sk-toggleable__label sk-toggleable__label-arrow">RandomForestRegressor</label><div class="sk-toggleable__content"><pre>RandomForestRegressor()</pre></div></div></div></div></div>

<div class="highlight"><pre><span></span><code><span class="n">y_val_pred</span> <span class="o">=</span> <span class="n">model_target_transform</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_val</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span><span class="s1">&#39;Treatment&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span> 


<span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">Y_star_val</span><span class="p">,</span><span class="n">y_pred</span><span class="o">=</span><span class="n">y_val_pred</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>1079896.9001854945
</code></pre></div>
<h3 id="evaluating-model">Evaluating Model<a class="headerlink" href="#evaluating-model" title="Permanent link">&para;</a></h3>
<p>The   standard of machine learning evaluation : </p>
<ol>
<li>Split Data into 2 (Training, Test) / 3 (Training, Test, &amp; Validation )</li>
<li>Train model on training data </li>
<li>Evaluate on Test / Validation Data </li>
</ol>
<p>The problem is : We don't have label of <strong>CATE</strong> , above mentioned target transformation still can't reflect the true labels of <strong>CATE</strong> just like unknown function. </p>
<p>In <a href="https://proceedings.mlr.press/v67/gutierrez17a/gutierrez17a.pdf">this</a> survey paper highlight some strategies to evaluate uplift modelling </p>
<ol>
<li>Using Traditional Uplift Metrics</li>
</ol>
<p>Using Uplift Metrics in forms of bin / groups </p>
<p>Steps : 
   - Predict the uplift or <strong>CATE</strong> in both treatment and control groups 
   - Compute the average for each decile in each group 
   - Calculate the difference in each decile group (<strong>gain</strong>)</p>
<h3 id="gain">Gain<a class="headerlink" href="#gain" title="Permanent link">&para;</a></h3>
<ol>
<li>Predict CATE in both groups </li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">inference_train</span> <span class="o">=</span> <span class="n">data_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">inference_test</span> <span class="o">=</span> <span class="n">data_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="c1"># slearner  </span>
<span class="c1"># inference_train[&#39;cate_lr&#39;] = predict_cate_lr(model=model_cate_lr,X=inference_train\</span>
<span class="c1">#                             .drop([&#39;GrossBooking&#39;,&#39;Treatment&#39;],axis=1))</span>
<span class="c1"># inference_test[&#39;cate_lr&#39;] = predict_cate_lr(model=model_cate_lr,X=inference_test\</span>
<span class="c1">#                             .drop([&#39;GrossBooking&#39;,&#39;Treatment&#39;],axis=1))</span>


<span class="n">inference_train</span><span class="p">[</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_slearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">inference_test</span><span class="p">[</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_slearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_test</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</code></pre></div>
<ol>
<li>Compute Average CATE in each groups decile </li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># get groups </span>
<span class="n">cate_decile_treatment</span> <span class="o">=</span> <span class="n">inference_train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Treatment==1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="nb">bin</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">inference_train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Treatment==1&#39;</span><span class="p">)</span><span class="o">.</span>\
                        <span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">]),</span><span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="kc">False</span> <span class="p">))</span>\
                        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">})</span>

<span class="n">cate_decile_control</span> <span class="o">=</span> <span class="n">inference_train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Treatment==0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="nb">bin</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">inference_train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Treatment==0&#39;</span><span class="p">)</span><span class="o">.</span>\
                        <span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">]),</span><span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="kc">False</span> <span class="p">))</span>\
                        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>---------------------------------------------------------------------------

ValueError                                Traceback (most recent call last)

Cell In[59], line 2
      1 # get groups 
----&gt; 2 cate_decile_treatment = inference_train.query(&#39;Treatment==1&#39;).assign(bin=pd.qcut(x=(inference_train.query(&#39;Treatment==1&#39;).\
      3                         loc[:,&#39;cate_slearner&#39;]),q=10,labels=False ))\
      4                         .groupby(&#39;bin&#39;).agg({&#39;cate_slearner&#39;:&#39;mean&#39;})
      6 cate_decile_control = inference_train.query(&#39;Treatment==0&#39;).assign(bin=pd.qcut(x=(inference_train.query(&#39;Treatment==0&#39;).\
      7                         loc[:,&#39;cate_slearner&#39;]),q=10,labels=False ))\
      8                         .groupby(&#39;bin&#39;).agg({&#39;cate_slearner&#39;:&#39;mean&#39;})


File c:\Users\fakhr\AppData\Local\Programs\Python\Python311\Lib\site-packages\pandas\core\reshape\tile.py:340, in qcut(x, q, labels, retbins, precision, duplicates)
    336 quantiles = np.linspace(0, 1, q + 1) if is_integer(q) else q
    338 bins = x_idx.to_series().dropna().quantile(quantiles)
--&gt; 340 fac, bins = _bins_to_cuts(
    341     x_idx,
    342     Index(bins),
    343     labels=labels,
    344     precision=precision,
    345     include_lowest=True,
    346     duplicates=duplicates,
    347 )
    349 return _postprocess_for_cut(fac, bins, retbins, original)


File c:\Users\fakhr\AppData\Local\Programs\Python\Python311\Lib\site-packages\pandas\core\reshape\tile.py:443, in _bins_to_cuts(x_idx, bins, right, labels, precision, include_lowest, duplicates, ordered)
    441 if len(unique_bins) &lt; len(bins) and len(bins) != 2:
    442     if duplicates == &quot;raise&quot;:
--&gt; 443         raise ValueError(
    444             f&quot;Bin edges must be unique: {repr(bins)}.\n&quot;
    445             f&quot;You can drop duplicate edges by setting the &#39;duplicates&#39; kwarg&quot;
    446         )
    447     bins = unique_bins
    449 side: Literal[&quot;left&quot;, &quot;right&quot;] = &quot;left&quot; if right else &quot;right&quot;


ValueError: Bin edges must be unique: Index([28.364680498458796,   65.0463209597256,  66.05373312568801,
        66.05373312568801,  69.18811402071225,  85.11635587044222,
       110.36429339664477, 117.96849741970071, 122.24310318631733,
        155.1510308498945, 191.09766778653574],
      dtype=&#39;float64&#39;, name=&#39;cate_slearner&#39;).
You can drop duplicate edges by setting the &#39;duplicates&#39; kwarg
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">display</span><span class="p">(</span><span class="n">cate_decile_treatment</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">cate_decile_control</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cate_slearner</th>
    </tr>
    <tr>
      <th>bin</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>57.149450</td>
    </tr>
    <tr>
      <th>1</th>
      <td>65.328915</td>
    </tr>
    <tr>
      <th>2</th>
      <td>74.068734</td>
    </tr>
    <tr>
      <th>3</th>
      <td>87.726081</td>
    </tr>
    <tr>
      <th>4</th>
      <td>90.563524</td>
    </tr>
    <tr>
      <th>5</th>
      <td>95.141914</td>
    </tr>
    <tr>
      <th>6</th>
      <td>100.721393</td>
    </tr>
    <tr>
      <th>7</th>
      <td>107.287273</td>
    </tr>
    <tr>
      <th>8</th>
      <td>134.848450</td>
    </tr>
    <tr>
      <th>9</th>
      <td>164.555192</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cate_slearner</th>
    </tr>
    <tr>
      <th>bin</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>53.206568</td>
    </tr>
    <tr>
      <th>1</th>
      <td>65.003058</td>
    </tr>
    <tr>
      <th>2</th>
      <td>67.604734</td>
    </tr>
    <tr>
      <th>3</th>
      <td>86.066899</td>
    </tr>
    <tr>
      <th>4</th>
      <td>91.947500</td>
    </tr>
    <tr>
      <th>5</th>
      <td>96.878758</td>
    </tr>
    <tr>
      <th>6</th>
      <td>103.224171</td>
    </tr>
    <tr>
      <th>7</th>
      <td>121.331323</td>
    </tr>
    <tr>
      <th>8</th>
      <td>142.836045</td>
    </tr>
    <tr>
      <th>9</th>
      <td>172.046919</td>
    </tr>
  </tbody>
</table>
</div>

<ol>
<li>Measure the difference (<strong>gain</strong>) for CATE</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">gain_</span> <span class="o">=</span> <span class="n">cate_decile_treatment</span> <span class="o">-</span> <span class="n">cate_decile_control</span>
</code></pre></div>
<p>Visualize </p>
<div class="highlight"><pre><span></span><code><span class="n">plot_slearner</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)],</span><span class="n">y</span><span class="o">=</span><span class="n">gain_</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gain of CATE by decile S Learner&#39;</span><span class="p">)</span>

<span class="c1"># Add data labels on the bars</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plot_slearner</span><span class="o">.</span><span class="n">patches</span><span class="p">:</span>
    <span class="n">plot_slearner</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="s1">&#39;.1f&#39;</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get_height</span><span class="p">()),</span> 
                <span class="n">ha</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                <span class="n">xytext</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> 
                <span class="n">textcoords</span> <span class="o">=</span> <span class="s1">&#39;offset points&#39;</span><span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_120_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evalute_uplift_bin</span><span class="p">(</span><span class="n">prediction_result</span><span class="p">,</span><span class="n">cate_column</span><span class="p">,</span><span class="n">t_col</span><span class="p">,</span><span class="n">model_name</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">cate_decile_treatment</span> <span class="o">=</span> <span class="n">prediction_result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t_col</span><span class="si">}</span><span class="s1">==1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="nb">bin</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t_col</span><span class="si">}</span><span class="s1">==1&#39;</span><span class="p">)</span><span class="o">.</span>\
                        <span class="n">loc</span><span class="p">[:,</span><span class="n">cate_column</span><span class="p">]),</span><span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="kc">False</span> <span class="p">))</span>\
                        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">cate_column</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">})</span>

    <span class="n">cate_decile_control</span> <span class="o">=</span> <span class="n">prediction_result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t_col</span><span class="si">}</span><span class="s1">==0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="nb">bin</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t_col</span><span class="si">}</span><span class="s1">==0&#39;</span><span class="p">)</span><span class="o">.</span>\
                            <span class="n">loc</span><span class="p">[:,</span><span class="n">cate_column</span><span class="p">]),</span><span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="kc">False</span> <span class="p">))</span>\
                            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">cate_column</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">})</span>  

    <span class="n">gain_</span> <span class="o">=</span> <span class="n">cate_decile_treatment</span> <span class="o">-</span> <span class="n">cate_decile_control</span>


    <span class="n">plot_slearner</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)],</span><span class="n">y</span><span class="o">=</span><span class="n">gain_</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Gain of CATE by decile </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Add data labels on the bars</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plot_slearner</span><span class="o">.</span><span class="n">patches</span><span class="p">:</span>
        <span class="n">plot_slearner</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="s1">&#39;.1f&#39;</span><span class="p">),</span> 
                    <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get_height</span><span class="p">()),</span> 
                    <span class="n">ha</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                    <span class="n">xytext</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> 
                    <span class="n">textcoords</span> <span class="o">=</span> <span class="s1">&#39;offset points&#39;</span><span class="p">)</span>

    <span class="c1"># Show the plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">gain_</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">evalute_uplift_bin</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">inference_test</span><span class="p">,</span>
                   <span class="n">cate_column</span><span class="o">=</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">,</span>
                   <span class="n">t_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                   <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;Slearner&#39;</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_122_0.png" /></p>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cate_slearner</th>
    </tr>
    <tr>
      <th>bin</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-6.903539</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-4.941637</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-11.728246</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-22.237055</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-8.996468</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-3.817163</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-4.217261</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-11.009020</td>
    </tr>
    <tr>
      <th>8</th>
      <td>5.488645</td>
    </tr>
    <tr>
      <th>9</th>
      <td>-4.999156</td>
    </tr>
  </tbody>
</table>
</div>

<p>Let's Compare the models</p>
<div class="highlight"><pre><span></span><code><span class="n">inference_train</span><span class="p">[</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_xlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">)</span>
<span class="n">inference_test</span><span class="p">[</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_xlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_test</span><span class="p">)</span>


<span class="n">inference_train</span><span class="p">[</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_tlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">)</span>
<span class="n">inference_test</span><span class="p">[</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_tlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_test</span><span class="p">)</span>


<span class="n">inference_train</span><span class="p">[</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_tlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">)</span>
<span class="n">inference_test</span><span class="p">[</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_tlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">_</span> <span class="o">=</span> <span class="n">evalute_uplift_bin</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">inference_train</span><span class="p">,</span>
                   <span class="n">cate_column</span><span class="o">=</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">,</span>
                   <span class="n">t_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                   <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;Xlearner Training&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">evalute_uplift_bin</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">inference_train</span><span class="p">,</span>
                   <span class="n">cate_column</span><span class="o">=</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">,</span>
                   <span class="n">t_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                   <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;Tlearner Training&#39;</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_125_0.png" /></p>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_125_1.png" /></p>
<p>We can also craft it in cumulative way </p>
<p>If we can see it's hard to compare both models, the good models should can we use some sort of direct comparative that is similar to <strong>AUC</strong> in common machine learning method, yes we can </p>
<p><strong>Uplift Curve</strong> </p>
<p><span class="arithmatex">\(f(t) = \left (    \cfrac{Y_t^T}{N_t^T} - \cfrac{Y_t^C}{N_t^C}    \right ) \left (  N_t^T + N_t^C\right )\)</span></p>
<p>with : 
1. <span class="arithmatex">\(Y_t^T\)</span> : Cumulative Outcome Variable for <strong>Treatment Group</strong> up to <span class="arithmatex">\(t^{th}\)</span> observation 
2. <span class="arithmatex">\(Y_t^C\)</span> : Cumulative Outcome Variable for <strong>Control Group</strong> up to <span class="arithmatex">\(t^{th}\)</span> observation
3. <span class="arithmatex">\(N_t^T\)</span> : Number of Observation for <strong>Treatment Group</strong> up to <span class="arithmatex">\(t^{th}\)</span> observation
4. <span class="arithmatex">\(N_t^C\)</span> : Number of Observation for <strong>Control Group</strong> up to <span class="arithmatex">\(t^{th}\)</span> observation</p>
<p>Essence : If we have good causal model then it will sort the same as the real outcome data 
Procedure 
1. Sort the data based on <code>uplift</code> or <code>cate columns</code>
2. Create Running Cumulation</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_uplift_curve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">outcome_col</span><span class="p">,</span><span class="n">uplift_col</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># sort based on uplift_col</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">uplift_col</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">encoded_treatment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">treatment_col</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">encoded_treatment</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span><span class="n">encoded_treatment</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># multiply f&#39;{treatment_col}_0&#39;,f&#39;{treatment_col}_1&#39; to outcome column </span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span> <span class="c1"># our $Y_t^T$</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span> <span class="c1"># our $Y_t^C$</span>

    <span class="c1"># calculate cumsum </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>


    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;N_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;N_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>



    <span class="c1"># calculate f_t </span>

    <span class="c1"># uplift =  ( ( (data[&#39;Y_T&#39;]/data[&#39;N_T&#39;]) \</span>
    <span class="c1">#                     - (data[&#39;Y_C&#39;]/data[&#39;N_C&#39;]) ) * (data[&#39;N_T&#39;] + data[&#39;N_C&#39;]) ).values</span>
    <span class="c1"># if normalize : </span>
    <span class="c1">#     max_value = uplift.max()</span>
    <span class="c1">#     uplift = uplift/max_value</span>

    <span class="c1"># instead of calculating uplift for each row / observation calculate at each step </span>
    <span class="c1"># inspired from https://matheusfacure.github.io/python-causality-handbook/19-Evaluating-Causal-Models.html#references</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_periods</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">//</span> <span class="n">steps</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">size</span><span class="p">]</span> 
    <span class="n">n_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">n_rows</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n rows&#39;</span><span class="p">,</span><span class="n">n_rows</span><span class="p">)</span>
    <span class="n">cumulative_uplifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_rows</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">rows</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_rows</span><span class="p">)</span> <span class="p">:</span> 
        <span class="n">data_at</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rows</span><span class="p">,:]</span>

        <span class="n">uplift</span> <span class="o">=</span>   <span class="p">(</span> <span class="p">(</span><span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;Y_T&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;N_T&#39;</span><span class="p">])</span> \
                                <span class="o">-</span> <span class="p">(</span><span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;Y_C&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;N_C&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;N_T&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;N_C&#39;</span><span class="p">])</span> 

        <span class="n">cumulative_uplifts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">uplift</span>


    <span class="n">pct</span> <span class="o">=</span> <span class="p">[</span><span class="n">rows</span><span class="o">/</span><span class="n">size</span> <span class="k">for</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">n_rows</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">normalize</span> <span class="p">:</span> 
        <span class="c1"># normalizing the uplift into 0 to 1 scale so that comparable, </span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">cumulative_uplifts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">cumulative_uplifts</span> <span class="o">=</span> <span class="n">cumulative_uplifts</span><span class="o">/</span><span class="n">max_value</span>


    <span class="k">return</span> <span class="n">pct</span><span class="p">,</span> <span class="n">cumulative_uplifts</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">pct</span><span class="p">,</span><span class="n">slearner_gain</span> <span class="o">=</span> <span class="n">calculate_uplift_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_train</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pct</span><span class="p">,</span><span class="n">xlearner_gain</span> <span class="o">=</span> <span class="n">calculate_uplift_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_train</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pct</span><span class="p">,</span><span class="n">tlearner_gain</span> <span class="o">=</span>   <span class="n">calculate_uplift_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_train</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>n rows [29, 53, 77, 101, 125, 149, 173, 197, 221, 245, 269, 293, 317, 341, 365, 389, 413, 437, 461, 485, 509, 533, 557, 581, 605, 629, 653, 677, 701, 725, 749, 773, 797, 821, 845, 869, 893, 917, 941, 965, 989, 1013, 1037, 1061, 1085, 1109, 1133, 1157, 1181, 1205, 1229, 1253, 1277, 1301, 1325, 1349, 1373, 1397, 1421, 1445, 1469, 1493, 1517, 1541, 1565, 1589, 1613, 1637, 1661, 1685, 1709, 1733, 1757, 1781, 1805, 1829, 1853, 1877, 1901, 1925, 1949, 1973, 1997, 2021, 2045, 2069, 2093, 2117, 2141, 2165, 2189, 2213, 2237, 2261, 2285, 2309, 2333, 2357, 2381, 2399]
n rows [29, 53, 77, 101, 125, 149, 173, 197, 221, 245, 269, 293, 317, 341, 365, 389, 413, 437, 461, 485, 509, 533, 557, 581, 605, 629, 653, 677, 701, 725, 749, 773, 797, 821, 845, 869, 893, 917, 941, 965, 989, 1013, 1037, 1061, 1085, 1109, 1133, 1157, 1181, 1205, 1229, 1253, 1277, 1301, 1325, 1349, 1373, 1397, 1421, 1445, 1469, 1493, 1517, 1541, 1565, 1589, 1613, 1637, 1661, 1685, 1709, 1733, 1757, 1781, 1805, 1829, 1853, 1877, 1901, 1925, 1949, 1973, 1997, 2021, 2045, 2069, 2093, 2117, 2141, 2165, 2189, 2213, 2237, 2261, 2285, 2309, 2333, 2357, 2381, 2399]
n rows [29, 53, 77, 101, 125, 149, 173, 197, 221, 245, 269, 293, 317, 341, 365, 389, 413, 437, 461, 485, 509, 533, 557, 581, 605, 629, 653, 677, 701, 725, 749, 773, 797, 821, 845, 869, 893, 917, 941, 965, 989, 1013, 1037, 1061, 1085, 1109, 1133, 1157, 1181, 1205, 1229, 1253, 1277, 1301, 1325, 1349, 1373, 1397, 1421, 1445, 1469, 1493, 1517, 1541, 1565, 1589, 1613, 1637, 1661, 1685, 1709, 1733, 1757, 1781, 1805, 1829, 1853, 1877, 1901, 1925, 1949, 1973, 1997, 2021, 2045, 2069, 2093, 2117, 2141, 2165, 2189, 2213, 2237, 2261, 2285, 2309, 2333, 2357, 2381, 2399]
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">auc</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">xlearner_gain</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;X-learner, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">xlearner_gain</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">slearner_gain</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;S-learner, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">slearner_gain</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">tlearner_gain</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;T-learner, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">tlearner_gain</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">markers</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random treatment, AUC = 0.5&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Gain Curve in Training Data&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0.5, 1.0, &#39;Cumulative Gain Curve in Training Data&#39;)
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_131_1.png" /></p>
<p>In uplift curve still there are limitation, where if not in randomized experiment it fails to make group in cumulative comparable. Hence we need other solution</p>
<h3 id="qini-curve">Qini Curve<a class="headerlink" href="#qini-curve" title="Permanent link">&para;</a></h3>
<p>The next one to eva</p>
<p>According to Radcliffe (2007) qini curve can be defined as : 
<span class="arithmatex">\(g(t) = \left (    Y_t^T - \cfrac{Y_t^C N_t^T} {N_t^C}    \right )\)</span></p>
<p>if we dig up little bit </p>
<p><span class="arithmatex">\(g(t) = \left (   \cfrac{ Y_t^T N_t^C}{N_t^C} - \cfrac{Y_t^C N_t^T} {N_t^C}    \right )\)</span></p>
<p>to make it comparable outcome for both treatment and control are scaled / multiplied by their counterpart</p>
<p>with : 
1. <span class="arithmatex">\(Y_t^T\)</span> : Cumulative Outcome Variable for <strong>Treatment Group</strong> up to <span class="arithmatex">\(t^{th}\)</span> observation 
2. <span class="arithmatex">\(Y_t^C\)</span> : Cumulative Outcome Variable for <strong>Control Group</strong> up to <span class="arithmatex">\(t^{th}\)</span> observation
3. <span class="arithmatex">\(N_t^T\)</span> : Number of Observation for <strong>Treatment Group</strong> up to <span class="arithmatex">\(t^{th}\)</span> observation
4. <span class="arithmatex">\(N_t^C\)</span> : Number of Observation for <strong>Control Group</strong> up to <span class="arithmatex">\(t^{th}\)</span> observation</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">outcome_col</span><span class="p">,</span><span class="n">uplift_col</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># sort based on uplift_col</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">uplift_col</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">encoded_treatment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">treatment_col</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">encoded_treatment</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">treatment_col</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span><span class="n">encoded_treatment</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># multiply f&#39;{treatment_col}_0&#39;,f&#39;{treatment_col}_1&#39; to outcome column </span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span> <span class="c1"># our $Y_t^T$</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span> <span class="c1"># our $Y_t^C$</span>

    <span class="c1"># calculate cumsum </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>


    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;N_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;N_C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">treatment_col</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>



    <span class="c1"># calculate f_t </span>

    <span class="c1"># uplift =  ( ( (data[&#39;Y_T&#39;]/data[&#39;N_T&#39;]) \</span>
    <span class="c1">#                     - (data[&#39;Y_C&#39;]/data[&#39;N_C&#39;]) ) * (data[&#39;N_T&#39;] + data[&#39;N_C&#39;]) ).values</span>
    <span class="c1"># if normalize : </span>
    <span class="c1">#     max_value = uplift.max()</span>
    <span class="c1">#     uplift = uplift/max_value</span>

    <span class="c1"># instead of calculating uplift for each row / observation calculate at each step </span>
    <span class="c1"># inspired from https://matheusfacure.github.io/python-causality-handbook/19-Evaluating-Causal-Models.html#references</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_periods</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">//</span> <span class="n">steps</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">size</span><span class="p">]</span> 
    <span class="n">n_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">n_rows</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n rows&#39;</span><span class="p">,</span><span class="n">n_rows</span><span class="p">)</span>
    <span class="n">cumulative_uplifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_rows</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">rows</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_rows</span><span class="p">)</span> <span class="p">:</span> 
        <span class="n">data_at</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rows</span><span class="p">,:]</span>

        <span class="n">uplift</span> <span class="o">=</span>    <span class="p">(</span><span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;Y_T&#39;</span><span class="p">])</span> \
                                <span class="o">-</span> <span class="p">(</span> <span class="p">(</span><span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;Y_C&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;N_T&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">data_at</span><span class="p">[</span><span class="s1">&#39;N_C&#39;</span><span class="p">]</span> <span class="p">)</span> 

        <span class="n">cumulative_uplifts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">uplift</span>


    <span class="n">pct</span> <span class="o">=</span> <span class="p">[</span><span class="n">rows</span><span class="o">/</span><span class="n">size</span> <span class="k">for</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">n_rows</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">normalize</span> <span class="p">:</span> 
        <span class="c1"># normalizing the uplift into 0 to 1 scale so that comparable, </span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">cumulative_uplifts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">cumulative_uplifts</span> <span class="o">=</span> <span class="n">cumulative_uplifts</span><span class="o">/</span><span class="n">max_value</span>


    <span class="k">return</span> <span class="n">pct</span><span class="p">,</span> <span class="n">cumulative_uplifts</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">pct</span><span class="p">,</span><span class="n">slearner_qini</span> <span class="o">=</span> <span class="n">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_train</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pct</span><span class="p">,</span><span class="n">xlearner_qini</span> <span class="o">=</span> <span class="n">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_train</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pct</span><span class="p">,</span><span class="n">tlearner_qini</span> <span class="o">=</span>   <span class="n">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_train</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>n rows [29, 53, 77, 101, 125, 149, 173, 197, 221, 245, 269, 293, 317, 341, 365, 389, 413, 437, 461, 485, 509, 533, 557, 581, 605, 629, 653, 677, 701, 725, 749, 773, 797, 821, 845, 869, 893, 917, 941, 965, 989, 1013, 1037, 1061, 1085, 1109, 1133, 1157, 1181, 1205, 1229, 1253, 1277, 1301, 1325, 1349, 1373, 1397, 1421, 1445, 1469, 1493, 1517, 1541, 1565, 1589, 1613, 1637, 1661, 1685, 1709, 1733, 1757, 1781, 1805, 1829, 1853, 1877, 1901, 1925, 1949, 1973, 1997, 2021, 2045, 2069, 2093, 2117, 2141, 2165, 2189, 2213, 2237, 2261, 2285, 2309, 2333, 2357, 2381, 2399]
n rows [29, 53, 77, 101, 125, 149, 173, 197, 221, 245, 269, 293, 317, 341, 365, 389, 413, 437, 461, 485, 509, 533, 557, 581, 605, 629, 653, 677, 701, 725, 749, 773, 797, 821, 845, 869, 893, 917, 941, 965, 989, 1013, 1037, 1061, 1085, 1109, 1133, 1157, 1181, 1205, 1229, 1253, 1277, 1301, 1325, 1349, 1373, 1397, 1421, 1445, 1469, 1493, 1517, 1541, 1565, 1589, 1613, 1637, 1661, 1685, 1709, 1733, 1757, 1781, 1805, 1829, 1853, 1877, 1901, 1925, 1949, 1973, 1997, 2021, 2045, 2069, 2093, 2117, 2141, 2165, 2189, 2213, 2237, 2261, 2285, 2309, 2333, 2357, 2381, 2399]
n rows [29, 53, 77, 101, 125, 149, 173, 197, 221, 245, 269, 293, 317, 341, 365, 389, 413, 437, 461, 485, 509, 533, 557, 581, 605, 629, 653, 677, 701, 725, 749, 773, 797, 821, 845, 869, 893, 917, 941, 965, 989, 1013, 1037, 1061, 1085, 1109, 1133, 1157, 1181, 1205, 1229, 1253, 1277, 1301, 1325, 1349, 1373, 1397, 1421, 1445, 1469, 1493, 1517, 1541, 1565, 1589, 1613, 1637, 1661, 1685, 1709, 1733, 1757, 1781, 1805, 1829, 1853, 1877, 1901, 1925, 1949, 1973, 1997, 2021, 2045, 2069, 2093, 2117, 2141, 2165, 2189, 2213, 2237, 2261, 2285, 2309, 2333, 2357, 2381, 2399]
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">auc</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">xlearner_qini</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;X-learner , AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">xlearner_qini</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">slearner_qini</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;S-learner, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">slearner_qini</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">tlearner_qini</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;T-learner, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">tlearner_qini</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">markers</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random treatment, AUC = 0.5&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Qini Curve in Training Data&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0.5, 1.0, &#39;Cumulative Qini Curve in Training Data&#39;)
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_136_1.png" /></p>
<ol>
<li>Evaluation Metrics Based on Target Transformation <span class="arithmatex">\((Y^*)\)</span></li>
</ol>
<p>The problem we have when estimating CATE is based on our target transformation <span class="arithmatex">\(Y_i^*\)</span></p>
<p>our goal is to minimize </p>
<p><span class="arithmatex">\(\text{min } E[(\tau_i - \hat{\tau_i})^2]\)</span></p>
<p><span class="arithmatex">\(\text{min } E[(Y_i^* - \hat{\tau_i})^2]\)</span></p>
<p>easy task right? you find often in common machine learning </p>
<div class="highlight"><pre><span></span><code><span class="n">train_xlearner_cate</span> <span class="o">=</span> <span class="n">predict_cate_xlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">)</span>
<span class="n">train_slearner_cate</span> <span class="o">=</span> <span class="n">predict_cate_slearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">)</span>
<span class="n">train_tlearner_cate</span> <span class="o">=</span> <span class="n">predict_cate_tlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_train</span><span class="p">)</span>

<span class="n">train_target_transformation</span> <span class="o">=</span> <span class="n">model_target_transform</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span><span class="s1">&#39;Treatment&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">train_target_transformation</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([-112.40042316,  -58.37587738,  -81.14681886, ..., -108.8789247 ,
       -103.30859488,  -94.30339274])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">mse_xlearner</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_star_train</span><span class="p">,</span><span class="n">train_xlearner_cate</span><span class="p">)</span>
<span class="n">mse_slearner</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_star_train</span><span class="p">,</span><span class="n">train_slearner_cate</span><span class="p">)</span>
<span class="n">mse_tlearner</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_star_train</span><span class="p">,</span><span class="n">train_tlearner_cate</span><span class="p">)</span>
<span class="n">mse_target_transform</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_star_train</span><span class="p">,</span><span class="n">train_target_transformation</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;model_name&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;X Learner&#39;</span><span class="p">,</span><span class="s1">&#39;S Learner&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;T Learner&#39;</span><span class="p">,</span><span class="s1">&#39;Target Transformation&#39;</span><span class="p">]</span> <span class="p">,</span> 
    <span class="s1">&#39;mse&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="n">mse_xlearner</span><span class="p">,</span><span class="n">mse_slearner</span><span class="p">,</span><span class="n">mse_tlearner</span><span class="p">,</span><span class="n">mse_target_transform</span><span class="p">]</span>
<span class="p">})</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_name</th>
      <th>mse</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>X Learner</td>
      <td>617944.724506</td>
    </tr>
    <tr>
      <th>1</th>
      <td>S Learner</td>
      <td>618012.490589</td>
    </tr>
    <tr>
      <th>2</th>
      <td>T Learner</td>
      <td>617297.753014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Target Transformation</td>
      <td>374992.073824</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="finding-best-model">Finding Best Model<a class="headerlink" href="#finding-best-model" title="Permanent link">&para;</a></h3>
<p>Common ways to pick best model in machine learning can be done by 
1. Cross Validation 
2. Finding Model that has the best metrics in Validation Set </p>
<p>Both are good, but now we will try second approach as it simple. </p>
<p>Steps : </p>
<ol>
<li>
<p>Choose Metrics </p>
<p>If we see the that target transformation rely on propensity model, since then when we estimate the error it would be biased to the model fit </p>
<p>Hence for now we will use <strong>Qini</strong> score as metrics </p>
</li>
<li>
<p>Predict on Validation Data </p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">inference_val</span> <span class="o">=</span> <span class="n">data_val</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">inference_val</span><span class="p">[</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_xlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_val</span><span class="p">)</span>
<span class="n">inference_val</span><span class="p">[</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_slearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_val</span><span class="p">)</span>
<span class="n">inference_val</span><span class="p">[</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_tlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_val</span><span class="p">)</span>

<span class="n">inference_val</span><span class="p">[</span><span class="s1">&#39;cate_targettransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_target_transform</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_val</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span><span class="s1">&#39;Treatment&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<ol>
<li>Evalute </li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">pct</span><span class="p">,</span><span class="n">slearner_qini_val</span> <span class="o">=</span> <span class="n">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_val</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_slearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pct</span><span class="p">,</span><span class="n">xlearner_qini_val</span> <span class="o">=</span> <span class="n">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_val</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pct</span><span class="p">,</span><span class="n">tlearner_qini_val</span> <span class="o">=</span>   <span class="n">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_val</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_tlearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pct</span><span class="p">,</span><span class="n">target_transform_qini_val</span> <span class="o">=</span>   <span class="n">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_val</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_targettransform&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>n rows [29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59, 62, 65, 68, 71, 74, 77, 80, 83, 86, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116, 119, 122, 125, 128, 131, 134, 137, 140, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 200, 203, 206, 209, 212, 215, 218, 221, 224, 227, 230, 233, 236, 239, 242, 245, 248, 251, 254, 257, 260, 263, 266, 269, 272, 275, 278, 281, 284, 287, 290, 293, 296, 299]
n rows [29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59, 62, 65, 68, 71, 74, 77, 80, 83, 86, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116, 119, 122, 125, 128, 131, 134, 137, 140, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 200, 203, 206, 209, 212, 215, 218, 221, 224, 227, 230, 233, 236, 239, 242, 245, 248, 251, 254, 257, 260, 263, 266, 269, 272, 275, 278, 281, 284, 287, 290, 293, 296, 299]
n rows [29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59, 62, 65, 68, 71, 74, 77, 80, 83, 86, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116, 119, 122, 125, 128, 131, 134, 137, 140, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 200, 203, 206, 209, 212, 215, 218, 221, 224, 227, 230, 233, 236, 239, 242, 245, 248, 251, 254, 257, 260, 263, 266, 269, 272, 275, 278, 281, 284, 287, 290, 293, 296, 299]
n rows [29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59, 62, 65, 68, 71, 74, 77, 80, 83, 86, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116, 119, 122, 125, 128, 131, 134, 137, 140, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 200, 203, 206, 209, 212, 215, 218, 221, 224, 227, 230, 233, 236, 239, 242, 245, 248, 251, 254, 257, 260, 263, 266, 269, 272, 275, 278, 281, 284, 287, 290, 293, 296, 299]
</code></pre></div>
<ol>
<li>Summarize</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">auc</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">xlearner_qini_val</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;X-learner , AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">xlearner_qini_val</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">slearner_qini_val</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;S-learner, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">slearner_qini_val</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">tlearner_qini_val</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;T-learner, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">tlearner_qini_val</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">target_transform_qini_val</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Target Transformation, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">target_transform_qini_val</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">markers</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random treatment, AUC = 0.5&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cumulative Qini Curve in Validation Data&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0.5, 1.0, &#39;Cumulative Qini Curve in Validation Data&#39;)
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_151_1.png" /></p>
<p>Wee see that the best model is <strong>Target Transformation</strong></p>
<p>Next we evaluate on test data</p>
<div class="highlight"><pre><span></span><code><span class="n">inference_test</span> <span class="o">=</span> <span class="n">data_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">inference_test</span><span class="p">[</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict_cate_xlearner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_test</span><span class="p">)</span>

<span class="n">pct</span><span class="p">,</span><span class="n">xlearner_qini_test</span> <span class="o">=</span>   <span class="n">calculate_qini_curve</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inference_test</span><span class="p">,</span>
                       <span class="n">treatment_col</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s1">&#39;GrossBooking&#39;</span><span class="p">,</span>
                       <span class="n">uplift_col</span><span class="o">=</span><span class="s1">&#39;cate_xlearner&#39;</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span><span class="n">pct</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">xlearner_qini_test</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;X-Learner, AUC </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span><span class="n">xlearner_qini_test</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">markers</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random treatment, AUC = 0.5&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>n rows [29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59, 62, 65, 68, 71, 74, 77, 80, 83, 86, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116, 119, 122, 125, 128, 131, 134, 137, 140, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 200, 203, 206, 209, 212, 215, 218, 221, 224, 227, 230, 233, 236, 239, 242, 245, 248, 251, 254, 257, 260, 263, 266, 269, 272, 275, 278, 281, 284, 287, 290, 293, 296, 299]





&lt;Axes: &gt;
</code></pre></div>
<p><img alt="png" src="../targeting_problem_files/targeting_problem_154_2.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">inference_test</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;cate_targettransform&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Age</th>
      <th>NumberOfBooking</th>
      <th>ResponseToPastPromo</th>
      <th>LastBooking(Days)</th>
      <th>isMember</th>
      <th>average_apps_open_week</th>
      <th>Treatment</th>
      <th>female</th>
      <th>male</th>
      <th>GrossBooking</th>
      <th>cate_targettransform</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>86</th>
      <td>46</td>
      <td>47</td>
      <td>1</td>
      <td>148</td>
      <td>0</td>
      <td>31.044854</td>
      <td>1</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>360.935582</td>
      <td>3885.275750</td>
    </tr>
    <tr>
      <th>222</th>
      <td>46</td>
      <td>48</td>
      <td>1</td>
      <td>147</td>
      <td>0</td>
      <td>30.330558</td>
      <td>1</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>390.989137</td>
      <td>3410.578766</td>
    </tr>
    <tr>
      <th>159</th>
      <td>67</td>
      <td>43</td>
      <td>1</td>
      <td>108</td>
      <td>0</td>
      <td>30.298712</td>
      <td>1</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>338.279315</td>
      <td>3311.544684</td>
    </tr>
    <tr>
      <th>256</th>
      <td>47</td>
      <td>44</td>
      <td>1</td>
      <td>163</td>
      <td>1</td>
      <td>31.468509</td>
      <td>1</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>302.332050</td>
      <td>3279.984190</td>
    </tr>
    <tr>
      <th>32</th>
      <td>21</td>
      <td>33</td>
      <td>1</td>
      <td>277</td>
      <td>0</td>
      <td>31.526687</td>
      <td>1</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>320.412054</td>
      <td>3180.702677</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>127</th>
      <td>26</td>
      <td>9</td>
      <td>1</td>
      <td>25</td>
      <td>0</td>
      <td>30.465704</td>
      <td>0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>99.805883</td>
      <td>-120.504732</td>
    </tr>
    <tr>
      <th>118</th>
      <td>36</td>
      <td>5</td>
      <td>0</td>
      <td>330</td>
      <td>0</td>
      <td>30.113201</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>103.206083</td>
      <td>-120.914619</td>
    </tr>
    <tr>
      <th>135</th>
      <td>54</td>
      <td>29</td>
      <td>1</td>
      <td>357</td>
      <td>1</td>
      <td>30.346237</td>
      <td>0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>101.282853</td>
      <td>-121.138202</td>
    </tr>
    <tr>
      <th>81</th>
      <td>24</td>
      <td>45</td>
      <td>0</td>
      <td>285</td>
      <td>0</td>
      <td>31.675850</td>
      <td>0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>98.896170</td>
      <td>-122.740248</td>
    </tr>
    <tr>
      <th>124</th>
      <td>33</td>
      <td>1</td>
      <td>1</td>
      <td>224</td>
      <td>1</td>
      <td>30.281640</td>
      <td>0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>107.618674</td>
      <td>-125.771994</td>
    </tr>
  </tbody>
</table>
<p>300 rows × 11 columns</p>
</div>

<h1 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h1>
<ol>
<li>Fascure M. (2020), "Causal Inference for the Brave and True", https://matheusfacure.github.io/python-causality-handbook</li>
<li>Double Machine Learning for Treatment and Causal Parameters</li>
<li>Radcliffe, N. J., 2007a. Using Control Groups to Target on Predicted Lift: Building and Assessing Uplift Models. Direct Marketing Journal, Direct Marketing Asso-ciation Analytics Council (1), pp. 14-21.</li>
<li>Houssam Nassif, Finn Kuusisto, Elizabeth S Burnside, and Jude W Shavlik. Uplift modeling
with roc: An srl case study. In ILP (Late Breaking Papers), pages 40–45, 2013.</li>
</ol>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/fakhrirobi/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:fakhrirobi.fra@gmail.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../docs/javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../docs/javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>