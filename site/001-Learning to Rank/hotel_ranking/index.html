
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Fakhri Robi Aulia">
      
      
        <link rel="canonical" href="https://fakhrirobi.github.io/001-Learning%20to%20Rank/hotel_ranking/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Hotel ranking - Rovo's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Geologica:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Geologica";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../docs/stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hotel-search-ranking-system" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Rovo&#39;s Blog" class="md-header__button md-logo" aria-label="Rovo's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rovo's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hotel ranking
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/fakhrirobi/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Rovo&#39;s Blog" class="md-nav__button md-logo" aria-label="Rovo's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Rovo's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fakhrirobi/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/fakhrirobi/edit/master/docs/001-Learning to Rank/hotel_ranking.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/fakhrirobi/raw/master/docs/001-Learning to Rank/hotel_ranking.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


  <h1>Hotel ranking</h1>

<h2 id="hotel-search-ranking-system">Hotel Search Ranking System<a class="headerlink" href="#hotel-search-ranking-system" title="Permanent link">&para;</a></h2>
<h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h2>
<h2 id="ota-business-nature">OTA Business Nature<a class="headerlink" href="#ota-business-nature" title="Permanent link">&para;</a></h2>
<p>OTA Company has two business models : </p>
<ul>
<li>Merchant Model </li>
</ul>
<p>The company own what they sell. They have some flexibility in changing price. Their Revenues mostly from profit margin. </p>
<ul>
<li>Agency Model </li>
</ul>
<p>More like broker. Revenue from commision and fees. </p>
<p>Some of OTA Company which apply  <strong>Merchant Model</strong> : 
- KAI 
- AirAsia 
- etc </p>
<p>Some of OTA Company which apply <strong>Agency Model</strong> : 
- AirBnB
- Booking.com 
- Expedia
- Traveloka
- Tiket.com</p>
<p>Let say there is OTA company , you can name <code>T.LLC</code>
The problem is that : 
- The Conversion has dropped 10% from last month </p>
<p>As data scientist we should help business teams to fix the issue </p>
<p>After some analysis for example session replay + interview with product manager they said the customer does not convert when the recommendation show</p>
<p>There are several touchpoint of consumer conversion : 
1. Home Feed Recommendation 
2. Search Feature </p>
<p>To provide which one to prioritize we should check the data where most of the conversion take place. Via Home Feed Recommendation or Search Feature. </p>
<p>There is distinction between homefeed and search result. People which go to the search bar has already have intent to find hotel. Hypothetically the coversion should be bigger in search. </p>
<p>Hence solving bigger portion cover bigger problem. </p>
<h2 id="objectives">Objectives<a class="headerlink" href="#objectives" title="Permanent link">&para;</a></h2>
<p>Our objectives is to build ranking system / services that satisfy both business and ml objectives</p>
<h3 id="business-objective">Business Objective<a class="headerlink" href="#business-objective" title="Permanent link">&para;</a></h3>
<p>After all this ML Approach is initiative that aim to solve / optimize business metrics. </p>
<p>What type of metrics we are going to optimize ? </p>
<p>We need to know what is our business models. Its commision based model. </p>
<ul>
<li>
<p>If number of bookings increase &rarr; company income increase </p>
</li>
<li>
<p>So number of bookings right ? Why dont use conversion. </p>
</li>
</ul>
<p>Of course we can. But we are not using conversion because it can be mislead if we dont mention the numerator </p>
<p><strong>Metrics</strong> : Total Bookings Increase by 20%</p>
<p><span class="arithmatex">\(\textbf{Total Booking} = \text{Number of bookings from search activity}\)</span></p>
<h3 id="ml-objective">ML Objective<a class="headerlink" href="#ml-objective" title="Permanent link">&para;</a></h3>
<p>Its about what you expect from your ML System. </p>
<p><em>Model Wise</em> : 
Model Performance : 
1. Can Beat Baseline Model in terms of NDCG (Previously 0.30)</p>
<p><em>Model Serving</em> : 
1. Max Latency 500ms 
- Search Experience is time sensitive
- A company like google already estimated that they apps latency increase by 100ms it affects to their revenue </p>
<h2 id="user-flow">User Flow<a class="headerlink" href="#user-flow" title="Permanent link">&para;</a></h2>
<p>It's Important to Understand User Flow </p>
<pre class="mermaid"><code>
flowchart TD
    A(Customer Enter Keyword) --&gt; B(Add Query Parameter)
    B --&gt; C(Customer Sent Search Request)
    C --&gt; D(Customer Receive Search / Ranking Result)
    D --&gt; |if interesting|E(Click)
    D --&gt; | if not interesting |F(Skip / Scroll)
    E --&gt; | if match |G(Book)
</code></pre>
<h2 id="system-design">System Design<a class="headerlink" href="#system-design" title="Permanent link">&para;</a></h2>
<pre class="mermaid"><code>
flowchart TD
    A[User Query] --&gt; B[Query Understanding Model]
    B --&gt; C[Retrieval Generation Model]
    C --&gt; D[Ranker Model] 
    D --&gt; E[Re Ranker Model]
</code></pre>
<p>In <a href="https://eugeneyan.com/writing/system-design-for-discovery/">Eugene Yan's Blog Post</a> Some Common System Design for Search and Recommendation could be decomposed into two components : </p>
<ul>
<li>Retrieval / Candidate Generation </li>
</ul>
<p>Job : Filtering Out many items from 10.000 items to 1.000 items for example</p>
<ul>
<li>Ranking Stage </li>
</ul>
<p>Job : Ordering the rank , this is the heavy duty job. </p>
<p>Does all the the system design for search and recommender system should contain both ? No. Its depend on number of item you have in catalogue. </p>
<p>The concern on this article is to highlight on <strong>Ranker Model</strong> Part</p>
<h2 id="model-development">Model Development<a class="headerlink" href="#model-development" title="Permanent link">&para;</a></h2>
<h3 id="problem-formulation">Problem Formulation<a class="headerlink" href="#problem-formulation" title="Permanent link">&para;</a></h3>
<p>Given User Query give ordered list of hotels that maximized chance user will book the hotel </p>
<h3 id="solution-1-no-model-approach">Solution 1 : No Model Approach<a class="headerlink" href="#solution-1-no-model-approach" title="Permanent link">&para;</a></h3>
<p>The first stage is no ML at all. because if we just launch a product / company we dont have enough data, hence we can use simple heuristic such as : 
1. Sort by Name 
2. Sort by Price 
3. Ranking Randomly</p>
<p>The goal is to obtain enough data to collect data to move on to the next step </p>
<h3 id="solution-2-modelling-approach">Solution 2 : Modelling Approach<a class="headerlink" href="#solution-2-modelling-approach" title="Permanent link">&para;</a></h3>
<p>Our end task is ranking or to create ordering. </p>
<p>Now let's do some first principle breakdown : </p>
<p><code>How can we create ranking</code> : </p>
<ol>
<li>Predict the score of each item</li>
<li>Then Order the item based on the score </li>
</ol>
<p>To produce the score is straight forward, to produce the ordering we want each item to be different in score not in discrete. </p>
<p>For example we could use predicted probability or ranking as starter. </p>
<p><img src="https://lucidworks.com/wp-content/uploads/2019/11/list_wise_lucidworks-1024x527.png">
<a href="https://lucidworks.com/wp-content/uploads/2019/11/list_wise_lucidworks-1024x527.png">Source : LucidWorks</a></p>
<h2 id="data-description">Data Description<a class="headerlink" href="#data-description" title="Permanent link">&para;</a></h2>
<h3 id="data-source">Data Source<a class="headerlink" href="#data-source" title="Permanent link">&para;</a></h3>
<p>The Data is obtained from <a href="https://www.kaggle.com/c/expedia-personalized-sort">Personalize Expedia Hotel Searches - ICDM 2013 Kaggle Competition</a></p>
<p>So in ml based solution it requires data. What type of Information we show. Air BnB in their <a href="https://medium.com/airbnb-engineering/machine-learning-powered-search-ranking-of-airbnb-experiences-110b4b1a0789">Article</a>  can classify the feature as : 
1. Hotels / Listing Feature
2. User / Personalized Features 
3. Query Features  </p>
<p>Here is the idea : </p>
<ol>
<li>If we use Hotel Features Only &rarr; it can produce ranking but we cannot expect variation in user level. If we compare recommendation of two users. Say A and B the recommendation would be the same. </li>
<li>To add more personalization we can add feature that unique to user level </li>
<li>To what extend its unique, if user characteristics does not change then the recommendation would be the same. However that is not ideal because user intention may be different at different search session </li>
</ol>
<p>We classify the dataset into 3 domain : 
1. Hotels / Listing Feature
2. User / Personalized Features 
3. Query Features  </p>
<h3 id="listing-hotel-features">Listing / Hotel Features<a class="headerlink" href="#listing-hotel-features" title="Permanent link">&para;</a></h3>
<ul>
<li>It could be feature that describe facility , for example : <ul>
<li>Number of rooms available between dates </li>
<li>Price </li>
<li>Location </li>
<li>etc </li>
</ul>
</li>
<li>For now there are lot of companies using embeddings to express the feature of an entity </li>
<li>Usually embeddings are resulted from pretrained model (neural nets for example)</li>
</ul>
<p>There are lot of variables that classify as Listing / Property Features, however several consideration is that : </p>
<ul>
<li>The feature should survive cold start problem </li>
</ul>
<h3 id="cold-start-problem">Cold Start Problem<a class="headerlink" href="#cold-start-problem" title="Permanent link">&para;</a></h3>
<p>Why we care about new item / new user ? </p>
<p><strong>New Item / Property</strong> </p>
<ul>
<li>It affects revenue of property, </li>
<li>We want our search / recommendation is fair towards property </li>
</ul>
<p><strong>New User</strong> : 
- Help user build interaction 
- Have great search experience by providing relevant property </p>
<p>To properly handle the cold start problem, we research on how to handle it. To do so , we survey several reference (cited in References Section)
We can divide solution into : </p>
<ul>
<li>
<p>Feature Based  Solution  : </p>
</li>
<li>
<p>Add Feature that are robust to Cold Start Feature , for example : </p>
<ul>
<li>User Demographic Features e.g. Age, Gender , etc</li>
<li>Listing Demographic Features e.g. price, lot size , facilities, etc </li>
</ul>
</li>
<li>
<p>Fill Default Values from Local / Geographic </p>
</li>
<li>
<p>Estimate Property Features from Similar Property (AirBnB)</p>
</li>
<li>
<p>Estimate Property Engagement Features (AirBnB)</p>
</li>
<li>
<p>Model Based Solution : </p>
<ul>
<li>Develop 2 Model for User : </li>
<li>New User 
     Need to define what is new user, for example, new user could be user that has not booked any property </li>
<li>Old User </li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Description</th>
<th>Cold Start</th>
<th>Cold Start Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prop_id</code></td>
<td>Int</td>
<td>Hotel property identifier</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>prop_starrating</code></td>
<td>Float</td>
<td>Hotel star rating</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>prop_log_historical_price</code></td>
<td>Float</td>
<td>Log Historical Price</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>price_usd</code></td>
<td>Float</td>
<td>Display price in USD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>promotion_flag</code></td>
<td>Bool</td>
<td>1 if the hotel was under promotion</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">PROPERTY_FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;prop_starrating&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;price_usd&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prop_log_historical_price&#39;</span><span class="p">,</span>
    <span class="s1">&#39;promotion_flag&#39;</span>
<span class="p">]</span> 
</code></pre></div>
<h3 id="user-personal-features">User Personal Features<a class="headerlink" href="#user-personal-features" title="Permanent link">&para;</a></h3>
<p>More Like User Preferences (Could be Implicit or Explicit), Past Bookings(If Available) for examples : 
- Past Bookings (1w,1month,3month,etc)
- Average Stay 
- etc </p>
<p>Okay, you might say what would happen if user is new ? AirBnB in their paper build separate model for login user and logout user. We could categorize new user as logout user due to the fact that the data is not available enough </p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>visitor_location_country_id</code></td>
<td>Int</td>
<td>Customer’s country ID</td>
</tr>
<tr>
<td><code>visitor_hist_starrating</code></td>
<td>Float</td>
<td>User’s historical average hotel star‑rating</td>
</tr>
<tr>
<td><code>visitor_hist_adr_usd</code></td>
<td>Float</td>
<td>User’s historical average daily rate (USD)</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">USER_FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;visitor_hist_starrating&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;visitor_hist_adr_usd&#39;</span>
<span class="p">]</span> 
</code></pre></div>
<h3 id="search-features">Search Features<a class="headerlink" href="#search-features" title="Permanent link">&para;</a></h3>
<p>What does Query Features Mean ? <a href="https://medium.com/airbnb-engineering/embedding-based-retrieval-for-airbnb-search-aabebfc85839">article</a>
Features that describe criteria for hotels we are looking for , for example : 
- Number of guests 
- Number of Stay 
- etc </p>
<p>The same goes with expedia in their <a href="https://medium.com/expedia-group-tech/learning-to-rank-at-expedia-group-how-to-adapt-the-property-search-result-page-based-on-f4ebef78c94b">article</a></p>
<p>which include : 
- checkin_date 
- checkout_date </p>
<ul>
<li>We could also  represent this as embedding</li>
</ul>
<p>Here is the feature definition from dataset</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>srch_destination_id</code></td>
<td>Int</td>
<td>Destination ID for the search</td>
</tr>
<tr>
<td><code>srch_length_of_stay</code></td>
<td>Int</td>
<td>Number of nights (check‑out minus check‑in)</td>
</tr>
<tr>
<td><code>srch_adults_count</code></td>
<td>Int</td>
<td>Number of adults</td>
</tr>
<tr>
<td><code>srch_children_count</code></td>
<td>Int</td>
<td>Number of children</td>
</tr>
<tr>
<td><code>srch_room_count</code></td>
<td>Int</td>
<td>Number of rooms</td>
</tr>
<tr>
<td><code>srch_saturday_night_bool</code></td>
<td>Bool</td>
<td>1 if stay includes a Saturday night</td>
</tr>
<tr>
<td><code>orig_destination_distance</code></td>
<td>Float</td>
<td>Distance between user and hotel (km)</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">SEARCH_FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;srch_length_of_stay&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;srch_adults_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;srch_room_count&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;srch_saturday_night_bool&#39;</span><span class="p">,</span>
    <span class="s1">&#39;orig_destination_distance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;search_rank&#39;</span> <span class="c1"># need to be generated </span>
<span class="p">]</span> 
</code></pre></div>
<h3 id="click-log">Click Log<a class="headerlink" href="#click-log" title="Permanent link">&para;</a></h3>
<p>Last but not least we need the data from search activity the purpose is to train model to maximize the chance of booking happened.  The search process happen in whats called as <strong>Session</strong>. Each User can have multiple session </p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>click_bool</code></td>
<td>Bool</td>
<td>1 if the listing was clicked</td>
</tr>
<tr>
<td><code>booking_bool</code></td>
<td>Bool</td>
<td>1 if the listing was booked</td>
</tr>
</tbody>
</table>
<h2 id="load-data">Load Data<a class="headerlink" href="#load-data" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span> 


<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-pastel&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Due to the huge size of original data, we decide to sample the data based on  search id. We sampled only 50% of search data resulting 1.3 GB of data. </p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;expedia_search_sampled.csv&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div style="overflow-x:scroll">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>srch_id</th>
      <th>date_time</th>
      <th>site_id</th>
      <th>visitor_location_country_id</th>
      <th>visitor_hist_starrating</th>
      <th>visitor_hist_adr_usd</th>
      <th>prop_country_id</th>
      <th>prop_id</th>
      <th>prop_starrating</th>
      <th>prop_review_score</th>
      <th>...</th>
      <th>comp6_rate_percent_diff</th>
      <th>comp7_rate</th>
      <th>comp7_inv</th>
      <th>comp7_rate_percent_diff</th>
      <th>comp8_rate</th>
      <th>comp8_inv</th>
      <th>comp8_rate_percent_diff</th>
      <th>click_bool</th>
      <th>gross_bookings_usd</th>
      <th>booking_bool</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>2012-12-31 08:59:22</td>
      <td>5</td>
      <td>219</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>219</td>
      <td>3625</td>
      <td>4</td>
      <td>4.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4</td>
      <td>2012-12-31 08:59:22</td>
      <td>5</td>
      <td>219</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>219</td>
      <td>11622</td>
      <td>4</td>
      <td>4.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4</td>
      <td>2012-12-31 08:59:22</td>
      <td>5</td>
      <td>219</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>219</td>
      <td>11826</td>
      <td>5</td>
      <td>4.5</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>2012-12-31 08:59:22</td>
      <td>5</td>
      <td>219</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>219</td>
      <td>22824</td>
      <td>3</td>
      <td>4.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>2012-12-31 08:59:22</td>
      <td>5</td>
      <td>219</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>219</td>
      <td>37581</td>
      <td>5</td>
      <td>4.5</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 54 columns</p>
</div>

<h3 id="generate-event">Generate Event<a class="headerlink" href="#generate-event" title="Permanent link">&para;</a></h3>
<p>What the data should look ? </p>
<h2 id="generate-event_1">Generate Event<a class="headerlink" href="#generate-event_1" title="Permanent link">&para;</a></h2>
<p>What the data should look like:</p>
<table>
<thead>
<tr>
<th style="text-align: center;">search_session_id</th>
<th style="text-align: center;">listing_id</th>
<th style="text-align: center;">event_time</th>
<th style="text-align: center;">event_type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3914</td>
<td style="text-align: center;">2022-10-01 17:04:19</td>
<td style="text-align: center;">click</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3352</td>
<td style="text-align: center;">2022-10-01 17:04:30</td>
<td style="text-align: center;">click</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2575</td>
<td style="text-align: center;">2022-10-01 17:04:36</td>
<td style="text-align: center;">click</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">4257</td>
<td style="text-align: center;">2022-10-01 17:04:46</td>
<td style="text-align: center;">click</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3071</td>
<td style="text-align: center;">2022-10-01 17:05:03</td>
<td style="text-align: center;">click</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1757</td>
<td style="text-align: center;">2022-10-01 17:05:22</td>
<td style="text-align: center;">click</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1828</td>
<td style="text-align: center;">2022-10-01 17:05:34</td>
<td style="text-align: center;">scroll</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">3492</td>
<td style="text-align: center;">2022-10-01 17:05:53</td>
<td style="text-align: center;">click</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>Each unique session : </p>
</li>
<li>
<p>occur at a particular time </p>
</li>
<li>has n interactions </li>
<li>the interactions should be ordered chronologically </li>
</ul>
<p>We should order the data first , based on : 
- search session 
- event time </p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span> 
    <span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="s1">&#39;date_time&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<div >
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>srch_id</th>
      <th>date_time</th>
      <th>site_id</th>
      <th>visitor_location_country_id</th>
      <th>visitor_hist_starrating</th>
      <th>visitor_hist_adr_usd</th>
      <th>prop_country_id</th>
      <th>prop_id</th>
      <th>prop_starrating</th>
      <th>prop_review_score</th>
      <th>...</th>
      <th>comp6_rate_percent_diff</th>
      <th>comp7_rate</th>
      <th>comp7_inv</th>
      <th>comp7_rate_percent_diff</th>
      <th>comp8_rate</th>
      <th>comp8_inv</th>
      <th>comp8_rate_percent_diff</th>
      <th>click_bool</th>
      <th>gross_bookings_usd</th>
      <th>booking_bool</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>2012-12-31 08:59:22</td>
      <td>5</td>
      <td>219</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>219</td>
      <td>3625</td>
      <td>4</td>
      <td>4.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4</td>
      <td>2012-12-31 08:59:22</td>
      <td>5</td>
      <td>219</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>219</td>
      <td>11622</td>
      <td>4</td>
      <td>4.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 54 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="n">session_id</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">sample_session</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">session_id</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;date_time&#39;</span><span class="p">,</span><span class="s1">&#39;prop_id&#39;</span><span class="p">,</span><span class="s1">&#39;click_bool&#39;</span><span class="p">,</span><span class="s1">&#39;booking_bool&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">sample_session</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_time</th>
      <th>prop_id</th>
      <th>click_bool</th>
      <th>booking_bool</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2012-12-31 08:59:22</td>
      <td>3625</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2012-12-31 08:59:22</td>
      <td>11622</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2012-12-31 08:59:22</td>
      <td>11826</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2012-12-31 08:59:22</td>
      <td>22824</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2012-12-31 08:59:22</td>
      <td>37581</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2012-12-31 08:59:22</td>
      <td>39993</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2012-12-31 08:59:22</td>
      <td>46162</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2012-12-31 08:59:22</td>
      <td>49152</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2012-12-31 08:59:22</td>
      <td>56063</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2012-12-31 08:59:22</td>
      <td>56472</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2012-12-31 08:59:22</td>
      <td>58696</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2012-12-31 08:59:22</td>
      <td>64344</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2012-12-31 08:59:22</td>
      <td>65984</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2012-12-31 08:59:22</td>
      <td>71258</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2012-12-31 08:59:22</td>
      <td>75491</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2012-12-31 08:59:22</td>
      <td>81172</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2012-12-31 08:59:22</td>
      <td>83045</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2012-12-31 08:59:22</td>
      <td>83430</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2012-12-31 08:59:22</td>
      <td>83806</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2012-12-31 08:59:22</td>
      <td>85567</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2012-12-31 08:59:22</td>
      <td>85742</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2012-12-31 08:59:22</td>
      <td>89119</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2012-12-31 08:59:22</td>
      <td>97099</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2012-12-31 08:59:22</td>
      <td>109185</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2012-12-31 08:59:22</td>
      <td>110813</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2012-12-31 08:59:22</td>
      <td>116696</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2012-12-31 08:59:22</td>
      <td>125069</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2012-12-31 08:59:22</td>
      <td>127808</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2012-12-31 08:59:22</td>
      <td>129278</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2012-12-31 08:59:22</td>
      <td>134162</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2012-12-31 08:59:22</td>
      <td>137826</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2012-12-31 08:59:22</td>
      <td>139893</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<p>What we can infer or how to read the dataset ? </p>
<ul>
<li>a user in a search session scrolled from <code>prop_id=3625</code> and clicked at <code>prop_id=139893</code>. However the user did not end up booking the property.</li>
</ul>
<p>Our dataset is not look like what we are expected its because the click and bookings are still in different columns hence we need to make single column responsible for managing event_type</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_event</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">:</span> 
    <span class="c1"># if booking = 1 --&gt; event_type --&gt; &#39;booked&#39; </span>
    <span class="c1"># if click == 1 --&gt; event_type --&gt; &#39;clicked&#39; </span>
    <span class="c1"># else : --&gt; &#39;scrolled&#39;</span>

    <span class="k">if</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;booking_bool&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span> 
        <span class="k">return</span> <span class="s1">&#39;booked&#39;</span>
    <span class="k">elif</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;click_bool&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span> 
        <span class="k">return</span> <span class="s1">&#39;clicked&#39;</span>
    <span class="k">else</span> <span class="p">:</span> 
        <span class="k">return</span> <span class="s1">&#39;scrolled&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">generate_event</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>Okay, next sanity check </p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([&#39;scrolled&#39;, &#39;clicked&#39;, &#39;booked&#39;], dtype=object)
</code></pre></div>
<p>no missing values, meaning successfully mapped</p>
<div class="highlight"><pre><span></span><code><span class="n">sample_session</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">session_id</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;date_time&#39;</span><span class="p">,</span><span class="s1">&#39;prop_id&#39;</span><span class="p">,</span><span class="s1">&#39;click_bool&#39;</span><span class="p">,</span><span class="s1">&#39;booking_bool&#39;</span><span class="p">,</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">sample_session</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_time</th>
      <th>prop_id</th>
      <th>click_bool</th>
      <th>booking_bool</th>
      <th>event</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2012-12-31 08:59:22</td>
      <td>3625</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2012-12-31 08:59:22</td>
      <td>11622</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2012-12-31 08:59:22</td>
      <td>11826</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2012-12-31 08:59:22</td>
      <td>22824</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2012-12-31 08:59:22</td>
      <td>37581</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2012-12-31 08:59:22</td>
      <td>39993</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2012-12-31 08:59:22</td>
      <td>46162</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2012-12-31 08:59:22</td>
      <td>49152</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2012-12-31 08:59:22</td>
      <td>56063</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2012-12-31 08:59:22</td>
      <td>56472</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2012-12-31 08:59:22</td>
      <td>58696</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2012-12-31 08:59:22</td>
      <td>64344</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2012-12-31 08:59:22</td>
      <td>65984</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2012-12-31 08:59:22</td>
      <td>71258</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2012-12-31 08:59:22</td>
      <td>75491</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2012-12-31 08:59:22</td>
      <td>81172</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2012-12-31 08:59:22</td>
      <td>83045</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2012-12-31 08:59:22</td>
      <td>83430</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2012-12-31 08:59:22</td>
      <td>83806</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2012-12-31 08:59:22</td>
      <td>85567</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2012-12-31 08:59:22</td>
      <td>85742</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2012-12-31 08:59:22</td>
      <td>89119</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2012-12-31 08:59:22</td>
      <td>97099</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2012-12-31 08:59:22</td>
      <td>109185</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2012-12-31 08:59:22</td>
      <td>110813</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2012-12-31 08:59:22</td>
      <td>116696</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2012-12-31 08:59:22</td>
      <td>125069</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2012-12-31 08:59:22</td>
      <td>127808</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2012-12-31 08:59:22</td>
      <td>129278</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2012-12-31 08:59:22</td>
      <td>134162</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2012-12-31 08:59:22</td>
      <td>137826</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2012-12-31 08:59:22</td>
      <td>139893</td>
      <td>1</td>
      <td>0</td>
      <td>clicked</td>
    </tr>
  </tbody>
</table>
</div>

<p>Okay the result correct, next we should check on the session that is in booking</p>
<div class="highlight"><pre><span></span><code><span class="n">booked_session_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;booking_bool&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">,</span><span class="s1">&#39;srch_id&#39;</span>
<span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sample of Booked Session, srch_id = &#39;</span><span class="p">,</span><span class="n">booked_session_id</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Sample of Booked Session, srch_id =  8
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">booked_session</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">booked_session_id</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;date_time&#39;</span><span class="p">,</span><span class="s1">&#39;prop_id&#39;</span><span class="p">,</span><span class="s1">&#39;click_bool&#39;</span><span class="p">,</span><span class="s1">&#39;booking_bool&#39;</span><span class="p">,</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">booked_session</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_time</th>
      <th>prop_id</th>
      <th>click_bool</th>
      <th>booking_bool</th>
      <th>event</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>32</th>
      <td>2013-03-20 17:50:44</td>
      <td>10250</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>33</th>
      <td>2013-03-20 17:50:44</td>
      <td>13252</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>34</th>
      <td>2013-03-20 17:50:44</td>
      <td>22756</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>35</th>
      <td>2013-03-20 17:50:44</td>
      <td>27669</td>
      <td>1</td>
      <td>1</td>
      <td>booked</td>
    </tr>
    <tr>
      <th>36</th>
      <td>2013-03-20 17:50:44</td>
      <td>30630</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>37</th>
      <td>2013-03-20 17:50:44</td>
      <td>32491</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>38</th>
      <td>2013-03-20 17:50:44</td>
      <td>33805</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>39</th>
      <td>2013-03-20 17:50:44</td>
      <td>35397</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>40</th>
      <td>2013-03-20 17:50:44</td>
      <td>39137</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>41</th>
      <td>2013-03-20 17:50:44</td>
      <td>41497</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>42</th>
      <td>2013-03-20 17:50:44</td>
      <td>54403</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>43</th>
      <td>2013-03-20 17:50:44</td>
      <td>58176</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>44</th>
      <td>2013-03-20 17:50:44</td>
      <td>63511</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>45</th>
      <td>2013-03-20 17:50:44</td>
      <td>66444</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>46</th>
      <td>2013-03-20 17:50:44</td>
      <td>67150</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>47</th>
      <td>2013-03-20 17:50:44</td>
      <td>73738</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>48</th>
      <td>2013-03-20 17:50:44</td>
      <td>83293</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>49</th>
      <td>2013-03-20 17:50:44</td>
      <td>90151</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>50</th>
      <td>2013-03-20 17:50:44</td>
      <td>119302</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>51</th>
      <td>2013-03-20 17:50:44</td>
      <td>125655</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>52</th>
      <td>2013-03-20 17:50:44</td>
      <td>134607</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
  </tbody>
</table>
</div>

<p>Okay, it correctly annotate the <code>booked</code> event . Something interesting is that event after the booked happen the result still appear. We should check if the data also display recommended item but not clicked</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;prop_id&#39;</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;prop_id&#39;</span><span class="p">)</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prop_id</th>
    </tr>
    <tr>
      <th>srch_id</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>144590</th>
      <td>5</td>
    </tr>
    <tr>
      <th>327375</th>
      <td>5</td>
    </tr>
    <tr>
      <th>159295</th>
      <td>5</td>
    </tr>
    <tr>
      <th>474323</th>
      <td>5</td>
    </tr>
    <tr>
      <th>66599</th>
      <td>5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>560306</th>
      <td>37</td>
    </tr>
    <tr>
      <th>60367</th>
      <td>37</td>
    </tr>
    <tr>
      <th>394061</th>
      <td>38</td>
    </tr>
    <tr>
      <th>524634</th>
      <td>38</td>
    </tr>
    <tr>
      <th>597375</th>
      <td>38</td>
    </tr>
  </tbody>
</table>
<p>157267 rows × 1 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="n">display</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span> <span class="o">==</span><span class="mi">144590</span><span class="p">,[</span><span class="s1">&#39;date_time&#39;</span><span class="p">,</span><span class="s1">&#39;prop_id&#39;</span><span class="p">,</span><span class="s1">&#39;click_bool&#39;</span><span class="p">,</span><span class="s1">&#39;booking_bool&#39;</span><span class="p">,</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span> <span class="o">==</span><span class="mi">597375</span><span class="p">,[</span><span class="s1">&#39;date_time&#39;</span><span class="p">,</span><span class="s1">&#39;prop_id&#39;</span><span class="p">,</span><span class="s1">&#39;click_bool&#39;</span><span class="p">,</span><span class="s1">&#39;booking_bool&#39;</span><span class="p">,</span><span class="s1">&#39;event&#39;</span><span class="p">]</span>
<span class="p">])</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_time</th>
      <th>prop_id</th>
      <th>click_bool</th>
      <th>booking_bool</th>
      <th>event</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>847859</th>
      <td>2013-03-24 15:34:50</td>
      <td>34327</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>847860</th>
      <td>2013-03-24 15:34:50</td>
      <td>45505</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>847861</th>
      <td>2013-03-24 15:34:50</td>
      <td>49597</td>
      <td>1</td>
      <td>1</td>
      <td>booked</td>
    </tr>
    <tr>
      <th>847862</th>
      <td>2013-03-24 15:34:50</td>
      <td>61770</td>
      <td>1</td>
      <td>0</td>
      <td>clicked</td>
    </tr>
    <tr>
      <th>847863</th>
      <td>2013-03-24 15:34:50</td>
      <td>79426</td>
      <td>1</td>
      <td>0</td>
      <td>clicked</td>
    </tr>
  </tbody>
</table>
</div>

<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_time</th>
      <th>prop_id</th>
      <th>click_bool</th>
      <th>booking_bool</th>
      <th>event</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3508390</th>
      <td>2013-06-26 22:33:27</td>
      <td>499</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508391</th>
      <td>2013-06-26 22:33:27</td>
      <td>2998</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508392</th>
      <td>2013-06-26 22:33:27</td>
      <td>6268</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508393</th>
      <td>2013-06-26 22:33:27</td>
      <td>21838</td>
      <td>1</td>
      <td>1</td>
      <td>booked</td>
    </tr>
    <tr>
      <th>3508394</th>
      <td>2013-06-26 22:33:27</td>
      <td>26195</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508395</th>
      <td>2013-06-26 22:33:27</td>
      <td>29233</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508396</th>
      <td>2013-06-26 22:33:27</td>
      <td>38587</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508397</th>
      <td>2013-06-26 22:33:27</td>
      <td>40117</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508398</th>
      <td>2013-06-26 22:33:27</td>
      <td>45094</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508399</th>
      <td>2013-06-26 22:33:27</td>
      <td>45834</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508400</th>
      <td>2013-06-26 22:33:27</td>
      <td>62095</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508401</th>
      <td>2013-06-26 22:33:27</td>
      <td>67553</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508402</th>
      <td>2013-06-26 22:33:27</td>
      <td>68293</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508403</th>
      <td>2013-06-26 22:33:27</td>
      <td>71357</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508404</th>
      <td>2013-06-26 22:33:27</td>
      <td>75017</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508405</th>
      <td>2013-06-26 22:33:27</td>
      <td>79474</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508406</th>
      <td>2013-06-26 22:33:27</td>
      <td>82547</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508407</th>
      <td>2013-06-26 22:33:27</td>
      <td>83018</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508408</th>
      <td>2013-06-26 22:33:27</td>
      <td>85294</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508409</th>
      <td>2013-06-26 22:33:27</td>
      <td>86224</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508410</th>
      <td>2013-06-26 22:33:27</td>
      <td>86511</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508411</th>
      <td>2013-06-26 22:33:27</td>
      <td>88144</td>
      <td>1</td>
      <td>0</td>
      <td>clicked</td>
    </tr>
    <tr>
      <th>3508412</th>
      <td>2013-06-26 22:33:27</td>
      <td>91550</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508413</th>
      <td>2013-06-26 22:33:27</td>
      <td>94975</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508414</th>
      <td>2013-06-26 22:33:27</td>
      <td>102111</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508415</th>
      <td>2013-06-26 22:33:27</td>
      <td>102135</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508416</th>
      <td>2013-06-26 22:33:27</td>
      <td>102943</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508417</th>
      <td>2013-06-26 22:33:27</td>
      <td>103972</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508418</th>
      <td>2013-06-26 22:33:27</td>
      <td>104198</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508419</th>
      <td>2013-06-26 22:33:27</td>
      <td>106449</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508420</th>
      <td>2013-06-26 22:33:27</td>
      <td>110143</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508421</th>
      <td>2013-06-26 22:33:27</td>
      <td>117992</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508422</th>
      <td>2013-06-26 22:33:27</td>
      <td>123354</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508423</th>
      <td>2013-06-26 22:33:27</td>
      <td>123978</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508424</th>
      <td>2013-06-26 22:33:27</td>
      <td>124413</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508425</th>
      <td>2013-06-26 22:33:27</td>
      <td>131611</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508426</th>
      <td>2013-06-26 22:33:27</td>
      <td>132136</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
    <tr>
      <th>3508427</th>
      <td>2013-06-26 22:33:27</td>
      <td>139340</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can see number of property in each session is different meaning it fully represent user behaviour in recommendation. If the records only 5 property means user only interact (scroll , click , book ) up to 5<sup>th</sup> position.  Another case is that after booking user still can possibly click item. </p>
<p>Next, what we should do is to calculate <strong>Generate Search Rank</strong></p>
<h3 id="adding-search-rank">Adding Search Rank<a class="headerlink" href="#adding-search-rank" title="Permanent link">&para;</a></h3>
<p>Next step is to create search ranking feature from recommendation to mitigae positional bias </p>
<p>we will add new column <code>search_rank</code> to define ranking result from recommendation. </p>
<p>However we have to sure our data really reflect the ordering from current search system. when outputing search result the rank also should be logged. </p>
<p>The assumption is that : 
- In Company <code>T.LLC</code> System if we jump from 1<sup>st</sup> search result  to 5<sup>th</sup> position the rank 1 to 4 regarded as <code>scroll</code> </p>
<table>
<thead>
<tr>
<th style="text-align: right;">listing_id</th>
<th style="text-align: left;">event_time</th>
<th style="text-align: left;">event_type</th>
<th style="text-align: left;">search rank</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">3914</td>
<td style="text-align: left;">2022-10-01 17:04:19</td>
<td style="text-align: left;">click</td>
<td style="text-align: left;">1</td>
</tr>
<tr>
<td style="text-align: right;">3352</td>
<td style="text-align: left;">2022-10-01 17:04:30</td>
<td style="text-align: left;">click</td>
<td style="text-align: left;">2</td>
</tr>
<tr>
<td style="text-align: right;">2575</td>
<td style="text-align: left;">2022-10-01 17:04:36</td>
<td style="text-align: left;">click</td>
<td style="text-align: left;">3</td>
</tr>
<tr>
<td style="text-align: right;">4257</td>
<td style="text-align: left;">2022-10-01 17:04:46</td>
<td style="text-align: left;">click</td>
<td style="text-align: left;">4</td>
</tr>
<tr>
<td style="text-align: right;">3071</td>
<td style="text-align: left;">2022-10-01 17:05:03</td>
<td style="text-align: left;">click</td>
<td style="text-align: left;">5</td>
</tr>
<tr>
<td style="text-align: right;">1757</td>
<td style="text-align: left;">2022-10-01 17:05:22</td>
<td style="text-align: left;">click</td>
<td style="text-align: left;">6</td>
</tr>
<tr>
<td style="text-align: right;">1828</td>
<td style="text-align: left;">2022-10-01 17:05:34</td>
<td style="text-align: left;">scroll</td>
<td style="text-align: left;">7</td>
</tr>
<tr>
<td style="text-align: right;">3494</td>
<td style="text-align: left;">2022-10-01 17:05:53</td>
<td style="text-align: left;">click</td>
<td style="text-align: left;">8</td>
</tr>
<tr>
<td style="text-align: right;">2341</td>
<td style="text-align: left;">2022-10-01 17:06:05</td>
<td style="text-align: left;">click</td>
<td style="text-align: left;">9</td>
</tr>
<tr>
<td style="text-align: right;">438</td>
<td style="text-align: left;">2022-10-01 17:06:11</td>
<td style="text-align: left;">scroll</td>
<td style="text-align: left;">10</td>
</tr>
<tr>
<td style="text-align: right;">1757</td>
<td style="text-align: left;">2022-10-01 17:06:27</td>
<td style="text-align: left;">book</td>
<td style="text-align: left;">11</td>
</tr>
</tbody>
</table>
<p>Next, we need to create those label </p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;search_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">display</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span> <span class="o">==</span><span class="mi">144590</span><span class="p">,[</span><span class="s1">&#39;date_time&#39;</span><span class="p">,</span><span class="s1">&#39;prop_id&#39;</span><span class="p">,</span><span class="s1">&#39;click_bool&#39;</span><span class="p">,</span><span class="s1">&#39;booking_bool&#39;</span><span class="p">,</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="s1">&#39;search_rank&#39;</span><span class="p">]</span>
<span class="p">])</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date_time</th>
      <th>prop_id</th>
      <th>click_bool</th>
      <th>booking_bool</th>
      <th>event</th>
      <th>search_rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>847859</th>
      <td>2013-03-24 15:34:50</td>
      <td>34327</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
      <td>1</td>
    </tr>
    <tr>
      <th>847860</th>
      <td>2013-03-24 15:34:50</td>
      <td>45505</td>
      <td>0</td>
      <td>0</td>
      <td>scrolled</td>
      <td>2</td>
    </tr>
    <tr>
      <th>847861</th>
      <td>2013-03-24 15:34:50</td>
      <td>49597</td>
      <td>1</td>
      <td>1</td>
      <td>booked</td>
      <td>3</td>
    </tr>
    <tr>
      <th>847862</th>
      <td>2013-03-24 15:34:50</td>
      <td>61770</td>
      <td>1</td>
      <td>0</td>
      <td>clicked</td>
      <td>4</td>
    </tr>
    <tr>
      <th>847863</th>
      <td>2013-03-24 15:34:50</td>
      <td>79426</td>
      <td>1</td>
      <td>0</td>
      <td>clicked</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>

<p>After that we need to create / calculate <strong>Relevance Score</strong></p>
<h3 id="calculate-relevance-score">Calculate Relevance Score<a class="headerlink" href="#calculate-relevance-score" title="Permanent link">&para;</a></h3>
<p>Purpose &rarr; To evaluate how well our search model produce the ordering </p>
<p>The score could be created in a way such that some interaction scored higher. According to original kaggle competition the score for each event type is : </p>
<ul>
<li><code>Book</code> : <code>5</code></li>
<li><code>Click</code> : <code>1</code> </li>
<li><code>Scroll</code> : <code>0</code> </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;relevance_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span>
    <span class="s1">&#39;scrolled&#39;</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">,</span> 
    <span class="s1">&#39;clicked&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">,</span> 
    <span class="s1">&#39;booked&#39;</span>  <span class="p">:</span> <span class="mi">5</span> 
<span class="p">})</span>
</code></pre></div>
<p>Sanity Check </p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;relevance_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>relevance_score
0    3732736
5     108884
1      65565
Name: count, dtype: int64
</code></pre></div>
<h2 id="crafting-training-data">Crafting Training Data<a class="headerlink" href="#crafting-training-data" title="Permanent link">&para;</a></h2>
<p>How to construct training pair : 
- We need to ensure there is book in a query to make sure the model learn the labels / relevance score 
- We need to substract the training pair which does not contain <code>event_type = book</code>. 
- Why ? Some of the learning models work in query level. </p>
<p>Here is a glimpse of how our data would look like</p>
<table>
<thead>
<tr>
<th>srch_id</th>
<th>X (features)</th>
<th>y (relevance score)</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>There are variety of design type to construct dataset. Choosing this method also will affect how model learn : </p>
<ul>
<li>Filter only search id contain at least 1 booking </li>
<li>Not Filtering search id </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># get query id which contain `event==book`</span>
<span class="n">book_session_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;booked&#39;</span><span class="p">,</span><span class="s1">&#39;srch_id&#39;</span>
<span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Before filtering search_id with bookings, Num of search id = &#39;</span><span class="p">,</span><span class="n">dataset</span><span class="o">.</span><span class="n">srch_id</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After filtering search_id with bookings, Num of search id = &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">book_session_id</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Before filtering search_id with bookings, Num of search id =  157267
After filtering search_id with bookings, Num of search id =  108884
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">prev_shape</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span> 
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">book_session_id</span><span class="p">)</span>
<span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Before filtering search_id with bookings, Num of Records = &#39;</span><span class="p">,</span><span class="n">prev_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After filtering search_id with bookings, Num of Records = &#39;</span><span class="p">,</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Before filtering search_id with bookings, Num of Records =  3907185
After filtering search_id with bookings, Num of Records =  2727065
</code></pre></div>
<p>To create training data, we should list all feature combination </p>
<div class="highlight"><pre><span></span><code><span class="n">ALL_FEATURES</span> <span class="o">=</span> <span class="n">USER_FEATURES</span> <span class="o">+</span> <span class="n">PROPERTY_FEATURES</span> <span class="o">+</span> <span class="n">SEARCH_FEATURES</span> 

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Features = &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ALL_FEATURES</span><span class="p">)</span> <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Number of Features =  11
</code></pre></div>
<h3 id="split-data">Split Data<a class="headerlink" href="#split-data" title="Permanent link">&para;</a></h3>
<p>How to split data ? </p>
<p>It depends on ranking metrics. Our ranking metrics compare relevance score in actual vs predicted (from our model). </p>
<p>to obtain actual ranking , we need to obtain to each query. Hence our split process is quite different from random subsetting where we pick random for example 80% of data. </p>
<p>Our split unit is search id </p>
<div class="highlight"><pre><span></span><code><span class="n">book_session_id</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([     8,     25,     28, ..., 665554, 665562, 665574],
      shape=(108884,))
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Split training data into Train and Test Data</span>
<span class="n">train_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">book_session_id</span><span class="p">)))</span>
<span class="n">valid_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">book_session_id</span><span class="p">)))</span>

<span class="n">search_id_train</span> <span class="o">=</span> <span class="n">book_session_id</span><span class="p">[:</span><span class="n">train_idx</span><span class="p">]</span>
<span class="n">search_id_val</span> <span class="o">=</span> <span class="n">book_session_id</span><span class="p">[</span><span class="n">train_idx</span><span class="p">:</span><span class="n">valid_idx</span><span class="p">]</span>
<span class="n">search_id_test</span> <span class="o">=</span> <span class="n">book_session_id</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">:]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Training search_id : &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">search_id_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Validation search_id : &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">search_id_val</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Test search_id : &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">search_id_test</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Number of Training search_id :  87107
Number of Validation search_id :  10888
Number of Test search_id :  10889
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># split X &amp; y </span>
<span class="n">X_train_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_train</span><span class="p">)]</span>
<span class="n">qid_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_train</span><span class="p">),</span>
                          <span class="s1">&#39;srch_id&#39;</span> <span class="p">]</span>


<span class="n">y_train_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_train</span><span class="p">),</span>
                          <span class="s1">&#39;relevance_score&#39;</span><span class="p">]</span>

<span class="n">X_val_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_val</span><span class="p">)]</span>
<span class="n">qid_val</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_val</span><span class="p">),</span>
                          <span class="s1">&#39;srch_id&#39;</span> <span class="p">]</span>
<span class="n">y_val_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_val</span><span class="p">),</span>
                          <span class="s1">&#39;relevance_score&#39;</span><span class="p">]</span>

<span class="n">X_test_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_test</span><span class="p">)]</span>
<span class="n">qid_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_test</span><span class="p">),</span>
                          <span class="s1">&#39;srch_id&#39;</span>  <span class="p">]</span>
<span class="n">y_test_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_test</span><span class="p">),</span>
                          <span class="s1">&#39;relevance_score&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">train_frac</span><span class="p">,</span>
                <span class="n">unique_query_id</span><span class="p">,</span>
                <span class="n">query_col</span><span class="p">,</span>
                <span class="n">relevance_col</span><span class="p">)</span> <span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to split data </span>


<span class="sd">    Returns:</span>
<span class="sd">        _type_: _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># obtain index </span>
    <span class="n">train_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_frac</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_query_id</span><span class="p">)))</span>
    <span class="n">val_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">train_frac</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">valid_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">val_pos</span><span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_query_id</span><span class="p">)))</span> <span class="o">+</span> <span class="n">train_idx</span>


    <span class="c1"># obtain unique query </span>
    <span class="n">query_id_train</span> <span class="o">=</span> <span class="n">unique_query_id</span><span class="p">[:</span><span class="n">train_idx</span><span class="p">]</span>
    <span class="n">query_id_val</span> <span class="o">=</span> <span class="n">unique_query_id</span><span class="p">[</span><span class="n">train_idx</span><span class="p">:</span><span class="n">valid_idx</span><span class="p">]</span>
    <span class="n">query_id_test</span> <span class="o">=</span> <span class="n">unique_query_id</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">:]</span>



    <span class="n">X_train_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_train</span><span class="p">),</span> <span class="p">:</span>  <span class="p">]</span>
    <span class="n">query_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_train</span><span class="p">),</span>
    <span class="n">query_col</span> <span class="p">]</span>

    <span class="n">y_train_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_train</span><span class="p">),</span>
    <span class="n">relevance_col</span><span class="p">]</span>

    <span class="n">X_val_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_val</span><span class="p">),</span>
    <span class="p">:]</span>
    <span class="n">query_val</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_val</span><span class="p">),</span>
    <span class="n">query_col</span> <span class="p">]</span>
    <span class="n">y_val_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_val</span><span class="p">),</span>
    <span class="n">relevance_col</span><span class="p">]</span>

    <span class="n">X_test_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_test</span><span class="p">),</span>
    <span class="p">:]</span>

    <span class="n">query_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_test</span><span class="p">),</span>
    <span class="n">query_col</span> <span class="p">]</span>
    <span class="n">y_test_relevance</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">query_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id_test</span><span class="p">),</span>
    <span class="n">relevance_col</span><span class="p">]</span>

    <span class="n">split</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;train&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">X_train_relevance</span><span class="p">,</span><span class="n">y_train_relevance</span><span class="p">,</span><span class="n">query_train</span><span class="p">),</span>
    <span class="s1">&#39;val&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">X_val_relevance</span><span class="p">,</span><span class="n">y_val_relevance</span><span class="p">,</span><span class="n">query_val</span><span class="p">),</span>
    <span class="s1">&#39;test&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">X_test_relevance</span><span class="p">,</span><span class="n">y_test_relevance</span><span class="p">,</span><span class="n">query_test</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">split</span>
</code></pre></div>
<h3 id="eda">EDA<a class="headerlink" href="#eda" title="Permanent link">&para;</a></h3>
<p>Some EDA wont hurt , right ? </p>
<p>Question / Focus of EDA : </p>
<ul>
<li>Number of event per search activity</li>
<li>Check Position that most booking occur </li>
<li>Check whether there is missing value in each feature </li>
</ul>
<h4 id="number-of-missing-values">Number of Missing Values<a class="headerlink" href="#number-of-missing-values" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">display</span><span class="p">((</span><span class="n">X_train_relevance</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">X_train_relevance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>comp1_rate_percent_diff        0.981806
comp6_rate_percent_diff        0.979394
comp1_rate                     0.976894
comp1_inv                      0.975163
comp4_rate_percent_diff        0.973210
comp7_rate_percent_diff        0.970401
gross_bookings_usd             0.960052
comp6_rate                     0.948188
comp6_inv                      0.943810
comp4_rate                     0.937723
visitor_hist_starrating        0.936747
visitor_hist_adr_usd           0.936399
comp7_rate                     0.932321
comp4_inv                      0.930634
comp7_inv                      0.923850
srch_query_affinity_score      0.921880
comp3_rate_percent_diff        0.896652
comp2_rate_percent_diff        0.880073
comp8_rate_percent_diff        0.865494
comp5_rate_percent_diff        0.820446
comp3_rate                     0.669075
comp3_inv                      0.644406
comp8_rate                     0.584797
comp8_inv                      0.569799
comp2_rate                     0.568846
comp2_inv                      0.546673
comp5_rate                     0.529495
comp5_inv                      0.501489
orig_destination_distance      0.314939
prop_location_score2           0.217862
prop_review_score              0.001281
event                          0.000000
booking_bool                   0.000000
search_rank                    0.000000
click_bool                     0.000000
srch_id                        0.000000
date_time                      0.000000
position                       0.000000
site_id                        0.000000
visitor_location_country_id    0.000000
prop_country_id                0.000000
prop_id                        0.000000
prop_starrating                0.000000
prop_brand_bool                0.000000
prop_location_score1           0.000000
prop_log_historical_price      0.000000
price_usd                      0.000000
random_bool                    0.000000
promotion_flag                 0.000000
srch_destination_id            0.000000
srch_length_of_stay            0.000000
srch_booking_window            0.000000
srch_adults_count              0.000000
srch_children_count            0.000000
srch_room_count                0.000000
srch_saturday_night_bool       0.000000
relevance_score                0.000000
dtype: float64
</code></pre></div>
<p>We can see that most of the user feature is not available, hence we can update the decision not to include the feature. For now we are not interested in imputation technique. you can check other blogs. This article point out the wholistic pipeline of learning to rank in application to OTA search particularly in hotel / property ranking</p>
<h4 id="position-that-most-booking-occur">Position that most booking occur<a class="headerlink" href="#position-that-most-booking-occur" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">bookings_event_train</span> <span class="o">=</span> <span class="n">X_train_relevance</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">X_train_relevance</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;booked&#39;</span>
<span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">bookings_event_train</span><span class="p">,</span>
             <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;search_rank&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;search rank position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Search Position Distribution Where Bookings Occur&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0.5, 1.0, &#39;Search Position Distribution Where Bookings Occur&#39;)
</code></pre></div>
<p><img alt="png" src="hotel_ranking_files/hotel_ranking_105_1.png" /></p>
<p>There is bias in bookings, where most of bookings occur at top position, hence we need to add position as feature </p>
<h4 id="number-of-activity-occur-within-search">Number of Activity Occur Within Search<a class="headerlink" href="#number-of-activity-occur-within-search" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">search_activity_count</span> <span class="o">=</span> <span class="n">X_train_relevance</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
    <span class="s1">&#39;prop_id&#39;</span> <span class="p">:</span> <span class="s1">&#39;count&#39;</span>
<span class="p">})</span>
<span class="n">search_activity_count</span> <span class="o">=</span> <span class="n">search_activity_count</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;prop_id&#39;</span><span class="p">:</span><span class="s1">&#39;event_count&#39;</span><span class="p">})</span>
<span class="n">search_activity_count</span>


<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">search_activity_count</span><span class="p">,</span>
             <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;event_count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Event&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distibution of Number of Event from each search&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0.5, 1.0, &#39;Distibution of Number of Event from each search&#39;)
</code></pre></div>
<p><img alt="png" src="hotel_ranking_files/hotel_ranking_108_1.png" /></p>
<h2 id="training-model">Training Model<a class="headerlink" href="#training-model" title="Permanent link">&para;</a></h2>
<p>Previously we checked some features and we decide to remove some of them. </p>
<div class="highlight"><pre><span></span><code><span class="n">display</span><span class="p">((</span><span class="n">X_train_relevance</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">X_train_relevance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>comp1_rate_percent_diff        0.981806
comp6_rate_percent_diff        0.979394
comp1_rate                     0.976894
comp1_inv                      0.975163
comp4_rate_percent_diff        0.973210
comp7_rate_percent_diff        0.970401
gross_bookings_usd             0.960052
comp6_rate                     0.948188
comp6_inv                      0.943810
comp4_rate                     0.937723
visitor_hist_starrating        0.936747
visitor_hist_adr_usd           0.936399
comp7_rate                     0.932321
comp4_inv                      0.930634
comp7_inv                      0.923850
srch_query_affinity_score      0.921880
comp3_rate_percent_diff        0.896652
comp2_rate_percent_diff        0.880073
comp8_rate_percent_diff        0.865494
comp5_rate_percent_diff        0.820446
comp3_rate                     0.669075
comp3_inv                      0.644406
comp8_rate                     0.584797
comp8_inv                      0.569799
comp2_rate                     0.568846
comp2_inv                      0.546673
comp5_rate                     0.529495
comp5_inv                      0.501489
orig_destination_distance      0.314939
prop_location_score2           0.217862
prop_review_score              0.001281
event                          0.000000
booking_bool                   0.000000
search_rank                    0.000000
click_bool                     0.000000
srch_id                        0.000000
date_time                      0.000000
position                       0.000000
site_id                        0.000000
visitor_location_country_id    0.000000
prop_country_id                0.000000
prop_id                        0.000000
prop_starrating                0.000000
prop_brand_bool                0.000000
prop_location_score1           0.000000
prop_log_historical_price      0.000000
price_usd                      0.000000
random_bool                    0.000000
promotion_flag                 0.000000
srch_destination_id            0.000000
srch_length_of_stay            0.000000
srch_booking_window            0.000000
srch_adults_count              0.000000
srch_children_count            0.000000
srch_room_count                0.000000
srch_saturday_night_bool       0.000000
relevance_score                0.000000
dtype: float64
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">PROPERTY_FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;prop_starrating&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;price_usd&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prop_log_historical_price&#39;</span><span class="p">,</span>
    <span class="s1">&#39;promotion_flag&#39;</span>
<span class="p">]</span> 

<span class="n">SEARCH_FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;srch_length_of_stay&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;srch_adults_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;srch_booking_window&#39;</span><span class="p">,</span>
    <span class="s1">&#39;srch_room_count&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;srch_saturday_night_bool&#39;</span><span class="p">,</span>
<span class="p">]</span> 

<span class="n">POSITIONAL_FEATURES</span> <span class="o">=</span> <span class="p">[</span> 
    <span class="s1">&#39;search_rank&#39;</span>
<span class="p">]</span>

<span class="n">ALL_FEATURES</span> <span class="o">=</span> <span class="n">PROPERTY_FEATURES</span> <span class="o">+</span> <span class="n">SEARCH_FEATURES</span> <span class="o">+</span> <span class="n">POSITIONAL_FEATURES</span>
</code></pre></div>
<h3 id="pointwise-model">Pointwise Model<a class="headerlink" href="#pointwise-model" title="Permanent link">&para;</a></h3>
<p>We can train model to predict directly relevance score, but only minimizing error on relevance score prediction. We dont need the query id information since we are not performing swapping. </p>
<p>For example we could use Regression as <strong>LinearRegression</strong> and <strong>RandomForest</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span> 


<span class="n">lr_pointwise</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rf_pointwise</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                     <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                     <span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># random state control the bootstrapping process </span>


<span class="c1"># train model </span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training Linear Regression&#39;</span><span class="p">)</span>
<span class="n">lr_pointwise</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_relevance</span><span class="p">[</span><span class="n">ALL_FEATURES</span><span class="p">],</span><span class="n">y_train_relevance</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training Random Forest&#39;</span><span class="p">)</span>
<span class="n">rf_pointwise</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_relevance</span><span class="p">[</span><span class="n">ALL_FEATURES</span><span class="p">],</span><span class="n">y_train_relevance</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Training Linear Regression
Training Random Forest
building tree 1 of 100
building tree 2 of 100
building tree 3 of 100
building tree 4 of 100
building tree 5 of 100
building tree 6 of 100
building tree 7 of 100
building tree 8 of 100


[Parallel(n_jobs=-1)]: Using backend ThreadingBackend with 8 concurrent workers.


building tree 9 of 100
building tree 10 of 100
building tree 11 of 100
building tree 12 of 100
building tree 13 of 100
building tree 14 of 100
building tree 15 of 100
building tree 16 of 100
building tree 17 of 100
building tree 18 of 100
building tree 19 of 100
building tree 20 of 100
building tree 21 of 100
building tree 22 of 100
building tree 23 of 100
building tree 24 of 100


[Parallel(n_jobs=-1)]: Done  16 tasks      | elapsed:   32.3s


building tree 25 of 100
building tree 26 of 100
building tree 27 of 100
building tree 28 of 100
building tree 29 of 100
building tree 30 of 100
building tree 31 of 100
building tree 32 of 100
building tree 33 of 100
building tree 34 of 100
building tree 35 of 100
building tree 36 of 100
building tree 37 of 100
building tree 38 of 100
building tree 39 of 100
building tree 40 of 100
building tree 41 of 100
building tree 42 of 100
building tree 43 of 100
building tree 44 of 100
building tree 45 of 100
building tree 46 of 100
building tree 47 of 100
building tree 48 of 100
building tree 49 of 100
building tree 50 of 100
building tree 51 of 100
building tree 52 of 100
building tree 53 of 100
building tree 54 of 100
building tree 55 of 100
building tree 56 of 100
building tree 57 of 100
building tree 58 of 100
building tree 59 of 100
building tree 60 of 100
building tree 61 of 100
building tree 62 of 100
building tree 63 of 100
building tree 64 of 100
building tree 65 of 100
building tree 66 of 100
building tree 67 of 100
building tree 68 of 100
building tree 69 of 100
building tree 70 of 100
building tree 71 of 100
building tree 72 of 100
building tree 73 of 100
building tree 74 of 100
building tree 75 of 100
building tree 76 of 100
building tree 77 of 100
building tree 78 of 100
building tree 79 of 100
building tree 80 of 100
building tree 81 of 100
building tree 82 of 100
building tree 83 of 100
building tree 84 of 100
building tree 85 of 100
building tree 86 of 100
building tree 87 of 100
building tree 88 of 100
building tree 89 of 100
building tree 90 of 100
building tree 91 of 100
building tree 92 of 100
building tree 93 of 100
building tree 94 of 100
building tree 95 of 100
building tree 96 of 100
building tree 97 of 100
building tree 98 of 100
building tree 99 of 100
building tree 100 of 100


[Parallel(n_jobs=-1)]: Done 100 out of 100 | elapsed:  3.4min finished
</code></pre></div>
<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style>
<div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>RandomForestRegressor(n_jobs=-1, random_state=2, verbose=3)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div style="overflow-x:scroll;"><div style="overflow-x:scroll;">RandomForestRegressor</div></div><div style="overflow-x:scroll;"><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.ensemble.RandomForestRegressor.html">?<span>Documentation for RandomForestRegressor</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted"><pre>RandomForestRegressor(n_jobs=-1, random_state=2, verbose=3)</pre></div> </div></div></div></div>

<h3 id="pairwise-model">Pairwise Model<a class="headerlink" href="#pairwise-model" title="Permanent link">&para;</a></h3>
<p>There are lot of model that are used objective to maximize pairwise learning. </p>
<p>for example let say user A has search in e commerce "shiny bag" and it returns 3 items </p>
<ol>
<li>Item A (click)</li>
<li>Item B (click)</li>
<li>Item C (bought)</li>
</ol>
<p>the idea is that our model should optimize maximizing pairwise objective Item C &gt; Item A and Item C &gt; B </p>
<p>Some of them model that have pairwise objective : 
- RankNet 
- LambdaMART (Logistic Loss / RankNet Loss)</p>
<h4 id="ranknet">RankNet<a class="headerlink" href="#ranknet" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Training Data Construction : </p>
<h2 id="-given-query-result-each-item-in-result-has-relevance-score-depends-on-how-user-interact-for-example-book-should-have-bigger-relevance-score">- Given query result , each item in result has relevance score depends on how user interact (for example book should have bigger relevance score)<a class="headerlink" href="#-given-query-result-each-item-in-result-has-relevance-score-depends-on-how-user-interact-for-example-book-should-have-bigger-relevance-score" title="Permanent link">&para;</a></h2>
</li>
<li>
<p>Objective : </p>
<ul>
<li>
<p><span class="arithmatex">\(P_{i,j} = P(U_i &gt; U_j) = \cfrac{1}{1 + e^{-\sigma(s_i-s_j)}}\)</span></p>
</li>
<li>
<p>Where : </p>
<ul>
<li>$P_{i,j} $ : Probability that item i is scored higher than item j</li>
</ul>
</li>
<li>
<p>In plain words we want our model giving higher score to item that are having higher score. </p>
</li>
<li>
<p>the <span class="arithmatex">\(s_i\)</span> comes from model prediction / output : </p>
</li>
<li>
<p><span class="arithmatex">\(s_i = f(x_i|\theta)\)</span></p>
</li>
<li>
<p>s_i - s_j : </p>
<ul>
<li><span class="arithmatex">\(s_i - s_j = 1 if s_i &gt; s_j\)</span> </li>
<li><span class="arithmatex">\(s_i - s_j = 0 if s_i = s_j\)</span> </li>
<li><span class="arithmatex">\(s_i - s_j = -1 s_i &lt; s_j\)</span></li>
</ul>
</li>
<li>
<p>To obtain optimal parameter <span class="arithmatex">\(\theta\)</span> : </p>
<ul>
<li>Minimizing negative log likelihood from all training data (Similar to Classification)  : <ul>
<li>$$ \mathcal{L} = - \sum_{(i,j) \in \mathcal{P}} \left[
    y_{ij}\,\log \left(\frac{1}{1+\exp\left(-\sigma\,(s_i-s_j)\right)}\right)<ul>
<li>(1-y_{ij})\,\log \left(1 - \frac{1}{1+\exp\left(-\sigma\,(s_i-s_j)\right)}\right)
\right]
$$</li>
</ul>
</li>
<li><span class="arithmatex">\(y_{ij}\)</span> : Pairwise label , 1 if item i &gt; item j </li>
</ul>
</li>
</ul>
</li>
<li>The objective could be solved through gradient descent </li>
</ul>
</li>
<li>
<p>The goal is to learn relevance scoring function. </p>
</li>
</ul>
<h4 id="lambda-rank">Lambda Rank<a class="headerlink" href="#lambda-rank" title="Permanent link">&para;</a></h4>
<ul>
<li>Why  : </li>
<li>Previous Approach does not directly optimize information retrieval metrics such as : NDCG</li>
<li>
<p>NDCG is not convex function. </p>
</li>
<li>
<p>Solution : </p>
</li>
<li>We can optimize the NDCG but with sneaky trick , we can optimize the NDCG by seeing if we switch position between two item (i,j) how the NDCG changes (that similar  to gradient). </li>
</ul>
<p><span class="arithmatex">\(\lambda_{i,j} = \Delta NDCG_{\text{swap}_{i,j}}\)</span></p>
<ul>
<li>After swapping position we can find which item if we swap the position has the biggest change in NDCG, after swapping each query result combination </li>
</ul>
<p>now our task is predicting lambda </p>
<table>
<thead>
<tr>
<th>query_id</th>
<th>X (features)</th>
<th>y (lambda)</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="lambdamart">LambdaMART<a class="headerlink" href="#lambdamart" title="Permanent link">&para;</a></h4>
<ul>
<li>Basically LambdaMART ~ Work the same way as Lambda Rank only that the model in Lambda MART use Decision Tree (Multiple Additive Regression Trees)</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="n">ranker_pairwise</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRanker</span><span class="p">(</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
                                <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                                <span class="n">verbose</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">tree_method</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">,</span> 
                                <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;rank:pairwise&quot;</span><span class="p">)</span>
<span class="n">ranker_pairwise</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_relevance</span><span class="p">[</span><span class="n">ALL_FEATURES</span><span class="p">],</span> <span class="n">y_train_relevance</span><span class="p">,</span><span class="n">qid</span><span class="o">=</span><span class="n">qid_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/Users/sintamulyawati/Documents/rovos/venv/lib/python3.11/site-packages/xgboost/training.py:183: UserWarning: [23:38:21] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:738: 
Parameters: { &quot;verbose&quot; } are not used.

  bst.update(dtrain, iteration=i, fobj=obj)
</code></pre></div>
<style>#sk-container-id-2 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-2 {
  color: var(--sklearn-color-text);
}

#sk-container-id-2 pre {
  padding: 0;
}

#sk-container-id-2 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-2 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-2 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-2 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-2 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-2 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-2 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-2 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-2 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-2 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-2 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-2 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-2 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-2 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-2 div.sk-label label.sk-toggleable__label,
#sk-container-id-2 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-2 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-2 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-2 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-2 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-2 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-2 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-2 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-2 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-2 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style>
<div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>XGBRanker(base_score=None, booster=None, callbacks=None, colsample_bylevel=None,
          colsample_bynode=None, colsample_bytree=None, device=None,
          early_stopping_rounds=None, enable_categorical=False,
          eval_metric=None, feature_types=None, feature_weights=None,
          gamma=None, grow_policy=None, importance_type=None,
          interaction_constraints=None, learning_rate=None, max_bin=None,
          max_cat_threshold=None, max_cat_to_onehot=None, max_delta_step=None,
          max_depth=None, max_leaves=None, min_child_weight=None, missing=nan,
          monotone_constraints=None, multi_strategy=None, n_estimators=500,
          n_jobs=-1, num_parallel_tree=None, ...)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox" checked><label for="sk-estimator-id-2" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div style="overflow-x:scroll;"><div style="overflow-x:scroll;">XGBRanker</div></div><div style="overflow-x:scroll;"><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://xgboost.readthedocs.io/en/release_3.0.0/python/python_api.html#xgboost.XGBRanker">?<span>Documentation for XGBRanker</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted"><pre>XGBRanker(base_score=None, booster=None, callbacks=None, colsample_bylevel=None,
          colsample_bynode=None, colsample_bytree=None, device=None,
          early_stopping_rounds=None, enable_categorical=False,
          eval_metric=None, feature_types=None, feature_weights=None,
          gamma=None, grow_policy=None, importance_type=None,
          interaction_constraints=None, learning_rate=None, max_bin=None,
          max_cat_threshold=None, max_cat_to_onehot=None, max_delta_step=None,
          max_depth=None, max_leaves=None, min_child_weight=None, missing=nan,
          monotone_constraints=None, multi_strategy=None, n_estimators=500,
          n_jobs=-1, num_parallel_tree=None, ...)</pre></div> </div></div></div></div>

<h3 id="listwise-model">Listwise Model<a class="headerlink" href="#listwise-model" title="Permanent link">&para;</a></h3>
<p>Some of them model that have pairwise objective : 
- RankNet 
- LambdaMART (Logistic Loss / RankNet Loss)</p>
<div class="highlight"><pre><span></span><code><span class="n">ranker_listwise</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRanker</span><span class="p">(</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
                                <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
                                <span class="n">tree_method</span><span class="o">=</span><span class="s2">&quot;hist&quot;</span><span class="p">,</span> 
                                <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;rank:ndcg&quot;</span><span class="p">)</span>
<span class="n">ranker_listwise</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_relevance</span><span class="p">[</span><span class="n">ALL_FEATURES</span><span class="p">],</span> <span class="n">y_train_relevance</span><span class="p">,</span><span class="n">qid</span><span class="o">=</span><span class="n">qid_train</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<style>#sk-container-id-3 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-3 {
  color: var(--sklearn-color-text);
}

#sk-container-id-3 pre {
  padding: 0;
}

#sk-container-id-3 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-3 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-3 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-3 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-3 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-3 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-3 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-3 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-3 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-3 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-3 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-3 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-3 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-3 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-3 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-3 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-3 div.sk-label label.sk-toggleable__label,
#sk-container-id-3 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-3 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-3 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-3 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-3 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-3 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-3 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-3 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-3 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-3 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style>
<div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>XGBRanker(base_score=None, booster=None, callbacks=None, colsample_bylevel=None,
          colsample_bynode=None, colsample_bytree=None, device=None,
          early_stopping_rounds=None, enable_categorical=False,
          eval_metric=None, feature_types=None, feature_weights=None,
          gamma=None, grow_policy=None, importance_type=None,
          interaction_constraints=None, learning_rate=None, max_bin=None,
          max_cat_threshold=None, max_cat_to_onehot=None, max_delta_step=None,
          max_depth=None, max_leaves=None, min_child_weight=None, missing=nan,
          monotone_constraints=None, multi_strategy=None, n_estimators=500,
          n_jobs=-1, num_parallel_tree=None, ...)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox" checked><label for="sk-estimator-id-3" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div style="overflow-x:scroll;"><div style="overflow-x:scroll;">XGBRanker</div></div><div style="overflow-x:scroll;"><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://xgboost.readthedocs.io/en/release_3.0.0/python/python_api.html#xgboost.XGBRanker">?<span>Documentation for XGBRanker</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted"><pre>XGBRanker(base_score=None, booster=None, callbacks=None, colsample_bylevel=None,
          colsample_bynode=None, colsample_bytree=None, device=None,
          early_stopping_rounds=None, enable_categorical=False,
          eval_metric=None, feature_types=None, feature_weights=None,
          gamma=None, grow_policy=None, importance_type=None,
          interaction_constraints=None, learning_rate=None, max_bin=None,
          max_cat_threshold=None, max_cat_to_onehot=None, max_delta_step=None,
          max_depth=None, max_leaves=None, min_child_weight=None, missing=nan,
          monotone_constraints=None, multi_strategy=None, n_estimators=500,
          n_jobs=-1, num_parallel_tree=None, ...)</pre></div> </div></div></div></div>

<h3 id="holdout-set-evaluation">Holdout Set Evaluation<a class="headerlink" href="#holdout-set-evaluation" title="Permanent link">&para;</a></h3>
<p>The goal is to check whether model learn or not </p>
<p>There are lot of Ranking / Information Retrieval Metrics. Some of them are : 
We can divide into 
- Binary Relevance Metrics 
    - Precision @ K 
    - Mean Average Precision @ K 
    - Mean Reciprocal Rank </p>
<ul>
<li>Rank Aware Metrics <ul>
<li>Normalized Discounted Cumulative Gain (NDCG)</li>
</ul>
</li>
</ul>
<p>What is Ideal Ranking Metrics ?
- If we predict correctly the relevance score at top position is better than correctly predicting relevance score in lower position. </p>
<h4 id="metrics-ndcg">Metrics : NDCG<a class="headerlink" href="#metrics-ndcg" title="Permanent link">&para;</a></h4>
<p>\begin{align*}\
\begin{split}\
\text{DCG}= \sum_{i=1}^{k} \frac{ 2^{\text{rel}[i]}-1}{\log_{2}([i]+2)} \</p>
<p>\end{split}\
\end{align*}\</p>
<p>Where : 
- <span class="arithmatex">\(\text{DCG}\)</span> = Discounted Cumulative Gain 
- <span class="arithmatex">\(k= \text{number of items in recommendation}\)</span>\
- <span class="arithmatex">\(\text{rel}[i]\)</span> = relevance score at item in position i th
- Relevance score itself usually relevance score based on ground truth </p>
<p>So where is the NDCG ? </p>
<p>Why do we even need NDCG ? the analogy similar to correlation and covariance matrix. We can measure covariance matrix to asses comovement between two Random Variables. However the value is incomparable hence we need to scale to some finite space such as probability score, ranging from 0 to 1 </p>
<p>The Idea of DCG is that position does matter, if our model can predict the highest relevance score at top position is better compared to lower position</p>
<p>In NDCG we can scale the DCG by maximum value of DCG or we call it as <strong>Ideal DCG</strong></p>
<p>\begin{align*}\
\begin{split}\
\text{NDCG}= \frac{\text{DCG}}{\text{Ideal DCG}}\</p>
<p>\end{split}\
\end{align*}\</p>
<p>So what is the ideal DCG in this case ? </p>
<p>There are some flavor, citing Doug TurnBull in His Blogpost , </p>
<ul>
<li>Local Ideal &rarr; Sorted based on ground truth relevance &rarr; </li>
<li>Global Ideal &rarr; using whole score from judgement list as ground truth , the previous one only use the response from search only </li>
<li>Max Label &rarr; Considering each position has maximum score, for example in our case the book event type has relevance of 2. </li>
</ul>
<p>The fact is that if we use Max Label the NDCG Score will decrease, its because the view is pessimistic</p>
<p>for example we will use validation to measure ndcg. </p>
<h4 id="validation-set">Validation Set<a class="headerlink" href="#validation-set" title="Permanent link">&para;</a></h4>
<p>The purpose on this set mainly <strong>selecting model</strong> : 
- Selecting best hyperparameter 
- Selecting approach 
- pipeline etc </p>
<p>We could do through <strong>Cross Validation</strong> which have better estimate of model performance. </p>
<p>In this article we only implement the <strong>Validation Set</strong> approach </p>
<p>We also wont cover <strong>Hyperparameter Tuning</strong> in this article</p>
<p>Next, we should add our model prediction. So, how can we predict ? </p>
<p>First this model focus on ranking, which means, does not focus on <strong>candidate generation step</strong>. Hence the model predict all item in given search id. the model doesnot predict relevance score for all item. </p>
<p>Before we perform prediction we have our positional feature needs to be adjusted , because we dont know the positional features in validation dataset, we can set to the first rank </p>
<div class="highlight"><pre><span></span><code><span class="n">X_val_relevance</span><span class="p">[</span><span class="s1">&#39;search_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/var/folders/zt/dkkszv0n5bd8nq9dywcdj7pc0000gn/T/ipykernel_743/2832532597.py:1: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  X_val_relevance[&#39;search_rank&#39;] = 1
</code></pre></div>
<p><strong>Pointwise</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># pointwise score </span>
<span class="n">y_val_pred_pointwise</span> <span class="o">=</span> <span class="n">rf_pointwise</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val_relevance</span><span class="p">[</span><span class="n">ALL_FEATURES</span><span class="p">])</span>

<span class="c1"># save as separate df which contain </span>
<span class="n">val_prediction_pointwise</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_val</span><span class="p">),</span>
                         <span class="p">[</span><span class="s1">&#39;prop_id&#39;</span> <span class="p">,</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">]]</span>
<span class="n">val_prediction_pointwise</span><span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_val_relevance</span>
<span class="n">val_prediction_pointwise</span><span class="p">[</span><span class="s1">&#39;pred_lambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_val_pred_pointwise</span>


<span class="c1"># sort based on query id and pred_lambda </span>
<span class="n">val_prediction_pointwise</span> <span class="o">=</span> <span class="n">val_prediction_pointwise</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;pred_lambda&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span>
                                                                   <span class="kc">True</span><span class="p">,</span><span class="kc">False</span>
                                                               <span class="p">])</span>
<span class="n">val_prediction_pointwise</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_prediction_pointwise</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">val_prediction_pointwise</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[Parallel(n_jobs=8)]: Using backend ThreadingBackend with 8 concurrent workers.
[Parallel(n_jobs=8)]: Done  16 tasks      | elapsed:    0.3s
[Parallel(n_jobs=8)]: Done 100 out of 100 | elapsed:    1.7s finished
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prop_id</th>
      <th>srch_id</th>
      <th>y_true</th>
      <th>pred_lambda</th>
      <th>rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3123447</th>
      <td>105305</td>
      <td>532288</td>
      <td>5</td>
      <td>1.275</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3123444</th>
      <td>90139</td>
      <td>532288</td>
      <td>0</td>
      <td>0.650</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3123455</th>
      <td>136621</td>
      <td>532288</td>
      <td>0</td>
      <td>0.530</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3123433</th>
      <td>25017</td>
      <td>532288</td>
      <td>0</td>
      <td>0.500</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3123436</th>
      <td>35962</td>
      <td>532288</td>
      <td>0</td>
      <td>0.400</td>
      <td>5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3516328</th>
      <td>53300</td>
      <td>598662</td>
      <td>0</td>
      <td>0.100</td>
      <td>28</td>
    </tr>
    <tr>
      <th>3516344</th>
      <td>107244</td>
      <td>598662</td>
      <td>0</td>
      <td>0.100</td>
      <td>29</td>
    </tr>
    <tr>
      <th>3516327</th>
      <td>48186</td>
      <td>598662</td>
      <td>0</td>
      <td>0.050</td>
      <td>30</td>
    </tr>
    <tr>
      <th>3516341</th>
      <td>101066</td>
      <td>598662</td>
      <td>0</td>
      <td>0.050</td>
      <td>31</td>
    </tr>
    <tr>
      <th>3516340</th>
      <td>96306</td>
      <td>598662</td>
      <td>0</td>
      <td>0.000</td>
      <td>32</td>
    </tr>
  </tbody>
</table>
<p>273242 rows × 5 columns</p>
</div>

<p><strong>Pairwise</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># pairwise score </span>
<span class="n">y_val_pred_pairwise</span> <span class="o">=</span> <span class="n">ranker_pairwise</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val_relevance</span><span class="p">[</span><span class="n">ALL_FEATURES</span><span class="p">])</span>

<span class="c1"># save as separate df which contain </span>
<span class="n">val_prediction_pairwise</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_val</span><span class="p">),</span>
                         <span class="p">[</span><span class="s1">&#39;prop_id&#39;</span> <span class="p">,</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">]]</span>
<span class="n">val_prediction_pairwise</span><span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_val_relevance</span>
<span class="n">val_prediction_pairwise</span><span class="p">[</span><span class="s1">&#39;pred_lambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_val_pred_pairwise</span>


<span class="c1"># sort based on query id and pred_lambda </span>
<span class="n">val_prediction_pairwise</span> <span class="o">=</span> <span class="n">val_prediction_pairwise</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;pred_lambda&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span>
                                                                   <span class="kc">True</span><span class="p">,</span><span class="kc">False</span>
                                                               <span class="p">])</span>
<span class="n">val_prediction_pairwise</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_prediction_pairwise</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">val_prediction_pairwise</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prop_id</th>
      <th>srch_id</th>
      <th>y_true</th>
      <th>pred_lambda</th>
      <th>rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3123433</th>
      <td>25017</td>
      <td>532288</td>
      <td>0</td>
      <td>0.170013</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3123448</th>
      <td>105787</td>
      <td>532288</td>
      <td>0</td>
      <td>0.161488</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3123436</th>
      <td>35962</td>
      <td>532288</td>
      <td>0</td>
      <td>0.082060</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3123454</th>
      <td>136377</td>
      <td>532288</td>
      <td>0</td>
      <td>-0.105323</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3123447</th>
      <td>105305</td>
      <td>532288</td>
      <td>5</td>
      <td>-0.230895</td>
      <td>5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3516343</th>
      <td>104950</td>
      <td>598662</td>
      <td>0</td>
      <td>-0.857398</td>
      <td>28</td>
    </tr>
    <tr>
      <th>3516339</th>
      <td>95810</td>
      <td>598662</td>
      <td>0</td>
      <td>-1.003210</td>
      <td>29</td>
    </tr>
    <tr>
      <th>3516342</th>
      <td>102352</td>
      <td>598662</td>
      <td>0</td>
      <td>-1.123185</td>
      <td>30</td>
    </tr>
    <tr>
      <th>3516341</th>
      <td>101066</td>
      <td>598662</td>
      <td>0</td>
      <td>-1.618251</td>
      <td>31</td>
    </tr>
    <tr>
      <th>3516328</th>
      <td>53300</td>
      <td>598662</td>
      <td>0</td>
      <td>-1.923931</td>
      <td>32</td>
    </tr>
  </tbody>
</table>
<p>273242 rows × 5 columns</p>
</div>

<p><strong>Listwise</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># listwise score </span>
<span class="n">val_prediction_listwise</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">search_id_val</span><span class="p">),</span>
                          <span class="p">[</span><span class="s1">&#39;prop_id&#39;</span> <span class="p">,</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">]]</span>

<span class="n">y_val_pred_listwise</span> <span class="o">=</span> <span class="n">ranker_listwise</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val_relevance</span><span class="p">[</span><span class="n">ALL_FEATURES</span><span class="p">])</span>
<span class="n">val_prediction_listwise</span><span class="p">[</span><span class="s1">&#39;pred_lambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_val_pred_listwise</span>
<span class="n">val_prediction_listwise</span><span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_val_relevance</span>
<span class="c1"># sort based on query id and pred_lambda </span>
<span class="n">val_prediction_listwise</span> <span class="o">=</span> <span class="n">val_prediction_listwise</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;pred_lambda&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span>
                                                                   <span class="kc">True</span><span class="p">,</span><span class="kc">False</span>
                                                               <span class="p">])</span>

<span class="n">val_prediction_listwise</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_prediction_listwise</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">val_prediction_listwise</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prop_id</th>
      <th>srch_id</th>
      <th>pred_lambda</th>
      <th>y_true</th>
      <th>rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3123433</th>
      <td>25017</td>
      <td>532288</td>
      <td>0.144549</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3123436</th>
      <td>35962</td>
      <td>532288</td>
      <td>0.136666</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3123447</th>
      <td>105305</td>
      <td>532288</td>
      <td>-0.069895</td>
      <td>5</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3123451</th>
      <td>111825</td>
      <td>532288</td>
      <td>-0.170109</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3123439</th>
      <td>49185</td>
      <td>532288</td>
      <td>-0.170845</td>
      <td>0</td>
      <td>5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3516349</th>
      <td>120070</td>
      <td>598662</td>
      <td>-0.440107</td>
      <td>0</td>
      <td>28</td>
    </tr>
    <tr>
      <th>3516331</th>
      <td>62444</td>
      <td>598662</td>
      <td>-0.501732</td>
      <td>0</td>
      <td>29</td>
    </tr>
    <tr>
      <th>3516339</th>
      <td>95810</td>
      <td>598662</td>
      <td>-0.638550</td>
      <td>0</td>
      <td>30</td>
    </tr>
    <tr>
      <th>3516328</th>
      <td>53300</td>
      <td>598662</td>
      <td>-0.875726</td>
      <td>0</td>
      <td>31</td>
    </tr>
    <tr>
      <th>3516341</th>
      <td>101066</td>
      <td>598662</td>
      <td>-1.246449</td>
      <td>0</td>
      <td>32</td>
    </tr>
  </tbody>
</table>
<p>273242 rows × 5 columns</p>
</div>

<p>lets make a function to prepare the prediction on ground truth </p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_for_eval</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">,</span><span class="n">query_id</span><span class="p">,</span><span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="n">prop_col</span> <span class="o">=</span> <span class="s1">&#39;prop_id&#39;</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">pred_df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">search_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">query_id</span><span class="p">),</span>
                            <span class="p">[</span><span class="n">prop_col</span> <span class="p">,</span> <span class="n">search_col</span><span class="p">]]</span>

    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">pred_df</span><span class="p">[</span><span class="s1">&#39;pred_lambda&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
    <span class="n">pred_df</span><span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
    <span class="c1"># sort based on query id and pred_lambda </span>
    <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">search_col</span><span class="p">,</span>
                                   <span class="s1">&#39;pred_lambda&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span> <span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
    <span class="n">pred_df</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">search_col</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">pred_df</span>
</code></pre></div>
<p>Simple NDCG Calculation on a query </p>
<div class="highlight"><pre><span></span><code><span class="n">sample_dcg</span> <span class="o">=</span> <span class="n">val_prediction_listwise</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">val_prediction_listwise</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">val_prediction_listwise</span><span class="p">[</span><span class="s1">&#39;srch_id&#39;</span><span class="p">])</span> 
<span class="p">]</span>
</code></pre></div>
<div class="arithmatex">\[
\text{DCG}= \sum_{i=1}^{k} \frac{ 2^{\text{rel}[i]}-1}{\log_{2}([i]+2)}
\]</div>
<div class="highlight"><pre><span></span><code><span class="c1"># </span>
<span class="n">sample_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">sample_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;y_true&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="c1"># </span>
<span class="n">sample_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;dcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">sample_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/var/folders/zt/dkkszv0n5bd8nq9dywcdj7pc0000gn/T/ipykernel_743/404199756.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sample_dcg.loc[:,&#39;gain&#39;] = 2 ** sample_dcg.loc[:,&#39;y_true&#39;] - 1
/var/folders/zt/dkkszv0n5bd8nq9dywcdj7pc0000gn/T/ipykernel_743/404199756.py:4: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sample_dcg.loc[:,&#39;dcg&#39;] = sample_dcg.loc[:,&#39;gain&#39;] / np.log2(sample_dcg.loc[:,&#39;rank&#39;] + 1)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dcg</span> <span class="o">=</span> <span class="n">sample_dcg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;dcg&#39;</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<span class="n">dcg</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dcg</th>
    </tr>
    <tr>
      <th>srch_id</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>587980</th>
      <td>10.333333</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="c1"># calculate ideal dcg , ideal sorting based on y_true </span>
<span class="n">ideal_dcg</span> <span class="o">=</span> <span class="n">sample_dcg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">ideal_dcg</span> <span class="o">=</span> <span class="n">sample_dcg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;y_true&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span>
                                                                   <span class="kc">True</span><span class="p">,</span><span class="kc">False</span>
                                                               <span class="p">])</span>
<span class="n">ideal_dcg</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ideal_dcg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">ideal_dcg</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prop_id</th>
      <th>srch_id</th>
      <th>pred_lambda</th>
      <th>y_true</th>
      <th>rank</th>
      <th>gain</th>
      <th>dcg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3453954</th>
      <td>109147</td>
      <td>587980</td>
      <td>-0.388572</td>
      <td>5</td>
      <td>1</td>
      <td>31</td>
      <td>10.333333</td>
    </tr>
    <tr>
      <th>3453941</th>
      <td>3904</td>
      <td>587980</td>
      <td>0.085224</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453951</th>
      <td>82171</td>
      <td>587980</td>
      <td>0.080693</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453948</th>
      <td>57499</td>
      <td>587980</td>
      <td>-0.161591</td>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453955</th>
      <td>131812</td>
      <td>587980</td>
      <td>-0.281207</td>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453953</th>
      <td>101045</td>
      <td>587980</td>
      <td>-0.313309</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453946</th>
      <td>33678</td>
      <td>587980</td>
      <td>-0.374939</td>
      <td>0</td>
      <td>7</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453947</th>
      <td>55787</td>
      <td>587980</td>
      <td>-0.388951</td>
      <td>0</td>
      <td>8</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453949</th>
      <td>68081</td>
      <td>587980</td>
      <td>-0.528888</td>
      <td>0</td>
      <td>9</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453950</th>
      <td>68414</td>
      <td>587980</td>
      <td>-0.581832</td>
      <td>0</td>
      <td>10</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453943</th>
      <td>10085</td>
      <td>587980</td>
      <td>-0.616705</td>
      <td>0</td>
      <td>11</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453944</th>
      <td>24104</td>
      <td>587980</td>
      <td>-0.616705</td>
      <td>0</td>
      <td>12</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453942</th>
      <td>3910</td>
      <td>587980</td>
      <td>-0.698352</td>
      <td>0</td>
      <td>13</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453952</th>
      <td>92278</td>
      <td>587980</td>
      <td>-0.813638</td>
      <td>0</td>
      <td>14</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3453945</th>
      <td>24966</td>
      <td>587980</td>
      <td>-0.872794</td>
      <td>0</td>
      <td>15</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="c1"># </span>
<span class="n">ideal_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">ideal_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;y_true&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="c1"># </span>
<span class="n">ideal_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;dcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ideal_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">ideal_dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ideal_dcg</span> <span class="o">=</span> <span class="n">ideal_dcg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;dcg&#39;</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dcg</span> <span class="o">/</span> <span class="n">ideal_dcg</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dcg</th>
    </tr>
    <tr>
      <th>srch_id</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>587980</th>
      <td>0.333333</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_dcg</span><span class="p">(</span><span class="n">prediction_result</span><span class="p">,</span>
                  <span class="n">target_col</span><span class="p">,</span>
                  <span class="n">sorting_col</span><span class="p">,</span>
                  <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span> <span class="p">:</span>
     <span class="n">dcg</span> <span class="o">=</span> <span class="n">prediction_result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

     <span class="c1"># order based on relevance score </span>
     <span class="n">dcg</span> <span class="o">=</span> <span class="n">dcg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
          <span class="p">[</span><span class="n">search_col</span><span class="p">,</span><span class="n">sorting_col</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">]</span>
     <span class="p">)</span>


     <span class="c1"># calculate ranking</span>
     <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">search_col</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>


     <span class="c1"># calculate gain </span>
     <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">dcg</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

     <span class="c1"># calculate dcg </span>
     <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;dcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

     <span class="c1"># sum </span>
     <span class="n">dcg</span> <span class="o">=</span> <span class="n">dcg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">search_col</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;dcg&#39;</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">})</span>

     <span class="k">return</span> <span class="n">dcg</span>
</code></pre></div>
<p>we usually calculate using Top N Position of ranking, not full item. </p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="p">,</span>
                  <span class="n">target_col</span><span class="p">,</span>
                  <span class="n">sorting_col</span><span class="p">,</span>
                  <span class="n">search_col</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
     <span class="n">dcg</span> <span class="o">=</span> <span class="n">prediction_result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

     <span class="c1"># order based on relevance score </span>
     <span class="n">dcg</span> <span class="o">=</span> <span class="n">dcg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
          <span class="p">[</span><span class="n">search_col</span><span class="p">,</span><span class="n">sorting_col</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">]</span>
     <span class="p">)</span>


     <span class="c1"># calculate ranking</span>
     <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">search_col</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

     <span class="c1"># filter only up to k </span>

     <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> 
          <span class="n">dcg</span> <span class="o">=</span> <span class="n">dcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
               <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">k</span>
          <span class="p">]</span>

     <span class="c1"># calculate gain </span>
     <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">dcg</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

     <span class="c1"># calculate dcg </span>
     <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;dcg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

     <span class="c1"># sum </span>
     <span class="n">dcg</span> <span class="o">=</span> <span class="n">dcg</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">search_col</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;dcg&#39;</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">})</span>

     <span class="k">return</span> <span class="n">dcg</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dcg_listwise</span> <span class="o">=</span> <span class="n">calculate_dcg</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">val_prediction_listwise</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span>
<span class="n">ideal_dcg_listwise</span> <span class="o">=</span> <span class="n">calculate_dcg</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">val_prediction_listwise</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">)</span>

<span class="n">ndcg</span> <span class="o">=</span> <span class="n">dcg_listwise</span> <span class="o">/</span> <span class="n">ideal_dcg_listwise</span>

<span class="n">ndcg</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>dcg    0.439791
dtype: float64
</code></pre></div>
<p>Top 5</p>
<div class="highlight"><pre><span></span><code><span class="n">dcg_listwise_top5</span> <span class="o">=</span> <span class="n">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">val_prediction_listwise</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ideal_dcg_listwise_top5</span> <span class="o">=</span> <span class="n">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">val_prediction_listwise</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">ndcg5</span> <span class="o">=</span> <span class="n">dcg_listwise_top5</span> <span class="o">/</span> <span class="n">ideal_dcg_listwise_top5</span>

<span class="n">ndcg5</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>dcg    0.289173
dtype: float64
</code></pre></div>
<p>Top 10 </p>
<div class="highlight"><pre><span></span><code><span class="n">dcg_listwise_top10</span> <span class="o">=</span> <span class="n">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">val_prediction_listwise</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ideal_dcg_listwise_top10</span> <span class="o">=</span> <span class="n">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">val_prediction_listwise</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ndcg10</span> <span class="o">=</span> <span class="n">dcg_listwise_top10</span> <span class="o">/</span> <span class="n">ideal_dcg_listwise_top10</span>

<span class="n">ndcg10</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>dcg    0.357547
dtype: float64
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dcg_listwise_top50</span> <span class="o">=</span> <span class="n">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">val_prediction_listwise</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ideal_dcg_listwise_top50</span> <span class="o">=</span> <span class="n">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">val_prediction_listwise</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">ndcg50</span> <span class="o">=</span> <span class="n">dcg_listwise_top50</span> <span class="o">/</span> <span class="n">ideal_dcg_listwise_top50</span>

<span class="n">ndcg50</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>dcg    0.439791
dtype: float64
</code></pre></div>
<p>We can see as number of Top N increase NDCG gets bigger. </p>
<p>Wrapping Up into a function  to calculate ndcg</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span><span class="p">,</span>
                         <span class="n">target_col</span><span class="p">,</span><span class="n">sorting_col</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span> 
    <span class="n">dcg</span> <span class="o">=</span> <span class="n">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">prediction_result</span><span class="p">,</span>
                             <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                             <span class="n">sorting_col</span><span class="o">=</span><span class="n">sorting_col</span><span class="p">,</span>
                             <span class="n">search_col</span><span class="o">=</span><span class="n">search_col</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
    <span class="n">ideal_dcg</span> <span class="o">=</span> <span class="n">calculate_dcg_topk</span><span class="p">(</span><span class="n">prediction_result</span><span class="o">=</span><span class="n">prediction_result</span><span class="p">,</span>
                                <span class="n">target_col</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
                                <span class="n">sorting_col</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
                                <span class="n">search_col</span><span class="o">=</span><span class="n">search_col</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="n">ndcg</span> <span class="o">=</span> <span class="n">dcg</span><span class="p">[</span><span class="s1">&#39;dcg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">ideal_dcg</span><span class="p">[</span><span class="s1">&#39;dcg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">ndcg</span>
</code></pre></div>
<p>Comparing Model Performance on Validation Set</p>
<p><strong>NDCG@5</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># pointwise </span>
<span class="n">pointwise_ndcg5</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_pointwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># pairwise</span>
<span class="n">pairwise_ndcg5</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_pairwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="c1"># listwise</span>
<span class="n">listwise_ndcg5</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_listwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">val_ndcg5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;NDCG@5&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="n">pointwise_ndcg5</span><span class="p">,</span><span class="n">pairwise_ndcg5</span><span class="p">,</span><span class="n">listwise_ndcg5</span><span class="p">]</span>
<span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pointwise&#39;</span><span class="p">,</span><span class="s1">&#39;pairwise&#39;</span><span class="p">,</span><span class="s1">&#39;listwise&#39;</span><span class="p">])</span>
<span class="n">val_ndcg5</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDCG@5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pointwise</th>
      <td>0.191748</td>
    </tr>
    <tr>
      <th>pairwise</th>
      <td>0.295687</td>
    </tr>
    <tr>
      <th>listwise</th>
      <td>0.289173</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>NDCG@10</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># pointwise </span>
<span class="n">pointwise_ndcg10</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_pointwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># pairwise</span>
<span class="n">pairwise_ndcg10</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_pairwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="c1"># listwise</span>
<span class="n">listwise_ndcg10</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_listwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">val_ndcg10</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;NDCG@10&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="n">pointwise_ndcg10</span><span class="p">,</span><span class="n">pairwise_ndcg10</span><span class="p">,</span><span class="n">listwise_ndcg10</span><span class="p">]</span>
<span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pointwise&#39;</span><span class="p">,</span><span class="s1">&#39;pairwise&#39;</span><span class="p">,</span><span class="s1">&#39;listwise&#39;</span><span class="p">])</span>
<span class="n">val_ndcg10</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDCG@10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pointwise</th>
      <td>0.261939</td>
    </tr>
    <tr>
      <th>pairwise</th>
      <td>0.364634</td>
    </tr>
    <tr>
      <th>listwise</th>
      <td>0.357547</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>NDCG@50</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># pointwise </span>
<span class="n">pointwise_ndcg50</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_pointwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># pairwise</span>
<span class="n">pairwise_ndcg50</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_pairwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="c1"># listwise</span>
<span class="n">listwise_ndcg50</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">val_prediction_listwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">val_ndcg50</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;NDCG@50&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="n">pointwise_ndcg50</span><span class="p">,</span><span class="n">pairwise_ndcg50</span><span class="p">,</span><span class="n">listwise_ndcg50</span><span class="p">]</span>
<span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pointwise&#39;</span><span class="p">,</span><span class="s1">&#39;pairwise&#39;</span><span class="p">,</span><span class="s1">&#39;listwise&#39;</span><span class="p">])</span>
<span class="n">val_ndcg50</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDCG@50</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pointwise</th>
      <td>0.372516</td>
    </tr>
    <tr>
      <th>pairwise</th>
      <td>0.445406</td>
    </tr>
    <tr>
      <th>listwise</th>
      <td>0.439791</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="n">val_ndcg</span> <span class="o">=</span> <span class="n">val_ndcg5</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val_ndcg10</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val_ndcg50</span><span class="p">)</span>
<span class="n">val_ndcg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;NDCG@10&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDCG@5</th>
      <th>NDCG@10</th>
      <th>NDCG@50</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pairwise</th>
      <td>0.295687</td>
      <td>0.364634</td>
      <td>0.445406</td>
    </tr>
    <tr>
      <th>listwise</th>
      <td>0.289173</td>
      <td>0.357547</td>
      <td>0.439791</td>
    </tr>
    <tr>
      <th>pointwise</th>
      <td>0.191748</td>
      <td>0.261939</td>
      <td>0.372516</td>
    </tr>
  </tbody>
</table>
</div>

<p>From the result above we can see that most of the NDCG measure pairwise models perform better by huge margin. </p>
<p>Next, we predict on the test set. </p>
<h4 id="test-set">Test Set<a class="headerlink" href="#test-set" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># set the positional features first </span>
<span class="n">X_test_relevance</span><span class="p">[</span><span class="s1">&#39;search_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/var/folders/zt/dkkszv0n5bd8nq9dywcdj7pc0000gn/T/ipykernel_743/1429340643.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  X_test_relevance[&#39;search_rank&#39;] = 1
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">test_prediction_pairwise</span> <span class="o">=</span> <span class="n">prepare_for_eval</span><span class="p">(</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">,</span>
                 <span class="n">model</span> <span class="o">=</span> <span class="n">ranker_pairwise</span><span class="p">,</span>
                 <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test_relevance</span><span class="p">[</span><span class="n">ALL_FEATURES</span><span class="p">],</span>
                 <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test_relevance</span><span class="p">,</span>
                 <span class="n">query_id</span> <span class="o">=</span> <span class="n">search_id_test</span><span class="p">,</span>
                 <span class="n">search_col</span><span class="o">=</span><span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                 <span class="n">prop_col</span> <span class="o">=</span> <span class="s1">&#39;prop_id&#39;</span><span class="p">)</span>

<span class="n">test_ndcg5</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">test_prediction_pairwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">test_ndcg10</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">test_prediction_pairwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_ndcg50</span> <span class="o">=</span> <span class="n">calculate_ndcg_ideal</span><span class="p">(</span><span class="n">prediction_result</span> <span class="o">=</span> <span class="n">test_prediction_pairwise</span> <span class="p">,</span>
                         <span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;y_true&#39;</span><span class="p">,</span>
                         <span class="n">sorting_col</span> <span class="o">=</span> <span class="s1">&#39;pred_lambda&#39;</span><span class="p">,</span>
                         <span class="n">search_col</span><span class="o">=</span> <span class="s1">&#39;srch_id&#39;</span><span class="p">,</span>
                         <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>


<span class="n">test_ndcg_pairwise</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;NDCG@5&#39;</span> <span class="p">:</span> <span class="n">test_ndcg5</span><span class="p">,</span>
    <span class="s1">&#39;NDCG@10&#39;</span> <span class="p">:</span> <span class="n">test_ndcg10</span><span class="p">,</span>
    <span class="s1">&#39;NDCG@50&#39;</span> <span class="p">:</span> <span class="n">test_ndcg50</span>
<span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pairwise in test set&#39;</span><span class="p">])</span>
<span class="n">test_ndcg_pairwise</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDCG@5</th>
      <th>NDCG@10</th>
      <th>NDCG@50</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pairwise in test set</th>
      <td>0.297005</td>
      <td>0.36653</td>
      <td>0.446281</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="n">val_ndcg_pairwise</span> <span class="o">=</span> <span class="n">val_ndcg</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> 
    <span class="n">val_ndcg</span><span class="o">.</span><span class="n">index</span><span class="o">==</span><span class="s1">&#39;pairwise&#39;</span>
<span class="p">]</span>
<span class="n">val_ndcg_pairwise</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDCG@5</th>
      <th>NDCG@10</th>
      <th>NDCG@50</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pairwise</th>
      <td>0.295687</td>
      <td>0.364634</td>
      <td>0.445406</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">val_ndcg_pairwise</span><span class="p">,</span>
    <span class="n">test_ndcg_pairwise</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
</code></pre></div>
<div style="overflow-x:scroll;">
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NDCG@5</th>
      <th>NDCG@10</th>
      <th>NDCG@50</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pairwise</th>
      <td>0.295687</td>
      <td>0.364634</td>
      <td>0.445406</td>
    </tr>
    <tr>
      <th>pairwise in test set</th>
      <td>0.297005</td>
      <td>0.366530</td>
      <td>0.446281</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="dump-model-artifact">Dump Model Artifact<a class="headerlink" href="#dump-model-artifact" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span> 


<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ranker_pairwise</span><span class="p">,</span><span class="s1">&#39;ltr_pairwise.pkl&#39;</span><span class="p">)</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ranker_listwise</span><span class="p">,</span><span class="s1">&#39;ltr_listwise.pkl&#39;</span><span class="p">)</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">rf_pointwise</span><span class="p">,</span><span class="s1">&#39;rf_pointwise.pkl&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[&#39;rf_pointwise.pkl&#39;]
</code></pre></div>
<h2 id="references">References :<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><a href="https://medium.com/expedia-group-tech/learning-to-rank-at-expedia-group-how-to-adapt-the-property-search-result-page-based-on-f4ebef78c94b">Expedia's Channel-Smart Property Search: How Expedia Tailors Rankings for You</a></p>
</li>
<li>
<p><a href="https://medium.com/airbnb-engineering/embedding-based-retrieval-for-airbnb-search-aabebfc85839">Embedding-Based Retrieval for Airbnb Search</a></p>
</li>
<li>
<p><a href="https://softwaredoug.com/blog/2024/05/22/flavors-of-ndcg">Doug TurnBull : Flavors of NDCG</a></p>
</li>
<li>
<p><a href="https://web.stanford.edu/class/cs276/">Stanford University CS 276 : Information Retrieval</a></p>
</li>
<li>
<p><a href="https://www.manning.com/books/ai-powered-search">AI Powered Search (Book)</a></p>
</li>
<li>
<p><a href="https://medium.com/airbnb-engineering/machine-learning-powered-search-ranking-of-airbnb-experiences-110b4b1a0789">Machine Learning Powered Search Ranking of AirBnB Experiences</a></p>
</li>
<li>
<p><a href="https://papers.nips.cc/paper_files/paper/2006/file/af44c4c56f385c43f2529f9b1b018f6a-Paper.pdf">Learning to Rank with Non-Smooth Cost Functions (Lambda Rank) </a></p>
</li>
<li>
<p><a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/MSR-TR-2010-82.pdf">From RankNet to LambdaRank to LambdaMART: An Overview</a></p>
</li>
<li>
<p><a href="https://eugeneyan.com/writing/system-design-for-discovery/">Eugene Yan's System Design for Recommendations and Search</a></p>
</li>
</ul>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/fakhrirobi/" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:fakhrirobi.fra@gmail.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../docs/javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../docs/javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>